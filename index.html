<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Meteo Avanzata</title>
    <style>
        :root {
            --primary-color: #00bcd4;
            --dark-bg: #121212;
            --medium-bg: #1e1e1e;
            --light-bg: #2c2c2c;
            --text-color: #e0e0e0;
            --text-muted: #999;
            --border-color: #333;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
        }
        .sidebar {
            width: 250px;
            background-color: var(--medium-bg);
            padding: 20px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .sidebar h2 {
            color: var(--primary-color);
            text-align: center;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }
        .sidebar ul li a {
            display: block;
            color: var(--text-color);
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .sidebar ul li a:hover, .sidebar ul li a.active {
            background-color: var(--primary-color);
            color: var(--dark-bg);
            font-weight: bold;
        }
        #main-content {
            margin-left: 270px; /* sidebar width + padding */
            padding: 20px;
            width: calc(100% - 290px);
        }
        .page-section { display: none; }
        .page-section.active { display: block; }
        h1, h2 {
            color: var(--primary-color);
            font-weight: 300;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: var(--medium-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Stili Filtri */
        .filter-container {
            background-color: var(--medium-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-container input, .filter-container button, .filter-container select {
            background-color: var(--light-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-color);
            padding: 8px;
            border-radius: 5px;
        }
        .filter-container button {
            cursor: pointer;
            font-weight: bold;
            background-color: var(--primary-color);
            color: var(--dark-bg);
        }
        .filter-container button:hover { background-color: #0097a7; }

        /* Stili Gruppi Dati */
        .data-groups-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; }
        .data-group { flex: 1; background-color: var(--medium-bg); padding: 15px; border-radius: 8px; min-width: 350px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .group-title { color: var(--primary-color); text-align: center; margin: 0 0 20px 0; font-weight: 400; font-size: 1.1em; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .stats-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        
        /* Stili Card Dati */
        .stat-card { background-color: var(--light-bg); padding: 12px 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); text-align: center; flex-grow: 1; min-width: 150px; }
        .stat-card .title { font-size: 0.8em; color: var(--text-muted); margin-bottom: 5px; }
        .stat-card .value { font-size: 1.5em; font-weight: bold; color: var(--primary-color); }
        .stat-card .unit { font-size: 0.7em; color: var(--primary-color); margin-left: 4px; }
        
        /* Stili Grafici e Tabelle */
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .chart-container { flex: 3; min-width: 600px; height: 500px; cursor: grab; }
        .chart-container:active { cursor: grabbing; }
        
        /* --- STILI GAUGE --- */
        .gauge-container {
            width: 280px;
            height: 180px;
            background-color: var(--light-bg);
            border-radius: 8px;
            position: relative;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .gauge-arc { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); width: 220px; height: 110px; border-top-left-radius: 110px; border-top-right-radius: 110px; border: 15px solid #444; border-bottom: 0; box-sizing: border-box; z-index: 1; }
        .gauge-needle, .gauge-gust-marker { position: absolute; bottom: 30px; left: 50%; width: 3px; height: 60px; background-color: var(--primary-color); transform-origin: bottom center; transition: transform 0.5s ease-out; z-index: 4; transform: translateX(-50%) rotate(-90deg); border-radius: 3px; }
        .gauge-gust-marker { background-color: #ffc107; height: 65px; opacity: 0.7; }
        .gauge-center-pivot { position: absolute; bottom: 22px; left: 50%; width: 15px; height: 15px; background: var(--dark-bg); border-radius: 50%; transform: translateX(-50%); z-index: 5; border: 2px solid var(--primary-color); }
        .gauge-speed-value { position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); font-size: 2.5em; font-weight: bold; color: #fff; }
        .gauge-speed-label { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 0.9em; color: var(--text-muted); }
        .gauge-min-max { position: absolute; bottom: 10px; width: 240px; left: 50%; transform: translateX(-50%); display: flex; justify-content: space-between; font-size: 0.8em; color: var(--text-muted); }
        .gauge-gust-box { position: absolute; top: 10px; left: 10px; background-color: #28a745; color: #fff; padding: 5px 10px; border-radius: 5px; font-weight: bold; }
        .gauge-gust-box .value { font-size: 1.2em; }
        .gauge-gust-box .title { font-size: 0.7em; display: block; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
    <nav class="sidebar">
        <h2>Dashboard Meteo</h2>
        <ul>
            <li><a href="#previsioni" class="nav-link active">Previsioni Idro</a></li>
            <li><a href="#idrometri" class="nav-link">Idrometri</a></li>
            <li><a href="#pluviometri" class="nav-link">Pluviometri</a></li>
            <li><a href="#anemometri" class="nav-link">Anemometri</a></li>
        </ul>
    </nav>
    <main id="main-content">
        <section id="previsioni" class="page-section active">
             <h1>Sezione Previsioni non implementata in questa versione</h1>
        </section>

        <section id="idrometri" class="page-section">
            <h2>Idrometri - Dati in Tempo Reale e Storici</h2>
            <div class="data-groups-container">
                <div class="data-group">
                    <h3 class="group-title">Livelli Idrometrici Attuali</h3>
                    <div class="stats-container">
                        <div class="stat-card" id="hydro-misa-bettolelle"><div class="title">Misa (Bettolelle)</div><div class="value">--<span class="unit">m</span></div></div>
                        <div class="stat-card" id="hydro-pianello-ostra"><div class="title">Misa (Pianello Ostra)</div><div class="value">--<span class="unit">m</span></div></div>
                        <div class="stat-card" id="hydro-ponte-garibaldi"><div class="title">Misa (P. Garibaldi)</div><div class="value">--<span class="unit">m</span></div></div>
                        <div class="stat-card" id="hydro-serra-dei-conti"><div class="title">Misa (Serra dei Conti)</div><div class="value">--<span class="unit">m</span></div></div>
                        <div class="stat-card" id="hydro-cesano"><div class="title">Cesano</div><div class="value">--<span class="unit">m</span></div></div>
                    </div>
                </div>
            </div>
            <div class="filter-container">
                <label for="start-time-hydro">Da:</label><input type="datetime-local" id="start-time-hydro">
                <label for="end-time-hydro">A:</label><input type="datetime-local" id="end-time-hydro">
                <button id="filter-hydro">Filtra</button>
            </div>
            <div class="chart-container card">
                <canvas id="hydroHistoryChart"></canvas>
            </div>
        </section>

        <section id="pluviometri" class="page-section">
            <h2>Pluviometri - Dati in Tempo Reale e Storici</h2>
             <div class="data-groups-container">
                <div class="data-group">
                    <h3 class="group-title">Intensità Pioggia Attuale</h3>
                    <div class="stats-container">
                        <div class="stat-card" id="rain-arcevia"><div class="title">Arcevia (Intensità)</div><div class="value">--<span class="unit">mm/hr</span></div></div>
                        <div class="stat-card" id="rain-barbara"><div class="title">Barbara (Intensità)</div><div class="value">--<span class="unit">mm/hr</span></div></div>
                        <div class="stat-card" id="rain-corinaldo"><div class="title">Corinaldo (Intensità)</div><div class="value">--<span class="unit">mm/hr</span></div></div>
                        <div class="stat-card" id="rain-misa"><div class="title">Misa (Intensità)</div><div class="value">--<span class="unit">mm/hr</span></div></div>
                        <div class="stat-card" id="rain-montignano"><div class="title">Montignano (Intensità)</div><div class="value">--<span class="unit">mm/hr</span></div></div>
                        <div class="stat-card" id="rain-santangelo"><div class="title">S.Angelo (Intensità)</div><div class="value">--<span class="unit">mm/hr</span></div></div>
                        <div class="stat-card" id="rain-scapezzano"><div class="title">Scapezzano (Intensità)</div><div class="value">--<span class="unit">mm/hr</span></div></div>
                    </div>
                </div>
            </div>
            <div class="filter-container">
                 <label for="start-time-rain">Da:</label><input type="datetime-local" id="start-time-rain">
                 <label for="end-time-rain">A:</label><input type="datetime-local" id="end-time-rain">
                 <button id="filter-rain">Filtra</button>
                 <div id="station-selection-rain" style="margin-top: 10px; border-left: 2px solid var(--primary-color); padding-left: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                     <label><input type="checkbox" name="station-rain" value="Arcevia - Pioggia TOT Oggi (mm)" checked> Arcevia</label>
                     <label><input type="checkbox" name="station-rain" value="Barbara - Pioggia TOT Oggi (mm)" checked> Barbara</label>
                     <label><input type="checkbox" name="station-rain" value="Corinaldo - Pioggia TOT Oggi (mm)" checked> Corinaldo</label>
                     <label><input type="checkbox" name="station-rain" value="Misa - Pioggia TOT Oggi (mm)" checked> Misa (Bettolelle)</label>
                     <label><input type="checkbox" name="station-rain" value="Montignano - Pioggia Giornaliera (mm)" checked> Montignano</label>
                     <label><input type="checkbox" name="station-rain" value="Sant'Angelo - Pioggia Giornaliera (mm)" checked> Sant'Angelo</label>
                     <label><input type="checkbox" name="station-rain" value="Scapezzano - Pioggia Giornaliera (mm)" checked> Scapezzano</label>
                 </div>
            </div>
            <div class="chart-container card">
                <canvas id="rainHistoryChart"></canvas>
            </div>
        </section>
        
        <section id="anemometri" class="page-section">
            <h2>Anemometri - Stazioni Weatherlink</h2>
            <div class="data-groups-container">
                <div class="gauge-container"><div class="gauge-gust-box"><span class="title">Raffica Montignano</span><span class="value" id="gust-value-montignano">--</span></div><div class="gauge-arc"></div><div class="gauge-needle" id="gauge-needle-montignano"></div><div class="gauge-gust-marker" id="gauge-gust-marker-montignano"></div><div class="gauge-center-pivot"></div><div class="gauge-speed-value" id="speed-value-montignano">--</div><div class="gauge-speed-label">Velocità Vento (km/h)</div><div class="gauge-min-max"><span>0</span><span>80</span></div></div>
                <div class="gauge-container"><div class="gauge-gust-box"><span class="title">Raffica Sant'Angelo</span><span class="value" id="gust-value-santangelo">--</span></div><div class="gauge-arc"></div><div class="gauge-needle" id="gauge-needle-santangelo"></div><div class="gauge-gust-marker" id="gauge-gust-marker-santangelo"></div><div class="gauge-center-pivot"></div><div class="gauge-speed-value" id="speed-value-santangelo">--</div><div class="gauge-speed-label">Velocità Vento (km/h)</div><div class="gauge-min-max"><span>0</span><span>80</span></div></div>
                <div class="gauge-container"><div class="gauge-gust-box"><span class="title">Raffica Scapezzano</span><span class="value" id="gust-value-scapezzano">--</span></div><div class="gauge-arc"></div><div class="gauge-needle" id="gauge-needle-scapezzano"></div><div class="gauge-gust-marker" id="gauge-gust-marker-scapezzano"></div><div class="gauge-center-pivot"></div><div class="gauge-speed-value" id="speed-value-scapezzano">--</div><div class="gauge-speed-label">Velocità Vento (km/h)</div><div class="gauge-min-max"><span>0</span><span>80</span></div></div>
            </div>
            <div class="filter-container">
                <label for="start-time-wind">Da:</label><input type="datetime-local" id="start-time-wind">
                <label for="end-time-wind">A:</label><input type="datetime-local" id="end-time-wind">
                <button id="filter-wind">Filtra</button>
                <select id="station-selection-wind" style="margin-left: 10px;"><option value="Montignano" selected>Montignano</option><option value="Sant'Angelo">Sant'Angelo</option><option value="Scapezzano">Scapezzano</option></select>
            </div>
            <div class="chart-container card">
                <canvas id="windHistoryChart"></canvas>
            </div>
        </section>
    </main>

    <script>
        // --- URLS ---
        const regionLatestUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=1216509518&single=true&output=csv';
        const weatherlinkLatestUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=377471478&single=true&output=csv';
        const regionHistoryUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=1332614523&single=true&output=csv';
        const weatherlinkHistoryUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=277108921&single=true&output=csv';
        
        // --- CONFIG ---
        const DEFAULT_TIME_WINDOW_HOURS = 6;
        const GAUGE_MAX_SPEED = 80;
        const CHART_COLORS = ['#00bcd4', '#ffc107', '#9c27b0', '#f44336', '#4caf50', '#ff9800', '#3f51b5', '#e91e63'];
        
        // --- GLOBAL VARS ---
        let regionHistoryData = [], weatherlinkHistoryData = [];
        let hydroHistoryChart, rainHistoryChart, windHistoryChart;

        // --- UTILITY FUNCTIONS ---
        function parseAndFixDecimal(value) {
            if (value === null || value === undefined || value === 'N/A' || String(value).trim() === '') return NaN;
            return parseFloat(String(value).replace(',', '.'));
        }

        function parseCustomDate(dateString) {
            if (!dateString) return null;
            const formatted = dateString.replace(/(\d{2})\.(\d{2})$/, '$1:$2').replace(/(\d{1,2})\:(\d{2})$/, '$1:$2');
            const parts = formatted.split(/[\s/:]+/);
            if (parts.length < 5) return null;
            const [d, m, y, h, min] = parts;
            const date = new Date(y, m - 1, d, h, min, parts[5] || 0);
            if (isNaN(date.getTime())) { console.warn(`Data non valida: "${dateString}"`); return null; }
            return date;
        }
        
        function filterDataByTime(data, timeColumn, start, end) {
            const startTime = start ? new Date(start).getTime() : null;
            const endTime = end ? new Date(end).getTime() : null;
            if (!startTime && !endTime) {
                const now = new Date();
                const defaultStart = now.getTime() - DEFAULT_TIME_WINDOW_HOURS * 3600000;
                return data.filter(r => { const d = parseCustomDate(r[timeColumn]); return d ? d.getTime() >= defaultStart : false; });
            }
            return data.filter(r => {
                const d = parseCustomDate(r[timeColumn]);
                if (!d) return false;
                const t = d.getTime();
                if (startTime && t < startTime) return false;
                if (endTime && t > endTime) return false;
                return true;
            });
        }
        
        // --- UI UPDATE FUNCTIONS ---
        function updateStatCard(cardId, value, unit, fallback = '--') {
            const card = document.getElementById(cardId);
            if (!card) return;
            const valueEl = card.querySelector('.value');
            let finalValue = fallback;
            const numValue = parseAndFixDecimal(value);
            if (!isNaN(numValue)) { finalValue = numValue.toFixed(2); }
            const unitEl = valueEl.querySelector('.unit');
            if (unitEl) {
                unitEl.textContent = unit;
                valueEl.firstChild.nodeValue = finalValue;
            }
        }

        function updateGauge(station, speed, gust) {
            const cleanSpeed = parseAndFixDecimal(speed) || 0;
            const cleanGust = parseAndFixDecimal(gust) || 0;
            document.getElementById(`speed-value-${station}`).textContent = cleanSpeed.toFixed(1);
            document.getElementById(`gust-value-${station}`).textContent = cleanGust.toFixed(1);
            const speedRotation = (Math.min(cleanSpeed, GAUGE_MAX_SPEED) / GAUGE_MAX_SPEED) * 180 - 90;
            const gustRotation = (Math.min(cleanGust, GAUGE_MAX_SPEED) / GAUGE_MAX_SPEED) * 180 - 90;
            document.getElementById(`gauge-needle-${station}`).style.transform = `translateX(-50%) rotate(${speedRotation}deg)`;
            document.getElementById(`gauge-gust-marker-${station}`).style.transform = `translateX(-50%) rotate(${gustRotation}deg)`;
        }

        // --- DATA FETCH & CARD UPDATES ---
        function updateAllLatestData() {
            Papa.parse(`${regionLatestUrl}&t=${Date.now()}`, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    if (!results.data || !results.data.length) return;
                    const d = results.data[0];
                    updateStatCard('hydro-misa-bettolelle', d['Misa - Livello Misa (mt)'], 'm');
                    updateStatCard('hydro-pianello-ostra', d['Pianello di Ostra - Livello Misa (m)'], 'm');
                    updateStatCard('hydro-ponte-garibaldi', d['Ponte Garibaldi - Livello Misa 2 (mt)'], 'm');
                    updateStatCard('hydro-serra-dei-conti', d['Serra dei Conti - Livello Misa (mt)'], 'm');
                    updateStatCard('hydro-cesano', d['Cesano - Livello Cesano (mt)'], 'm');
                    
                    // CORRETTO: Funzione helper per convertire mm/min in mm/hr
                    const convertToHourRate = (rawValue) => {
                        const intensityMin = parseAndFixDecimal(rawValue);
                        if (!isNaN(intensityMin)) {
                            return intensityMin * 60;
                        }
                        return NaN; // Restituisce NaN se il valore non è valido
                    };

                    // CORRETTO: Nomi esatti delle colonne e conversione in mm/hr
                    updateStatCard('rain-arcevia', convertToHourRate(d['Arcevia - Intensita di pioggia (mm/min)']), 'mm/hr');
                    updateStatCard('rain-barbara', convertToHourRate(d['Barbara - Intensita di pioggia (mm/min)']), 'mm/hr');
                    updateStatCard('rain-corinaldo', convertToHourRate(d['Corinaldo - Intensita di pioggia (mm/min)']), 'mm/hr');
                    updateStatCard('rain-misa', convertToHourRate(d['Misa - Intensita Pioggia (mm/min)']), 'mm/hr');
                }
            });

            Papa.parse(`${weatherlinkLatestUrl}&t=${Date.now()}`, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    if (!results.data || !results.data.length) return;
                    const d = results.data[0];
                    updateGauge('montignano', d['Montignano - Velocità Vento (km/h)'], d['Montignano - Raffica Vento 10 min (km/h)']);
                    updateGauge('santangelo', d["Sant'Angelo - Velocità Vento (km/h)"], d["Sant'Angelo - Raffica Vento 10 min (km/h)"]);
                    updateGauge('scapezzano', d['Scapezzano - Velocità Vento (km/h)'], d['Scapezzano - Raffica Vento 10 min (km/h)']);
                    updateStatCard('rain-montignano', d['Montignano - Intensità Pioggia (mm/hr)'], 'mm/hr');
                    updateStatCard('rain-santangelo', d["Sant'Angelo - Intensità Pioggia (mm/hr)"], 'mm/hr');
                    updateStatCard('rain-scapezzano', d['Scapezzano - Intensità Pioggia (mm/hr)'], 'mm/hr');
                }
            });
        }

        // --- CHART DRAWING FUNCTIONS ---
        function drawChart(canvasId, existingChart, chartConfig) {
            if (existingChart) existingChart.destroy();
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, chartConfig);
        }

        function drawHydroHistoryChart() {
            const filteredData = filterDataByTime(regionHistoryData, 'Data_Ora', document.getElementById('start-time-hydro').value, document.getElementById('end-time-hydro').value);
            const labels = filteredData.map(r => r['Data_Ora']);
            const datasets = [
                { col: 'Misa - Livello Misa (mt)', lbl: 'Misa (Bettolelle)' }, { col: 'Pianello di Ostra - Livello Misa (m)', lbl: 'Misa (Pianello Ostra)' },
                { col: 'Ponte Garibaldi - Livello Misa 2 (mt)', lbl: 'Misa (P. Garibaldi)' }, { col: 'Serra dei Conti - Livello Misa (mt)', lbl: 'Misa (Serra dei Conti)' },
                { col: 'Cesano - Livello Cesano (mt)', lbl: 'Cesano' },
            ].map((s, i) => ({ label: s.lbl, data: filteredData.map(r => parseAndFixDecimal(r[s.col])), borderColor: CHART_COLORS[i], fill: false, tension: 0.4, pointRadius: 0, spanGaps: true }));
            hydroHistoryChart = drawChart('hydroHistoryChart', hydroHistoryChart, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Andamento Storico Idrometri' } } } });
        }
        
        function drawRainHistoryChart() {
            const filteredRegion = filterDataByTime(regionHistoryData, 'Data_Ora', document.getElementById('start-time-rain').value, document.getElementById('end-time-rain').value);
            const filteredWeather = filterDataByTime(weatherlinkHistoryData, 'Data_Ora', document.getElementById('start-time-rain').value, document.getElementById('end-time-rain').value);
            const selected = Array.from(document.querySelectorAll('#station-selection-rain input:checked')).map(i => i.value);
            const labels = [...new Set([...filteredRegion.map(r => r.Data_Ora), ...filteredWeather.map(r => r.Data_Ora)])].sort((a, b) => parseCustomDate(a) - parseCustomDate(b));
            const mapRegion = new Map(filteredRegion.map(r => [r.Data_Ora, r]));
            const mapWeather = new Map(filteredWeather.map(r => [r.Data_Ora, r]));
            const datasets = selected.map((col, i) => {
                const name = col.split(' - ')[0];
                const isWeatherlink = ['Montignano', 'Sant\'Angelo', 'Scapezzano'].includes(name);
                const sourceMap = isWeatherlink ? mapWeather : mapRegion;
                return { label: name, data: labels.map(l => { const row = sourceMap.get(l); return row ? parseAndFixDecimal(row[col]) : null; }), borderColor: CHART_COLORS[i], fill: false, tension: 0.3, pointRadius: 1, spanGaps: true };
            });
            rainHistoryChart = drawChart('rainHistoryChart', rainHistoryChart, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Andamento Storico Pioggia Cumulata' } }, scales: { y: { beginAtZero: true } } } });
        }
        
        function drawWindHistoryChart() {
            const filteredData = filterDataByTime(weatherlinkHistoryData, 'Data_Ora', document.getElementById('start-time-wind').value, document.getElementById('end-time-wind').value);
            const station = document.getElementById('station-selection-wind').value;
            const labels = filteredData.map(r => r['Data_Ora']);
            const datasets = [
                { label: `Velocità (${station})`, data: filteredData.map(r => parseAndFixDecimal(r[`${station} - Velocità Vento (km/h)`])), borderColor: CHART_COLORS[0], fill: false, tension: 0.4, pointRadius: 0, spanGaps: true },
                { label: `Raffica (${station})`, data: filteredData.map(r => parseAndFixDecimal(r[`${station} - Raffica Vento 10 min (km/h)`])), borderColor: CHART_COLORS[1], borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, spanGaps: true }
            ];
            windHistoryChart = drawChart('windHistoryChart', windHistoryChart, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Andamento Storico Vento' } } } });
        }

        // --- NAVIGATION & INITIALIZATION ---
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link, .page-section').forEach(el => el.classList.remove('active'));
                this.classList.add('active');
                const targetId = this.getAttribute('href');
                document.querySelector(targetId).classList.add('active');
                switch(targetId) {
                    case '#idrometri': if(regionHistoryData.length) drawHydroHistoryChart(); break;
                    case '#pluviometri': if(regionHistoryData.length && weatherlinkHistoryData.length) drawRainHistoryChart(); break;
                    case '#anemometri': if(weatherlinkHistoryData.length) drawWindHistoryChart(); break;
                }
            });
        });

        function initializeDashboard() {
            let loaded = 0;
            const onDataLoaded = () => {
                loaded++;
                if (loaded < 2) return;
                const activeId = document.querySelector('.page-section.active')?.id;
                if (activeId === 'idrometri') drawHydroHistoryChart();
                else if (activeId === 'pluviometri') drawRainHistoryChart();
                else if (activeId === 'anemometri') drawWindHistoryChart();
            };
            Papa.parse(regionHistoryUrl, { download: true, header: true, skipEmptyLines: true, complete: r => { regionHistoryData = r.data.filter(row => row && row.Data_Ora); onDataLoaded(); } });
            Papa.parse(weatherlinkHistoryUrl, { download: true, header: true, skipEmptyLines: true, complete: r => { weatherlinkHistoryData = r.data.filter(row => row && row.Data_Ora); onDataLoaded(); } });
        }

        // --- EVENT LISTENERS ---
        document.getElementById('filter-hydro').addEventListener('click', drawHydroHistoryChart);
        document.getElementById('filter-rain').addEventListener('click', drawRainHistoryChart);
        document.getElementById('filter-wind').addEventListener('click', drawWindHistoryChart);
        document.getElementById('station-selection-wind').addEventListener('change', drawWindHistoryChart);
        document.querySelectorAll('#station-selection-rain input').forEach(el => el.addEventListener('change', drawRainHistoryChart));

        // --- START APP ---
        document.addEventListener('DOMContentLoaded', () => {
            updateAllLatestData();
            initializeDashboard();
            setInterval(updateAllLatestData, 60000); 
        });
    </script>
</body>
</html>
