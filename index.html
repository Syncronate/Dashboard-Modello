<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Idrometrica e Dati Real-Time</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #00bcd4;
            font-weight: 300;
            margin-bottom: 15px;
        }
        .toggle-btn {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #00bcd4;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background-color 0.3s;
        }
        .toggle-btn:hover {
            background-color: #0097a7;
        }
        .instructions {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out, margin-top 0.5s ease-out;
            margin-top: 0;
        }
        .instructions.visible {
            max-height: 200px;
            opacity: 1;
            margin-top: 10px;
        }
        .subtitle {
            color: #999;
            font-size: 0.9em;
            margin-top: 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        #resetZoomBtn {
            background-color: #00bcd4;
            color: #121212;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        #resetZoomBtn:hover {
            background-color: #0097a7;
        }
        
        /* Stili per i gruppi di dati */
        .data-groups-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        .data-group {
            flex: 1;
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            min-width: 350px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .group-title {
            color: #00bcd4;
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 400;
            font-size: 1.1em;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        /* Stili per i box dei dati */
        .stat-card {
            background-color: #2c2c2c;
            padding: 12px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
            flex-grow: 1;
            min-width: 150px;
        }
        .stat-card .title {
            font-size: 0.8em;
            color: #999;
            margin-bottom: 5px;
        }
        .stat-card .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00bcd4;
        }
        .stat-card .unit {
            font-size: 0.7em;
            color: #00bcd4;
            margin-left: 4px;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .chart-container { flex: 3; min-width: 600px; height: 500px; cursor: grab; }
        .chart-container:active { cursor: grabbing; }
        .table-container { flex: 1; min-width: 300px; max-height: 540px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #333; text-align: left; }
        thead th { background-color: #00bcd4; color: #121212; position: sticky; top: 0; }
        tbody tr { background-color: #2c2c2c; transition: background-color 0.2s, transform 0.2s; cursor: pointer; }
        tbody tr:nth-child(even) { background-color: #1e1e1e; }
        tbody tr:hover { background-color: #00bcd4 !important; color: #121212; transform: scale(1.02); }
        tbody tr.highlighted { background-color: #00bcd4 !important; color: #121212; font-weight: bold; }
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #2c2c2c; }
        .table-container::-webkit-scrollbar-thumb { background-color: #00bcd4; border-radius: 10px; border: 2px solid #2c2c2c; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>

    <div class="header">
        <h1>Dashboard Idrometrica e Dati Real-Time</h1>
        <button id="toggle-instructions-btn" class="toggle-btn">Mostra Istruzioni</button>
        <div id="instructions-container" class="instructions">
            <p class="subtitle">
                <b>Sposta:</b> Trascina il grafico con il mouse.<br/>
                <b>Zoom:</b> Usa la rotellina del mouse.<br/>
                <b>Zoom a selezione:</b> Tieni premuto 'Ctrl' e disegna un'area.<br/>
                <b>Interazione:</b> Passa il mouse sulla tabella per evidenziare i punti.
            </p>
            <button id="resetZoomBtn">Reset Zoom Grafico</button>
        </div>
    </div>

    <!-- SEZIONE DATI PUNTUALI DIVISA IN GRUPPI -->
    <div class="data-groups-container">
        <!-- Colonna Dati Idrometrici -->
        <div class="data-group">
            <h3 class="group-title">Dati Idrometrici</h3>
            <div class="stats-container">
                <div class="stat-card" id="misa-livello"><div class="title">Misa (Bettolelle)</div><div class="value">--<span class="unit">m</span></div></div>
                <div class="stat-card" id="misa-pianello"><div class="title">Misa (Pianello Ostra)</div><div class="value">--<span class="unit">m</span></div></div>
                <div class="stat-card" id="misa-ponte-garibaldi"><div class="title">Misa (Ponte Garibaldi)</div><div class="value">--<span class="unit">m</span></div></div>
                <div class="stat-card" id="cesano-livello"><div class="title">Cesano</div><div class="value">--<span class="unit">m</span></div></div>
                <div class="stat-card" id="cesano-foce"><div class="title">Foce Cesano</div><div class="value">--<span class="unit">m</span></div></div>
            </div>
        </div>
        <!-- Colonna Dati Pioggia -->
        <div class="data-group">
            <h3 class="group-title">Dati Pioggia</h3>
            <div class="stats-container">
                <!-- Arcevia -->
                <div class="stat-card" id="arcevia-pioggia-tot"><div class="title">Pioggia Oggi (Arcevia)</div><div class="value">--<span class="unit">mm</span></div></div>
                <div class="stat-card" id="arcevia-pioggia-int"><div class="title">Intensità (Arcevia)</div><div class="value">--<span class="unit">mm/min</span></div></div>
                <!-- Barbara -->
                <div class="stat-card" id="barbara-pioggia-tot"><div class="title">Pioggia Oggi (Barbara)</div><div class="value">--<span class="unit">mm</span></div></div>
                <div class="stat-card" id="barbara-pioggia-int"><div class="title">Intensità (Barbara)</div><div class="value">--<span class="unit">mm/min</span></div></div>
                <!-- Bettolelle -->
                <div class="stat-card" id="bettolelle-pioggia-tot"><div class="title">Pioggia Oggi (Bettolelle)</div><div class="value">--<span class="unit">mm</span></div></div>
                <div class="stat-card" id="bettolelle-pioggia-int"><div class="title">Intensità (Bettolelle)</div><div class="value">--<span class="unit">mm/min</span></div></div>
                <!-- Corinaldo -->
                <div class="stat-card" id="corinaldo-pioggia-tot"><div class="title">Pioggia Oggi (Corinaldo)</div><div class="value">--<span class="unit">mm</span></div></div>
                <div class="stat-card" id="corinaldo-pioggia-int"><div class="title">Intensità (Corinaldo)</div><div class="value">--<span class="unit">mm/min</span></div></div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="chart-container card"><canvas id="myChart"></canvas></div>
        <div class="table-container card">
            <table id="dataTable">
                <thead><tr><th>Timestamp</th><th>Q10 (m)</th><th>Q50 (m)</th><th>Q90 (m)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const forecastCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=752084732&single=true&output=csv';
        const realTimeCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=1216509518&single=true&output=csv';
        
        let myChart;
        let currentHighlightedIndex = -1;
        
        function updateStatCard(cardId, value, unit, fallback = '--') {
            const card = document.getElementById(cardId);
            if (!card) return;
            const valueEl = card.querySelector('.value');
            let finalValue = fallback;
            if (value !== undefined && value !== null && String(value).trim() !== '' && String(value).trim().toLowerCase() !== 'n/a') {
                const numValue = parseFloat(String(value).replace(',', '.'));
                if (!isNaN(numValue)) {
                    finalValue = numValue.toFixed(2);
                }
            }
            valueEl.innerHTML = `${finalValue}<span class="unit">${unit}</span>`;
        }

        function fetchRealTimeData() {
            const cacheBusterUrl = realTimeCsvUrl + '&t=' + new Date().getTime();
            Papa.parse(cacheBusterUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data || results.data.length === 0) {
                        console.error("Dati real-time non disponibili o vuoti.");
                        return;
                    }
                    const latestData = results.data[0];
                    
                    // Dati Idrometrici
                    updateStatCard('misa-livello', latestData['Misa - Livello Misa (mt)'], 'm');
                    updateStatCard('misa-pianello', latestData['Pianello di Ostra - Livello Misa (mt)'], 'm');
                    updateStatCard('misa-ponte-garibaldi', latestData['Ponte Garibaldi - Livello Misa 2 (mt)'], 'm');
                    updateStatCard('cesano-livello', latestData['Cesano - Livello Cesano (mt)'], 'm');
                    updateStatCard('cesano-foce', latestData['Foce Cesano - Livello Cesano (mt)'], 'm');
                    
                    // Dati Pioggia
                    updateStatCard('arcevia-pioggia-tot', latestData['Arcevia - Pioggia TOT Oggi (mm)'], 'mm');
                    updateStatCard('arcevia-pioggia-int', latestData['Arcevia - Intensita di pioggia (mm/min)'], 'mm/min');
                    updateStatCard('barbara-pioggia-tot', latestData['Barbara - Pioggia TOT Oggi (mm)'], 'mm');
                    updateStatCard('barbara-pioggia-int', latestData['Barbara - Intensita di pioggia (mm/min)'], 'mm/min');
                    updateStatCard('bettolelle-pioggia-tot', latestData['Misa - Pioggia TOT Oggi (mm)'], 'mm');
                    updateStatCard('bettolelle-pioggia-int', latestData['Misa - Intensita Pioggia (mm/min)'], 'mm/min');
                    updateStatCard('corinaldo-pioggia-tot', latestData['Corinaldo - Pioggia TOT Oggi (mm)'], 'mm');
                    updateStatCard('corinaldo-pioggia-int', latestData['Corinaldo - Intensita di pioggia (mm/min)'], 'mm/min');
                },
                error: function(err) {
                    console.error("Errore nel caricamento dei dati real-time:", err);
                    document.querySelectorAll('.stat-card .value').forEach(el => el.innerHTML = 'Errore');
                }
            });
        }

        const highlightPlugin = {
            id: 'highlightPlugin',
            afterDraw: (chart) => {
                if (currentHighlightedIndex === -1) return;
                const ctx = chart.ctx;
                const meta = chart.getDatasetMeta(0);
                if (currentHighlightedIndex >= meta.data.length) return;

                const point = meta.data[currentHighlightedIndex];
                ctx.save();
                ctx.beginPath();
                ctx.strokeStyle = '#00bcd4';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(point.x, chart.chartArea.top);
                ctx.lineTo(point.x, chart.chartArea.bottom);
                ctx.stroke();
                ctx.restore();

                chart.data.datasets.forEach((dataset, i) => {
                    const datasetMeta = chart.getDatasetMeta(i);
                    const pointAtIndex = datasetMeta.data[currentHighlightedIndex];
                    
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(pointAtIndex.x, pointAtIndex.y, 7, 0, 2 * Math.PI);
                    ctx.fillStyle = '#00bcd4';
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.restore();
                });
            }
        };

        function fetchDataAndDrawChart() {
            const cacheBusterUrl = forecastCsvUrl + '&t=' + new Date().getTime();
            Papa.parse(cacheBusterUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    const labels = data.map(row => row['Timestamp Previsione']);
                    const parseAndFixDecimal = (value) => (typeof value === 'string') ? parseFloat(value.replace(',', '.')) : value;
                    const q10 = data.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q10)']));
                    const q50 = data.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)']));
                    const q90 = data.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)']));
                    updateTable(data);
                    drawChart(labels, q10, q50, q90);
                },
                error: function(err) {
                    console.error("Errore nel caricamento dei dati di previsione:", err);
                }
            });
        }

        function updateTable(data) {
            const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            data.forEach((row, index) => {
                let tr = tableBody.insertRow();
                tr.dataset.index = index;
                tr.insertCell().textContent = row['Timestamp Previsione'];
                tr.insertCell().textContent = row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q10)'];
                tr.insertCell().textContent = row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)'];
                tr.insertCell().textContent = row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)'];
                
                tr.addEventListener('mouseenter', () => {
                    currentHighlightedIndex = index;
                    document.querySelectorAll('#dataTable tbody tr').forEach(r => r.classList.remove('highlighted'));
                    tr.classList.add('highlighted');
                    if (myChart) myChart.update('none');
                });
                tr.addEventListener('mouseleave', () => {
                    currentHighlightedIndex = -1;
                    tr.classList.remove('highlighted');
                    if (myChart) myChart.update('none');
                });
            });
        }

        function drawChart(labels, q10, q50, q90) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Q10', data: q10, borderColor: 'rgba(255, 159, 64, 1)', borderDash: [5, 5], borderWidth: 2, fill: false, pointRadius: 0, tension: 0.4 },
                        { label: 'Q90', data: q90, borderColor: 'rgba(255, 159, 64, 1)', backgroundColor: 'rgba(255, 159, 64, 0.2)', borderDash: [5, 5], borderWidth: 2, fill: '-1', pointRadius: 0, tension: 0.4 },
                        { label: 'Q50 (Mediana)', data: q50, borderColor: 'rgba(255, 205, 86, 1)', borderWidth: 3, fill: false, pointRadius: 0, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Previsione Livello Idrometrico - Sensore 1112 (Bettolelle)', color: '#e0e0e0', font: { size: 16 } },
                        legend: { labels: { color: '#e0e0e0' } },
                        zoom: {
                            pan: { enabled: true, mode: 'x', modifierKey: null },
                            zoom: { wheel: { enabled: true }, drag: { enabled: true, modifierKey: 'ctrl' }, pinch: { enabled: true }, mode: 'x' }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#999' }, grid: { color: '#444' } },
                        y: { ticks: { color: '#999' }, grid: { color: '#444' }, title: { display: true, text: 'Livello Idrometrico (m)', color: '#e0e0e0' } }
                    }
                },
                plugins: [highlightPlugin]
            });
        }

        document.getElementById('resetZoomBtn').addEventListener('click', () => {
            if (myChart) myChart.resetZoom();
        });

        document.getElementById('toggle-instructions-btn').addEventListener('click', function() {
            const instructionsDiv = document.getElementById('instructions-container');
            const isVisible = instructionsDiv.classList.toggle('visible');
            this.textContent = isVisible ? 'Nascondi Istruzioni' : 'Mostra Istruzioni';
        });

        fetchDataAndDrawChart();
        fetchRealTimeData();
        
        setInterval(fetchDataAndDrawChart, 300000);
        setInterval(fetchRealTimeData, 60000);
    </script>
</body>
</html>
