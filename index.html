
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Meteo Professionale</title>
    <style>
        :root {
            --primary-color: #6785bf;
            --primary-dark: #0097a7;
            --secondary-color: #ffc107;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --dark-bg: #121212;
            --medium-bg: #1e1e1e;
            --light-bg: #2c2c2c;
            --text-color: #e0e0e0;
            --text-muted: #999;
            --border-color: #333;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .light-mode {
            --dark-bg: #f5f5f5;
            --medium-bg: #ffffff;
            --light-bg: #e0e0e0;
            --text-color: #212121;
            --text-muted: #616161;
            --border-color: #bdbdbd;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* === FEATHER ICONS STYLING === */
        .feather-icon {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            vertical-align: middle;
        }

        .icon-btn .feather-icon,
        .chart-btn .feather-icon {
            width: 16px;
            height: 16px;
        }

        .quick-stat-icon .feather-icon {
            width: 28px;
            height: 28px;
            stroke-width: 2.5;
        }

        .alert-icon .feather-icon {
            width: 24px;
            height: 24px;
        }

        /* Stili per le icone della legenda della mappa */
        .legend-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            vertical-align: middle;
        }
        .legend-icon.circle {
            background-color: var(--primary-color);
            border-radius: 50%;
        }
        .legend-icon.triangle {
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 18px solid var(--primary-color);
        }

        /* === TOP HEADER === */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, var(--medium-bg) 0%, var(--dark-bg) 100%);
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1001;
            box-shadow: var(--shadow-lg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            display: block;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .header-title {
            font-size: 1.3em;
            font-weight: 300;
            color: var(--primary-color);
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online { background-color: var(--success-color); }
        .status-dot.offline { background-color: var(--danger-color); animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* === MAPPING COLORI ALLERTE REGIONALI === */
        .alert-badge.verde {
            background: var(--success-color);
            color: white;
        }

        .alert-badge.gialla {
            background: #ffc107; /* Giallo più visibile */
            color: var(--dark-bg);
            font-weight: 700;
        }

        .alert-badge.arancione {
            background: #ff9800;
            color: white;
            font-weight: 700;
        }

        .alert-badge.rossa {
            background: var(--danger-color);
            color: white;
            font-weight: 700;
            animation: blink 1s infinite; /* Lampeggia come le allerte critiche */
        }

        /* Icone specifiche per le allerte con colori dinamici */
        #overview-alerts-today .quick-stat-icon,
        #overview-alerts-tomorrow .quick-stat-icon {
            transition: background 0.3s ease;
        }

        #overview-alerts-today.alert-verde .quick-stat-icon,
        #overview-alerts-tomorrow.alert-verde .quick-stat-icon {
            background: var(--success-color);
        }

        #overview-alerts-today.alert-gialla .quick-stat-icon,
        #overview-alerts-tomorrow.alert-gialla .quick-stat-icon {
            background: #ffc107;
        }

        #overview-alerts-today.alert-arancione .quick-stat-icon,
        #overview-alerts-tomorrow.alert-arancione .quick-stat-icon {
            background: #ff9800;
        }

        #overview-alerts-today.alert-rossa .quick-stat-icon,
        #overview-alerts-tomorrow.alert-rossa .quick-stat-icon {
            background: var(--danger-color);
        }

        .last-update {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 16px;
        }

        .icon-btn:hover {
            background: var(--primary-color);
            color: var(--dark-bg);
            transform: scale(1.1);
        }

        /* === SIDEBAR === */
        .sidebar {
            width: 260px;
            background-color: var(--medium-bg);
            padding: 20px;
            height: calc(100vh - 60px);
            position: fixed;
            left: 0;
            top: 60px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            transition: var(--transition);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 300;
            font-size: 1.2em;
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li {
            margin-bottom: 5px;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            padding: 12px 15px;
            text-decoration: none;
            border-radius: 8px;
            transition: var(--transition);
            font-size: 0.95em;
        }

        .sidebar ul li a:before {
            content: '▪';
            color: var(--primary-color);
            font-size: 1.2em;
        }

        .sidebar ul li a:hover, .sidebar ul li a.active {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-weight: 500;
            transform: translateX(5px);
        }

        .sidebar-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* === MAIN CONTENT === */
        #main-content {
            margin-left: 260px;
            margin-top: 60px;
            padding: 25px;
            transition: var(--transition);
            min-height: calc(100vh - 60px);
        }

        #main-content.expanded {
            margin-left: 0;
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .page-section.active {
            display: block;
        }
        
        /* === MAP CONTAINER === */
        #map-container {
            width: 100%;
            height: 700px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        /* Stile personalizzato per i popup di Leaflet */
        .leaflet-popup-content-wrapper {
            background: var(--medium-bg);
            color: var(--text-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
        }

        .leaflet-popup-content {
            margin: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .leaflet-popup-content h3 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .leaflet-popup-content p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .leaflet-popup-content a {
            display: inline-block;
            margin-top: 10px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.85em;
            transition: var(--transition);
        }

        .leaflet-popup-content a:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .leaflet-popup-tip {
            background: var(--medium-bg);
        }

/* Animazione pulse per icone in allerta */
@keyframes markerPulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

.custom-marker.alert-critical > div {
    animation: markerPulse 2s ease-in-out infinite;
}

.custom-marker.alert-warning > div {
    animation: markerPulse 3s ease-in-out infinite;
}

        /* Stile per i marker delle stazioni WeatherLink e combinate */
        .weatherlink-marker {
            background: rgba(30, 30, 30, 0.85);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 6px;
            box-shadow: var(--shadow);
            text-align: center;
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            font-size: 13px; /* Aumentato */
            line-height: 1.4;
            width: 125px; /* Aumentato */
            white-space: nowrap;
        }
        .weatherlink-marker .station-name {
            font-weight: bold;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 4px;
            padding-bottom: 3px;
            font-size: 14px; /* Aumentato */
        }
        .weatherlink-marker .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            padding: 1px 2px;
        }
        .weatherlink-marker .data-row span {
            font-weight: 600;
        }


        /* Override del tema scuro per i controlli Leaflet */
        .leaflet-control-zoom a {
            background-color: var(--medium-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        .leaflet-bar {
            border: 1px solid var(--border-color) !important;
        }

        .leaflet-control-custom a {
            background-color: var(--medium-bg) !important;
            color: var(--text-color) !important;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            text-decoration: none;
            font-size: 1.2em;
        }

        .leaflet-control-custom a:hover {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

/* === STILI DEL CONTROLLO RADAR MIGLIORATI (VERSIONE COMPATTA) === */

.leaflet-control-radar {
    background: rgba(30, 30, 30, 0.85);
    backdrop-filter: blur(5px);
    border-radius: 8px; /* Leggermente più piccolo */
    padding: 6px;      /* Ridotto */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); /* Sottile */
    border: 1px solid #333;
    display: flex;
    align-items: center;
    gap: 8px;          /* Ridotto */
    width: 280px;      /* Ridotta la larghezza totale */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* === PULSANTE PLAY/PAUSA === */
.radar-play-pause button,
.radar-play-button {
    background: #2c2c2c;
    border: 1px solid #333;
    color: #e0e0e0;
    width: 32px;       /* Ridotto */
    height: 32px;      /* Ridotto */
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2em;  /* Ridotto */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
}

.radar-play-pause button:hover,
.radar-play-button:hover {
    background: #6785bf;
    color: white;
    transform: scale(1.05);
}

/* === CONTENITORE TIMELINE === */
.radar-timeline-container {
    flex-grow: 1;
    position: relative;
    padding-top: 25px; /* Ridotto */
}

/* === ETICHETTA ORARIO (usa classe invece di ID) === */
.radar-time-label {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background: #6785bf;
    color: white;
    padding: 3px 8px; /* Ridotto */
    border-radius: 4px;
    font-size: 0.75em; /* Ridotto */
    font-weight: bold;
    white-space: nowrap;
    transition: left 0.1s linear;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    z-index: 20;
}

/* Freccia sotto l'etichetta */
.radar-time-label::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 4px solid #6785bf;
}

/* === WRAPPER SLIDER === */
.radar-slider-wrapper {
    position: relative;
    width: 100%;
    height: 16px; /* Ridotto per contenere il thumb più piccolo */
    margin-bottom: 6px; /* Ridotto */
    display: flex;
    align-items: center;
}

/* FIX: Assicura che lo slider sia allineato */
.radar-timeline-slider {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 0;
    width: 100%;
    height: 2px; /* Ridotto spessore della barra cliccabile */
    margin: 0 !important;
    padding: 0 !important;
}

/* Sfondo della barra (track) */
.radar-slider-track {
    position: absolute;
    width: 100%;
    height: 2px; /* Ridotto lo spessore della barra visibile */
    background: #121212;
    border-radius: 3px;
    overflow: hidden;
    z-index: 1;
}

/* Barra blu (passato) */
.radar-slider-progress {
    position: absolute;
    height: 100%;
    background: #6785bf;
    width: 50%;
    border-radius: 3px 0 0 3px;
    transition: width 0.1s linear;
    z-index: 2;
}

/* Barra bianca (futuro) */
.radar-slider-future {
    position: absolute;
    right: 0;
    height: 100%;
    background: #ffffff;
    width: 50%;
    border-radius: 0 3px 3px 0;
    transition: width 0.1s linear;
    z-index: 2;
}

/* === SLIDER (usa classe invece di ID) === */
.radar-timeline-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 2px; /* Ridotto */
    background: transparent !important;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
    position: relative;
    z-index: 10;
    margin: 0;
    padding: 0;
}

/* Traccia trasparente WebKit */
.radar-timeline-slider::-webkit-slider-runnable-track {
    background: transparent;
    border: none;
    height: 2px; /* Ridotto */
}

/* Traccia trasparente Firefox */
.radar-timeline-slider::-moz-range-track {
    background: transparent;
    border: none;
    height: 2px; /* Ridotto */
}

/* === THUMB WEBKIT - RESO TRASPARENTE === */
.radar-timeline-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: transparent; /* MODIFICATO */
    border: none;            /* MODIFICATO */
    cursor: grab;
    box-shadow: none;        /* MODIFICATO */
    transition: transform 0.2s;
    margin-top: -7px; 
    position: relative;
    z-index: 15;
}

.radar-timeline-slider::-webkit-slider-thumb:active {
    cursor: grabbing;
}

/* === THUMB FIREFOX - RESO TRASPARENTE === */
.radar-timeline-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: transparent; /* MODIFICATO */
    border: none;            /* MODIFICATO */
    cursor: grab;
    box-shadow: none;        /* MODIFICATO */
    transition: transform 0.2s;
    position: relative;
    z-index: 15;
}

.radar-timeline-slider::-moz-range-thumb:active {
    cursor: grabbing;
}

/* === ETICHETTE SOTTO LO SLIDER === */
.radar-timeline-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.7em; /* Ridotto */
    color: #999;
    margin: 0;
    padding: 0 5px; /* Ridotto */
}

.radar-timeline-labels span {
    text-align: center;
}

.radar-timeline-labels span:first-child {
    text-align: left;
}

.radar-timeline-labels span:last-child {
    text-align: right;
}

        /* === RADAR TOGGLE CONTROL === */
        .leaflet-control-radar-toggle a {
            background-color: var(--medium-bg);
            border-radius: 4px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .leaflet-control-radar-toggle a .feather-icon {
            width: 18px;
            height: 18px;
            color: var(--text-color);
        }

        .leaflet-control-radar-toggle a:hover {
            background-color: var(--light-bg);
        }

        .leaflet-control-radar-toggle a.active {
            background-color: var(--primary-color);
        }
        
        .leaflet-control-radar-toggle a.active .feather-icon {
            color: white;
        }

        .leaflet-control-radar-toggle a.active:hover {
            background-color: var(--primary-dark);
        }

        /* === RADAR LEGEND STYLES === */
        .leaflet-control-radar-legend {
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            width: 300px;
        }

        .leaflet-control-radar-legend .legend-title {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-color);
            text-align: center;
            margin-bottom: 8px;
        }

        .leaflet-control-radar-legend .legend-gradient {
            width: 100%;
            height: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            /* Questo è il gradiente con i colori di RainViewer */
            background: linear-gradient(to right, #0000FF, #0096FF, #00FFFF, #00C800, #009600, #FFFF00, #FFC800, #FF9600, #FF0000, #C80000, #960000, #FF00FF);
        }

        .leaflet-control-radar-legend .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === LOADING SPINNER === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(18, 18, 18, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--medium-bg);
            border-left: 4px solid var(--primary-color);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.error { border-left-color: var(--danger-color); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 0.9em;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
        }
        
.update-error-badge { 
    display: inline-block; 
    margin-left: 10px; 
    padding: 4px 8px; 
    background: #ff6b6b; 
    color: white; 
    border-radius: 4px; 
    font-size: 0.85em; 
    animation: pulse-error 2s infinite; 
} 

@keyframes pulse-error { 
    0%, 100% { opacity: 1; } 50% { opacity: 0.6; } 
} 

.loading-pulse { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    padding: 8px 12px; 
    background: rgba(74, 144, 226, 0.1); 
    border-radius: 4px; 
    font-size: 0.9em; 
    color: #4a90e2; 
} 

.pulse-dot { 
    width: 8px; 
    height: 8px; 
    background: #4a90e2; 
    border-radius: 50%; 
    animation: pulse-dot 1.5s ease-in-out infinite; 
} 

@keyframes pulse-dot { 
    0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 
}

        /* === CARDS & TYPOGRAPHY === */
        h1, h2 {
            color: var(--primary-color);
            font-weight: 300;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 { font-size: 2em; }
        h2 { font-size: 1.6em; }

        .card {
            background-color: var(--medium-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        /* === QUICK STATS (OVERVIEW) === */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .quick-stat-card {
            background: linear-gradient(135deg, var(--medium-bg), var(--light-bg));
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .quick-stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
        }

        /* === OVERVIEW GRID FOR WINDY & ALERTS === */
        .overview-grid-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-top: 30px;
        }

        .grid-item .card {
            height: 100%;
        }

        #dashboard-map-container {
            padding: 0;
            overflow: hidden;
            height: 600px; /* Default height */
            width: 100%;
        }
        
        .alerts-container-wrapper .card {
            max-height: 600px;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .overview-grid-container {
                grid-template-columns: 1fr;
            }
             #windy-map, .alerts-container-wrapper .card {
                height: 400px;
            }
        }

        .quick-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .quick-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .quick-stat-content {
            flex: 1;
        }

        .quick-stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .quick-stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .quick-stat-unit {
            font-size: 0.5em;
            color: var(--text-muted);
            font-weight: 400;
        }

        .quick-stat-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .trend-up {
            color: var(--danger-color);
        }

        .trend-down {
            color: var(--success-color);
        }

        .trend-neutral {
            color: var(--text-muted);
        }

        .alert-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .alert-badge.normal {
            background: var(--success-color);
            color: white;
        }

        .alert-badge.warning {
            background: var(--warning-color);
            color: var(--dark-bg);
        }

        .alert-badge.critical {
            background: var(--danger-color);
            color: white;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* === ALERT ITEMS === */
        .alert-item {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--warning-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-item.critical {
            border-left-color: var(--danger-color);
            animation: alertPulse 2s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { background: var(--light-bg); }
            50% { background: rgba(244, 67, 54, 0.1); }
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .alert-message {
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .alert-time {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* === FILTERS === */
        .filter-container {
            background-color: var(--medium-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .filter-container input,
        .filter-container button,
        .filter-container select {
            background-color: var(--light-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            transition: var(--transition);
            font-size: 0.9em;
        }

        .filter-container input:focus,
        .filter-container select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
        }

        .filter-container button {
            cursor: pointer;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 10px 25px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-container button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .filter-container button:active {
            transform: translateY(0);
        }

        .quick-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-filter-btn {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: var(--transition);
        }

        .quick-filter-btn:hover,
        .quick-filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* === DATA GROUPS === */
        .data-groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .data-group {
            background: linear-gradient(135deg, var(--medium-bg), var(--light-bg));
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .data-group:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .group-title {
            color: var(--primary-color);
            text-align: center;
            margin: 0 0 20px 0;
            font-weight: 400;
            font-size: 1.2em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        /* === STAT CARDS === */
        .stat-card {
            background-color: var(--dark-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
            transition: var(--transition);
            border: 1px solid transparent;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary-color);
        }

        .stat-card .title {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
        }

        .stat-card .unit {
            font-size: 0.6em;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* === WIND BAR WIDGET === */
        .wind-bar-widget {
            background: linear-gradient(135deg, var(--light-bg), var(--medium-bg));
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .wind-bar-widget:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .wind-bar-widget .widget-title {
            color: var(--text-color);
            text-align: center;
            margin: 0 0 5px 0;
            font-weight: 500;
            font-size: 1.2em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
        }

        .wind-bar-widget .bar-section {
            width: 100%;
        }

        .wind-bar-widget .bar-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-muted);
        }

        .wind-bar-widget .bar-value {
            font-weight: 700;
            font-size: 1.15em;
            color: var(--text-color);
        }

        .wind-bar-widget .progress-bar-bg {
            width: 100%;
            height: 24px;
            background-color: var(--dark-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .wind-bar-widget .progress-bar-fill {
            height: 100%;
            width: 0%;
            border-radius: 12px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .wind-bar-widget .progress-bar-fill:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .wind-bar-widget .progress-bar-fill.wind {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        }

        .wind-bar-widget .progress-bar-fill.gust {
            background: linear-gradient(90deg, var(--warning-color), #ff6f00);
        }

        /* === CHARTS === */
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: center;
        }

        .chart-wrapper {
            flex: 1;
            min-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }

        .chart-title {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-color);
        }

        .chart-actions {
            display: flex;
            gap: 8px;
        }

        .chart-btn {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chart-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .chart-container {
            min-height: 500px;
            cursor: grab;
            position: relative;
        }

        .chart-container:active {
            cursor: grabbing;
        }

        .chart-container.fullscreen {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9998;
            background: var(--dark-bg);
            padding: 20px;
            min-height: auto;
            height: calc(100vh - 80px);
        }
        
        /* === FULLSCREEN EXIT BUTTON === */
        .fullscreen-exit-btn {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 9999;
            background: var(--danger-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .fullscreen-exit-btn:hover {
            background: #d32f2f;
            transform: scale(1.1) rotate(90deg);
        }

        .fullscreen-exit-btn:active {
            transform: scale(0.95);
        }

        /* === STATISTICS TABLE === */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .stats-table th,
        .stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-table th {
            background: var(--light-bg);
            color: var(--primary-color);
            font-weight: 600;
        }

        .stats-table tr:hover {
            background: var(--light-bg);
        }

        /* === DATA TABLE === */
        .table-container {
            flex: 1;
            min-width: 300px;
            max-height: 540px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }

        thead th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            position: sticky;
            top: 0;
            font-weight: 600;
            z-index: 10;
        }

        tbody tr {
            background-color: var(--light-bg);
            transition: var(--transition);
            cursor: pointer;
        }

        tbody tr:nth-child(even) {
            background-color: var(--medium-bg);
        }

        tbody tr:hover {
            background-color: var(--primary-color) !important;
            color: white;
            transform: scale(1.01);
        }

        tbody tr.highlighted {
            background-color: var(--primary-color) !important;
            color: white;
            font-weight: 600;
        }

        .table-container::-webkit-scrollbar {
            width: 10px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
            border: 2px solid var(--light-bg);
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* === FORECAST PAGE === */
        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .toggle-btn {
            background: linear-gradient(135deg, var(--light-bg), var(--medium-bg));
            color: var(--text-color);
            border: 1px solid var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: var(--transition);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .instructions {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out, margin-top 0.5s ease-out;
            margin-top: 0;
        }

        .instructions.visible {
            max-height: 300px;
            opacity: 1;
            margin-top: 15px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.95em;
            margin-top: 0;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.8;
            background: var(--medium-bg);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }

        #resetZoomBtn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: var(--transition);
        }

        #resetZoomBtn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }


        /* === RESPONSIVE === */
        @media (max-width: 1200px) {
            #official-alerts-container {
                grid-column: span 1;
            }
        }
         @media (max-width: 600px) {
            #official-alerts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .quick-stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .data-groups-container {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .header-title {
                font-size: 1em;
            }

            .header-actions {
                gap: 5px;
            }

            .status-indicator,
            .last-update {
                display: none;
            }

            .quick-stats {
                grid-template-columns: 1fr;
            }

            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-container {
                min-height: 350px;
            }
        }

        /* === MODALS === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--medium-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--primary-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3em;
            color: var(--primary-color);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--danger-color);
            color: white;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-option {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--light-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .modal-option:hover {
            border-color: var(--primary-color);
            background: var(--dark-bg);
        }
        
        .modal-option h4 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .checkbox-container label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--light-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9em;
        }

        .checkbox-container label:hover {
            background: var(--primary-color);
            color: white;
        }

        .checkbox-container input[type="checkbox"] {
            cursor: pointer;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .settings-item input[type="number"] {
            width: 100px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 6px;
        }
        /* Switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
/* === LOGIN STYLES === */
#login-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: var(--dark-bg);
z-index: 10002;
display: flex;
align-items: center;
justify-content: center;
transition: opacity 0.5s ease-out, visibility 0.5s;
}
.login-box {
background: var(--medium-bg);
padding: 40px;
border-radius: 12px;
box-shadow: var(--shadow-lg);
text-align: center;
border: 1px solid var(--border-color);
width: 90%;
max-width: 400px;
}
.login-box h2 { color: var(--primary-color); margin-bottom: 25px; }
.login-box input { width: 100%; padding: 12px 15px; background: var(--light-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1em; margin-bottom: 20px; }
.login-box input:focus { outline: none; border-color: var(--primary-color); }
.login-box button { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: var(--transition); }
.login-box button:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.login-box .error-message { color: var(--danger-color); margin-top: 15px; height: 20px; font-size: 0.9em; }
.content-hidden { visibility: hidden; opacity: 0; transition: opacity 0.5s ease-in; }

        /* Notifica aggiornamento grafici */
        .chart-update-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(103, 133, 191, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInRight 0.3s ease-out;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .chart-update-indicator .spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

/* Mobile: sotto 768px */
@media (max-width: 768px) {
    .top-header {
        height: auto;
        min-height: 60px;
        padding: 10px 15px;
        flex-wrap: wrap;
    }
    
    .header-left {
        flex: 1;
        min-width: 0;
    }
    
    .header-title {
        font-size: 1em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .header-right {
        gap: 10px;
        flex-wrap: nowrap; /* Prevent icons from wrapping */
        justify-content: flex-end;
        align-items: center;
        flex-basis: 50%; /* Assign a base width */
    }
    
    /* Mostra info essenziali anche su mobile */
    .last-update {
        display: block !important;
        font-size: 0.7em;
        width: 100%;
        text-align: left; /* Aligned to the left under the title */
        margin-top: 5px;
        flex-basis: 100%; /* Ensures it takes full width */
        order: 2; /* Puts it after the icons */
    }
    
    #next-update {
        display: none; /* Solo ultimo aggiornamento su mobile */
    }
    
    .status-indicator {
        display: flex !important;
        font-size: 0.75em;
    }
}

@media (max-width: 768px) {
    .sidebar {
        position: fixed;
        top: 60px;
        left: -100%; /* Nascosta di default */
        width: 80%; /* Max 80% schermo */
        max-width: 300px;
        height: calc(100vh - 60px);
        z-index: 1000;
        transition: left 0.3s ease;
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
    }
    
    .sidebar.open {
        left: 0;
    }
    
    /* Overlay scuro quando sidebar aperta */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }
    
    .sidebar ul li a {
        padding: 15px 20px; /* Touch target più grande */
        font-size: 1em;
    }
}

@media (max-width: 768px) {
    .quick-stats {
        grid-template-columns: 1fr; /* Una colonna su mobile */
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .quick-stat-card {
        padding: 15px;
    }
    
    .quick-stat-icon {
        width: 45px;
        height: 45px;
    }
    
    .quick-stat-value {
        font-size: 1.6em;
    }
}

@media (max-width: 768px) {
    .data-groups-container {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .stats-container {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
    }
    
    .stat-card {
        padding: 12px;
    }
    
    .stat-card .title {
        font-size: 0.8em;
    }
    
    .stat-card .value {
        font-size: 1.4em;
    }
}

@media (max-width: 768px) {
    .wind-bar-widget {
        padding: 15px;
    }
    
    .wind-bar-widget .widget-title {
        font-size: 1.1em;
    }
    
    .wind-bar-widget .bar-label {
        font-size: 0.85em;
    }
    
    .wind-bar-widget .bar-value {
        font-size: 1em;
    }
}

@media (max-width: 768px) {
    .filter-container {
        flex-direction: column;
        gap: 12px;
        padding: 15px;
    }
    
    .filter-group {
        width: 100%;
    }
    
    .filter-group label {
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    
    .filter-container input,
    .filter-container select,
    .filter-container button {
        width: 100%;
        padding: 12px 15px; /* Touch-friendly */
        font-size: 1em;
    }
    
    .quick-filters {
        justify-content: space-between;
    }
    
    .quick-filter-btn {
        flex: 1;
        min-width: 60px;
        padding: 8px 10px;
        font-size: 0.85em;
        text-align: center;
    }
    
    .checkbox-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .checkbox-container label {
        padding: 10px 15px;
        width: 100%;
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .chart-wrapper {
        min-width: 100%;
    }
    
    .chart-container {
        min-height: 350px;
        max-height: 400px;
    }
    
    .chart-header {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    
    .chart-title {
        text-align: center;
        font-size: 1em;
    }
    
    .chart-actions {
        justify-content: center;
        width: 100%;
    }
    
    .chart-btn {
        flex: 1;
        justify-content: center;
        padding: 10px 15px;
        font-size: 0.9em;
    }
}

@media (max-width: 768px) {
    .table-container {
        max-height: 400px;
        border-radius: 8px;
    }
    
    table {
        font-size: 0.85em;
    }
    
    th, td {
        padding: 10px 8px;
        white-space: nowrap;
    }
    
    /* Tabella forecast: nascondi colonna meno importante su schermi piccoli */
    #dataTable th:nth-child(2),
    #dataTable td:nth-child(2) {
        display: none;
    }
    
    /* Mostra solo Q50 e Q90 su mobile */
}

@media (max-width: 480px) {
    /* Su schermi molto piccoli, mostra solo Q50 */
    #dataTable th:nth-child(4),
    #dataTable td:nth-child(4) {
        display: none;
    }
}

@media (max-width: 768px) {
    .table-mobile-card {
        display: none; /* Nasconde la tabella standard */
    }
    
    .table-mobile-list {
        display: block;
    }
    
    .table-mobile-item {
        background: var(--light-bg);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary-color);
    }
    
    .table-mobile-item .timestamp {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 8px;
    }
    
    .table-mobile-item .data-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid var(--border-color);
    }
}

@media (max-width: 768px) {
    #map-container {
        height: 400px; /* Ridotta ma ancora usabile */
        border-radius: 8px;
    }
    
    /* Marker più grandi per touch */
    .custom-marker > div {
        width: 60px !important;
        height: 60px !important;
        font-size: 20px !important;
    }
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        max-width: none;
        max-height: 85vh;
        padding: 20px 15px;
        margin: 20px;
    }
    
    .modal-title {
        font-size: 1.1em;
    }
    
    .modal-option {
        padding: 15px;
        margin-bottom: 12px;
    }
    
    .modal-option h4 {
        font-size: 1em;
    }
    
    .settings-item {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }
    
    .settings-item input[type="number"] {
        width: 100%;
    }
}

@media (max-width: 768px) and (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Disabilita alcune animazioni pesanti su mobile */
@media (max-width: 768px) {
    .wind-bar-widget .progress-bar-fill:after {
        animation: none;
    }
    
    @keyframes alertPulse {
        /* Animazione più leggera */
        0%, 100% { background: var(--light-bg); }
        50% { background: rgba(244, 67, 54, 0.05); }
    }
}

/* Touch target minimi di 44x44px */
@media (max-width: 768px) {
    button, 
    a, 
    .icon-btn,
    .chart-btn,
    .quick-filter-btn,
    input[type="checkbox"] {
        min-width: 44px;
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Spaziatura tra elementi cliccabili */
    .header-actions {
        gap: 12px;
    }
    
    .chart-actions {
        gap: 12px;
    }
    
    /* Focus visibile per navigazione da tastiera */
    button:focus-visible,
    a:focus-visible,
    input:focus-visible {
        outline: 3px solid var(--primary-color);
        outline-offset: 2px;
    }

    button:active,
    .icon-btn:active,
    .chart-btn:active,
    .nav-link:active {
        transform: scale(0.95);
        opacity: 0.8;
    }
}

@media (max-width: 768px) and (orientation: landscape) {
    .top-header {
        height: 50px;
        padding: 8px 15px;
    }
    
    .sidebar {
        top: 50px;
        height: calc(100vh - 50px);
    }
    
    #main-content {
        margin-top: 50px;
    }
    
    .chart-container {
        min-height: 250px;
        max-height: 60vh;
    }
    
    #map-container {
        height: 60vh;
    }
    
    /* Quick stats su 2 colonne in landscape */
    .quick-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
</head>
<body>
    <div id="login-overlay">
        <div class="login-box">
            <h2>Thunder - Dashboard Meteo</h2>
            <p>Inserisci la password per continuare.</p>
            <input type="password" id="password-input" placeholder="Password">
            <button id="login-button">Accedi</button>
            <p class="error-message" id="error-message"></p>
        </div>
    </div>
<div id="app-container" class="content-hidden">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Top Header -->
    <header class="top-header">
        <div class="header-left">
            <button class="menu-toggle" id="menu-toggle">☰</button>
            <h1 class="header-title">Dashboard Meteo Thunder - Progettata e Sviluppata da Alberto Bussaglia</h1>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <span class="status-dot online" id="status-dot"></span>
                <span id="status-text">Online</span>
            </div>
            <div class="last-update" id="last-update">
                Ultimo aggiornamento: --:--
            </div>
            <div class="last-update" id="next-update">
                Prossimo aggiornamento: --
            </div>
            <div class="last-update" id="data-range-indicator" style="font-size: 0.8em; color: var(--text-muted);">
                📊 Dati: ultimi 7 giorni
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="refresh-btn" title="Aggiorna dati">
                    <i data-feather="refresh-cw" class="feather-icon"></i>
                </button>
                <button class="icon-btn" id="export-btn" title="Esporta dati">
                    <i data-feather="download" class="feather-icon"></i>
                </button>
                <button class="icon-btn" id="settings-btn" title="Impostazioni">
                    <i data-feather="settings" class="feather-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar collapsed" id="sidebar">
        <h2>Navigazione</h2>
        <ul>
            <li><a href="#overview" class="nav-link active">Dashboard</a></li>
            <li><a href="#previsioni" class="nav-link">Previsioni Idro</a></li>
            <li><a href="#idrometri" class="nav-link">Idrometri</a></li>
            <li><a href="#pluviometri" class="nav-link">Pluviometri</a></li>
            <li><a href="#anemometri" class="nav-link">Anemometri</a></li>
            <li><a href="#mappa" class="nav-link">Mappa Stazioni</a></li>
            <li><a href="#analisi" class="nav-link">Analisi Avanzata</a></li>
        </ul>
        <div class="sidebar-footer">
            <p>Dashboard Meteo Thunder v2.0</p>
            <p>Progettata e sviluppata da Alberto Bussaglia</p>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="expanded">
        
        <!-- OVERVIEW PAGE -->
        <section id="overview" class="page-section active">
            <h1><i data-feather="bar-chart-2" class="feather-icon"></i> Panoramica Generale</h1>
            
            <div class="quick-stats" id="overview-quick-stats">
                <div class="quick-stat-card" id="overview-hydro-max">
                    <div class="quick-stat-icon">
                        <i data-feather="droplet" class="feather-icon"></i>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Livello Idro Max</div>
                        <div class="quick-stat-value">--<span class="quick-stat-unit">m</span></div>
                        <div class="quick-stat-trend trend-neutral">
                            <span>--</span>
                        </div>
                    </div>
                    <span class="alert-badge normal">NORMALE</span>
                </div>

                <div class="quick-stat-card" id="overview-rain-total">
                    <div class="quick-stat-icon">
                        <i data-feather="cloud-rain" class="feather-icon"></i>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Pioggia Max Oggi</div>
                        <div class="quick-stat-value">--<span class="quick-stat-unit">mm</span></div>
                        <div class="quick-stat-trend trend-neutral">
                            <span>--</span>
                        </div>
                    </div>
                    <span class="alert-badge normal">NORMAL</span>
                </div>

                <div class="quick-stat-card" id="overview-wind-max">
                    <div class="quick-stat-icon">
                        <i data-feather="wind" class="feather-icon"></i>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Raffica Max</div>
                        <div class="quick-stat-value">--<span class="quick-stat-unit">km/h</span></div>
                        <div class="quick-stat-trend trend-neutral">
                            <span>--</span>
                        </div>
                    </div>
                    <span class="alert-badge normal">NORMALE</span>
                </div>

                <div class="quick-stat-card" id="overview-rain-intensity">
                    <div class="quick-stat-icon">
                        <i data-feather="cloud-drizzle" class="feather-icon"></i>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Intensità Pioggia Max</div>
                        <div class="quick-stat-value">--<span class="quick-stat-unit">mm/h</span></div>
                        <div class="quick-stat-trend trend-neutral">
                            <span>--</span>
                        </div>
                    </div>
                    <span class="alert-badge normal">NORMALE</span>
                </div>

                <!-- Card Allerte OGGI -->
                <div class="quick-stat-card" id="overview-alerts-today">
                    <div class="quick-stat-icon">
                        <i data-feather="alert-triangle" class="feather-icon"></i>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Allerte Oggi</div>
                        <div class="quick-stat-value">--</div>
                        <div class="quick-stat-trend trend-neutral">
                            <span>Caricamento...</span>
                        </div>
                    </div>
                    <span class="alert-badge normal">VERDE</span>
                </div>

                <!-- Card Allerte DOMANI -->
                <div class="quick-stat-card" id="overview-alerts-tomorrow">
                    <div class="quick-stat-icon">
                        <i data-feather="calendar" class="feather-icon"></i>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Allerte Domani</div>
                        <div class="quick-stat-value">--</div>
                        <div class="quick-stat-trend trend-neutral">
                            <span>Caricamento...</span>
                        </div>
                    </div>
                    <span class="alert-badge normal">VERDE</span>
                </div>
            </div>

            <div class="overview-grid-container">
                <div class="grid-item">
                    <h2><i data-feather="map-pin" class="feather-icon"></i> Mappa Stazioni</h2>
                    <div class="card" id="dashboard-map-container">
                        </div>
                </div>
                <div class="grid-item alerts-container-wrapper">
                    <h2><i data-feather="alert-circle" class="feather-icon"></i> Allerte e Situazioni Critiche</h2>
                    <div class="card" id="alerts-container">
                        <p style="color: var(--text-muted); text-align: center;">Nessuna allerta al momento</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PREVISIONI IDRO PAGE -->
        <section id="previsioni" class="page-section">
            <div class="header">
                <h1><i data-feather="activity" class="feather-icon"></i> Previsione Idrometrica Misa (Bettolelle)</h1>
                <button id="toggle-instructions-btn" class="toggle-btn">
                    <i data-feather="book-open" class="feather-icon"></i> Mostra Istruzioni
                </button>
                <div id="instructions-container" class="instructions">
                    <p class="subtitle">
                        <b>🖱️ Sposta:</b> Trascina il grafico con il mouse per spostarti nel tempo.<br/>
                        <b>🔍 Zoom:</b> Usa la rotellina del mouse per ingrandire/rimpicciolire.<br/>
                        <b>🔄 Reset:</b> Clicca "Reset Zoom" per tornare alla vista completa.<br/>
                        <b>✨ Interazione:</b> Passa il mouse sulla tabella per evidenziare i punti corrispondenti sul grafico.<br/>
                        <b>📊 Quantili:</b> Q10 (minimo), Q50 (mediana), Q90 (massimo) rappresentano la fascia di previsione.
                    </p>
                    <button id="resetZoomBtn">🔄 Reset Zoom Grafico</button>
                </div>
            </div>
            
            <div class="container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <span class="chart-title">Andamento Previsto</span>
                        <div class="chart-actions">
                            <button class="chart-btn" id="download-forecast-chart">
                                <i data-feather="camera" class="feather-icon"></i> Scarica
                            </button>
                            <button class="chart-btn" id="fullscreen-forecast">
                                <i data-feather="maximize" class="feather-icon"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                    <div class="chart-container card" id="forecastChart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                    <div class="card">
                        <h3 style="color: var(--primary-color); margin-top: 0;">Statistiche Previsione</h3>
                        <table class="stats-table" id="forecast-stats-table">
                            <thead>
                                <tr>
                                    <th>Metrica</th>
                                    <th>Q10 (min)</th>
                                    <th>Q50 (med)</th>
                                    <th>Q90 (max)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Livello Medio</td>
                                    <td id="q10-avg">--</td>
                                    <td id="q50-avg">--</td>
                                    <td id="q90-avg">--</td>
                                </tr>
                                <tr>
                                    <td>Picco Massimo</td>
                                    <td id="q10-max">--</td>
                                    <td id="q50-max">--</td>
                                    <td id="q90-max">--</td>
                                </tr>
                                <tr>
                                    <td>Valore Minimo</td>
                                    <td id="q10-min">--</td>
                                    <td id="q50-min">--</td>
                                    <td id="q90-min">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-container card" id="desktop-forecast-table">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>🕐 Timestamp</th>
                                <th>Q10 (m)</th>
                                <th>Q50 (m)</th>
                                <th>Q90 (m)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="mobile-forecast-list" class="table-mobile-list card"></div>
            </div>

            <hr style="border-color: var(--border-color); margin: 40px 0;">

            <h2 class="chart-title" style="text-align: center;">Previsioni idro bettolelle 3h</h2>
            <div class="container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <span class="chart-title">Andamento Previsto</span>
                        <div class="chart-actions">
                            <button class="chart-btn" id="download-forecast-chart-bettolelle-3h">
                                <i data-feather="camera" class="feather-icon"></i> Scarica
                            </button>
                            <button class="chart-btn" id="fullscreen-forecast-bettolelle-3h">
                                <i data-feather="maximize" class="feather-icon"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                    <div class="chart-container card" id="forecastChartBettolelle3h-container">
                        <canvas id="forecastChartBettolelle3h"></canvas>
                    </div>
                    <div class="card">
                        <h3 style="color: var(--primary-color); margin-top: 0;">Statistiche Previsione</h3>
                        <table class="stats-table" id="forecast-stats-table-bettolelle-3h">
                            <thead>
                                <tr>
                                    <th>Metrica</th>
                                    <th>Q10 (min)</th>
                                    <th>Q50 (med)</th>
                                    <th>Q90 (max)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Livello Medio</td>
                                    <td id="q10-avg-bettolelle-3h">--</td>
                                    <td id="q50-avg-bettolelle-3h">--</td>
                                    <td id="q90-avg-bettolelle-3h">--</td>
                                </tr>
                                <tr>
                                    <td>Picco Massimo</td>
                                    <td id="q10-max-bettolelle-3h">--</td>
                                    <td id="q50-max-bettolelle-3h">--</td>
                                    <td id="q90-max-bettolelle-3h">--</td>
                                </tr>
                                <tr>
                                    <td>Valore Minimo</td>
                                    <td id="q10-min-bettolelle-3h">--</td>
                                    <td id="q50-min-bettolelle-3h">--</td>
                                    <td id="q90-min-bettolelle-3h">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-container card" id="desktop-forecast-table-bettolelle-3h">
                    <table id="dataTableBettolelle3h">
                        <thead>
                            <tr>
                                <th>🕐 Timestamp</th>
                                <th>Q10 (m)</th>
                                <th>Q50 (m)</th>
                                <th>Q90 (m)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="mobile-forecast-list-bettolelle-3h" class="table-mobile-list card"></div>
            </div>

            <hr style="border-color: var(--border-color); margin: 40px 0;">

            <h2 class="chart-title" style="text-align: center;">Previsioni idro Ponte garibaldi 6h</h2>
            <div class="container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <span class="chart-title">Andamento Previsto</span>
                        <div class="chart-actions">
                            <button class="chart-btn" id="download-forecast-chart-ponte-garibaldi-6h">
                                <i data-feather="camera" class="feather-icon"></i> Scarica
                            </button>
                            <button class="chart-btn" id="fullscreen-forecast-ponte-garibaldi-6h">
                                <i data-feather="maximize" class="feather-icon"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                    <div class="chart-container card" id="forecastChartPonteGaribaldi6h-container">
                        <canvas id="forecastChartPonteGaribaldi6h"></canvas>
                    </div>
                    <div class="card">
                        <h3 style="color: var(--primary-color); margin-top: 0;">Statistiche Previsione</h3>
                        <table class="stats-table" id="forecast-stats-table-ponte-garibaldi-6h">
                            <thead>
                                <tr>
                                    <th>Metrica</th>
                                    <th>Q10 (min)</th>
                                    <th>Q50 (med)</th>
                                    <th>Q90 (max)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Livello Medio</td>
                                    <td id="q10-avg-ponte-garibaldi-6h">--</td>
                                    <td id="q50-avg-ponte-garibaldi-6h">--</td>
                                    <td id="q90-avg-ponte-garibaldi-6h">--</td>
                                </tr>
                                <tr>
                                    <td>Picco Massimo</td>
                                    <td id="q10-max-ponte-garibaldi-6h">--</td>
                                    <td id="q50-max-ponte-garibaldi-6h">--</td>
                                    <td id="q90-max-ponte-garibaldi-6h">--</td>
                                </tr>
                                <tr>
                                    <td>Valore Minimo</td>
                                    <td id="q10-min-ponte-garibaldi-6h">--</td>
                                    <td id="q50-min-ponte-garibaldi-6h">--</td>
                                    <td id="q90-min-ponte-garibaldi-6h">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-container card" id="desktop-forecast-table-ponte-garibaldi-6h">
                    <table id="dataTablePonteGaribaldi6h">
                        <thead>
                            <tr>
                                <th>🕐 Timestamp</th>
                                <th>Q10 (m)</th>
                                <th>Q50 (m)</th>
                                <th>Q90 (m)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="mobile-forecast-list-ponte-garibaldi-6h" class="table-mobile-list card"></div>
            </div>
        </section>

        <!-- IDROMETRI PAGE -->
        <section id="idrometri" class="page-section">
            <h1><i data-feather="droplet" class="feather-icon"></i> Idrometri - Monitoraggio Livelli Idrici</h1>
            
            <div class="data-groups-container">
                <div class="data-group">
                    <h3 class="group-title">Livelli Idrometrici Attuali</h3>
                    <div class="stats-container">
                        <div class="stat-card" id="hydro-serra-dei-conti">
                            <div class="title">Misa (Serra Conti)</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                        <div class="stat-card" id="hydro-pianello-ostra">
                            <div class="title">Misa (Pianello Ostra)</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                        <div class="stat-card" id="hydro-corinaldo-nevola">
                            <div class="title">Nevola (Corinaldo)</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                        <div class="stat-card" id="hydro-passo-ripe">
                            <div class="title">Nevola (Passo Ripe)</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                        <div class="stat-card" id="hydro-misa-bettolelle">
                            <div class="title">Misa (Bettolelle)</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                        <div class="stat-card" id="hydro-ponte-garibaldi">
                            <div class="title">Misa (P. Garibaldi)</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                        <div class="stat-card" id="hydro-foce-cesano">
                            <div class="title">Foce Cesano</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                        <div class="stat-card" id="hydro-cesano">
                            <div class="title">Cesano</div>
                            <div class="value">--<span class="unit">m</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-container">
                <div class="filter-group">
                    <label>Filtri Rapidi</label>
                    <div class="quick-filters" id="quick-filters-hydro">
                        <button class="quick-filter-btn" data-hours="6">6 ore</button>
                        <button class="quick-filter-btn active" data-hours="12">12 ore</button>
                        <button class="quick-filter-btn" data-hours="24">24 ore</button>
                        <button class="quick-filter-btn" data-hours="72">3 giorni</button>
                        <button class="quick-filter-btn" data-hours="168">7 giorni</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="start-time-hydro">Da:</label>
                    <input type="datetime-local" id="start-time-hydro">
                </div>
                <div class="filter-group">
                    <label for="end-time-hydro">A:</label>
                    <input type="datetime-local" id="end-time-hydro">
                </div>
                <button id="filter-hydro">
                    <i data-feather="search" class="feather-icon"></i> Filtra
                </button>
                <button id="export-hydro-data">
                    <i data-feather="download" class="feather-icon"></i> Esporta CSV
                </button>
            </div>

            <div class="chart-wrapper">
                <div class="chart-header">
                    <span class="chart-title">Andamento Storico Livelli</span>
                    <div class="chart-actions">
                        <button class="chart-btn" id="download-hydro-chart">
                            <i data-feather="camera" class="feather-icon"></i> Scarica
                        </button>
                        <button class="chart-btn" id="fullscreen-hydro">
                            <i data-feather="maximize" class="feather-icon"></i> Fullscreen
                        </button>
                    </div>
                </div>
                <div class="chart-container card" id="hydroHistoryChart-container">
                    <canvas id="hydroHistoryChart"></canvas>
                </div>
            </div>
        </section>

        <!-- PLUVIOMETRI PAGE -->
        <section id="pluviometri" class="page-section">
            <h1><i data-feather="cloud-rain" class="feather-icon"></i> Pluviometri - Monitoraggio Precipitazioni</h1>
            
            <div class="data-groups-container">
                <div class="data-group">
                    <h3 class="group-title">Intensità Pioggia Attuale</h3>
                    <div class="stats-container">
                        <div class="stat-card" id="rain-arcevia">
                            <div class="title">Arcevia</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                        <div class="stat-card" id="rain-barbara">
                            <div class="title">Barbara</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                        <div class="stat-card" id="rain-corinaldo">
                            <div class="title">Corinaldo</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                        <div class="stat-card" id="rain-misa">
                            <div class="title">Misa</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                        <div class="stat-card" id="rain-montignano">
                            <div class="title">Montignano</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                        <div class="stat-card" id="rain-santangelo">
                            <div class="title">S.Angelo</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                        <div class="stat-card" id="rain-scapezzano">
                            <div class="title">Scapezzano</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                        <div class="stat-card" id="rain-senigallia">
                            <div class="title">Senigallia</div>
                            <div class="value">--<span class="unit">mm/hr</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-container">
                <div class="filter-group">
                    <label>Filtri Rapidi</label>
                    <div class="quick-filters" id="quick-filters-rain">
                        <button class="quick-filter-btn" data-hours="6">6 ore</button>
                        <button class="quick-filter-btn active" data-hours="12">12 ore</button>
                        <button class="quick-filter-btn" data-hours="24">24 ore</button>
                        <button class="quick-filter-btn" data-hours="72">3 giorni</button>
                        <button class="quick-filter-btn" data-hours="168">7 giorni</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="start-time-rain">Da:</label>
                    <input type="datetime-local" id="start-time-rain">
                </div>
                <div class="filter-group">
                    <label for="end-time-rain">A:</label>
                    <input type="datetime-local" id="end-time-rain">
                </div>
                <button id="filter-rain">
                    <i data-feather="search" class="feather-icon"></i> Filtra
                </button>
                <button id="export-rain-data">
                    <i data-feather="download" class="feather-icon"></i> Esporta CSV
                </button>
                
                <div style="width: 100%; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">Seleziona Stazioni:</label>
                    <div class="checkbox-container" id="station-selection-rain">
                        <label><input type="checkbox" name="station-rain" value="Arcevia - Pioggia TOT Oggi (mm)" checked> Arcevia</label>
                        <label><input type="checkbox" name="station-rain" value="Barbara - Pioggia TOT Oggi (mm)" checked> Barbara</label>
                        <label><input type="checkbox" name="station-rain" value="Corinaldo - Pioggia TOT Oggi (mm)" checked> Corinaldo</label>
                        <label><input type="checkbox" name="station-rain" value="Misa - Pioggia TOT Oggi (mm)" checked> Misa</label>
                        <label><input type="checkbox" name="station-rain" value="Montignano - Pioggia Giornaliera (mm)" checked> Montignano</label>
                        <label><input type="checkbox" name="station-rain" value="Sant'Angelo - Pioggia Giornaliera (mm)" checked> Sant'Angelo</label>
                        <label><input type="checkbox" name="station-rain" value="Scapezzano - Pioggia Giornaliera (mm)" checked> Scapezzano</label>
                        <label><input type="checkbox" name="station-rain" value="Senigallia - Pioggia TOT Oggi (mm)" checked> Senigallia</label>
                    </div>
                </div>
            </div>

            <div class="chart-wrapper">
                <div class="chart-header">
                    <span class="chart-title">Andamento Storico Pioggia Cumulata</span>
                    <div class="chart-actions">
                        <button class="chart-btn" id="download-rain-chart">
                            <i data-feather="camera" class="feather-icon"></i> Scarica
                        </button>
                        <button class="chart-btn" id="fullscreen-rain">
                            <i data-feather="maximize" class="feather-icon"></i> Fullscreen
                        </button>
                    </div>
                </div>
                <div class="chart-container card" id="rainHistoryChart-container">
                    <canvas id="rainHistoryChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ANEMOMETRI PAGE -->
        <section id="anemometri" class="page-section">
            <h1><i data-feather="wind" class="feather-icon"></i> Anemometri - Monitoraggio Vento</h1>
            
            <div class="data-groups-container">
                <div class="wind-bar-widget">
                    <h3 class="widget-title">Montignano</h3>
                    <div class="bar-section">
                        <div class="bar-label">
                            <span>Velocità Vento</span>
                            <span class="bar-value" id="speed-value-montignano">-- km/h</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill wind" id="speed-bar-montignano"></div>
                        </div>
                    </div>
                    <div class="bar-section">
                        <div class="bar-label">
                            <span>Raffica Max</span>
                            <span class="bar-value" id="gust-value-montignano">-- km/h</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill gust" id="gust-bar-montignano"></div>
                        </div>
                    </div>
                </div>

                <div class="wind-bar-widget">
                    <h3 class="widget-title">Sant'Angelo</h3>
                    <div class="bar-section">
                        <div class="bar-label">
                            <span>Velocità Vento</span>
                            <span class="bar-value" id="speed-value-santangelo">-- km/h</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill wind" id="speed-bar-santangelo"></div>
                        </div>
                    </div>
                    <div class="bar-section">
                        <div class="bar-label">
                            <span>Raffica Max</span>
                            <span class="bar-value" id="gust-value-santangelo">-- km/h</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill gust" id="gust-bar-santangelo"></div>
                        </div>
                    </div>
                </div>

                <div class="wind-bar-widget">
                    <h3 class="widget-title">Scapezzano</h3>
                    <div class="bar-section">
                        <div class="bar-label">
                            <span>Velocità Vento</span>
                            <span class="bar-value" id="speed-value-scapezzano">-- km/h</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill wind" id="speed-bar-scapezzano"></div>
                        </div>
                    </div>
                    <div class="bar-section">
                        <div class="bar-label">
                            <span>Raffica Max</span>
                            <span class="bar-value" id="gust-value-scapezzano">-- km/h</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill gust" id="gust-bar-scapezzano"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-container">
                <div class="filter-group">
                    <label>Filtri Rapidi</label>
                    <div class="quick-filters" id="quick-filters-wind">
                        <button class="quick-filter-btn" data-hours="6">6 ore</button>
                        <button class="quick-filter-btn active" data-hours="12">12 ore</button>
                        <button class="quick-filter-btn" data-hours="24">24 ore</button>
                        <button class="quick-filter-btn" data-hours="72">3 giorni</button>
                        <button class="quick-filter-btn" data-hours="168">7 giorni</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="start-time-wind">Da:</label>
                    <input type="datetime-local" id="start-time-wind">
                </div>
                <div class="filter-group">
                    <label for="end-time-wind">A:</label>
                    <input type="datetime-local" id="end-time-wind">
                </div>
                <div class="filter-group">
                    <label for="station-selection-wind">Stazione:</label>
                    <select id="station-selection-wind">
                        <option value="Montignano" selected>Montignano</option>
                        <option value="Sant'Angelo">Sant'Angelo</option>
                        <option value="Scapezzano">Scapezzano</option>
                    </select>
                </div>
                <button id="filter-wind">
                    <i data-feather="search" class="feather-icon"></i> Filtra
                </button>
                <button id="export-wind-data">
                    <i data-feather="download" class="feather-icon"></i> Esporta CSV
                </button>
            </div>

            <div class="chart-wrapper">
                <div class="chart-header">
                    <span class="chart-title">Andamento Storico Vento</span>
                    <div class="chart-actions">
                        <button class="chart-btn" id="download-wind-chart">
                            <i data-feather="camera" class="feather-icon"></i> Scarica
                        </button>
                        <button class="chart-btn" id="fullscreen-wind">
                            <i data-feather="maximize" class="feather-icon"></i> Fullscreen
                        </button>
                    </div>
                </div>
                <div class="chart-container card" id="windHistoryChart-container">
                    <canvas id="windHistoryChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ANALISI PAGE -->
        <section id="analisi" class="page-section">
            <h1><i data-feather="bar-chart-2" class="feather-icon"></i> Analisi Avanzata</h1>
            
            <div class="data-groups-container">
                <div class="card">
                    <h3 style="color: var(--primary-color); margin-top: 0;">📈 Statistiche Idrometri (Ultime 24h)</h3>
                    <table class="stats-table" id="hydro-stats-table">
                        <thead>
                            <tr>
                                <th>Stazione</th>
                                <th>Minimo (m)</th>
                                <th>Massimo (m)</th>
                                <th>Media (m)</th>
                                <th>Variazione</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align: center; color: var(--text-muted);">Caricamento dati...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <h3 style="color: var(--primary-color); margin-top: 0;">💨 Statistiche Anemometri (Ultime 24h)</h3>
                    <table class="stats-table" id="wind-stats-table">
                        <thead>
                            <tr>
                                <th>Stazione</th>
                                <th>Velocità Media (km/h)</th>
                                <th>Raffica Max (km/h)</th>
                                <th>Direzione Prevalente</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4" style="text-align: center; color: var(--text-muted);">Caricamento dati...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- MAPPA PAGE -->
        <section id="mappa" class="page-section">
            <h1><i data-feather="map" class="feather-icon"></i> Mappa delle Stazioni di Monitoraggio</h1>
            
            <div class="card">
                <h3 style="color: var(--primary-color); margin-top: 0;">Posizione Geografica delle Stazioni</h3>
                <p style="color: var(--text-muted); margin-bottom: 15px;">
                    Clicca sui marker per visualizzare informazioni dettagliate e navigare alla sezione specifica della stazione.
                </p>
                <div id="map-container"></div>
            </div>

            <div class="data-groups-container" style="margin-top: 25px;">
                <div class="card">
                    <h3 style="color: var(--primary-color); margin-top: 0;">
                        <span class="legend-icon circle"></span> Stazioni Idrometriche
                    </h3>
                    <ul style="color: var(--text-color); line-height: 1.8;">
                        <li>Serra dei Conti - Livello Misa</li>
                        <li>Pianello di Ostra - Livello Misa</li>
                        <li>Corinaldo/Nevola - Livello Nevola</li>
                        <li>Misa (Bettolelle) - Livello Misa</li>
                        <li>Ponte Garibaldi - Livello Misa 2</li>
                        <li>Passo Ripe - Livello Nevola</li>
                        <li>Foce Cesano - Livello Cesano</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h3 style="color: var(--primary-color); margin-top: 0;">
                        <span class="legend-icon triangle"></span> Stazioni Pluviometriche e Meteo
                    </h3>
                    <ul style="color: var(--text-color); line-height: 1.8;">
                        <li>Arcevia - Intensità Pioggia</li>
                        <li>Barbara - Intensità Pioggia</li>
                        <li>Corinaldo - Intensità Pioggia</li>
                        <li>Senigallia - Intensità Pioggia</li>
                        <li>Montignano (WeatherLink) - Pioggia/Vento</li>
                        <li>Scapezzano (WeatherLink) - Pioggia/Vento</li>
                        <li>Sant'Angelo (WeatherLink) - Pioggia/Vento</li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-feather="download" class="feather-icon"></i> Esporta Dati
                </h2>
                <button class="modal-close" id="close-export-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="modal-option" id="export-current-view">
                    <h4 style="margin: 0 0 5px 0;">
                        <i data-feather="bar-chart-2" class="feather-icon"></i> Vista Corrente
                    </h4>
                    <p style="margin: 0; font-size: 0.9em; color: var(--text-muted);">Esporta i dati della sezione attualmente visualizzata</p>
                </div>
                <div class="modal-option" id="export-all-data">
                    <h4 style="margin: 0 0 5px 0;">
                        <i data-feather="package" class="feather-icon"></i> Tutti i Dati
                    </h4>
                    <p style="margin: 0; font-size: 0.9em; color: var(--text-muted);">Esporta l'intero dataset disponibile</p>
                </div>
                <div class="modal-option" id="export-custom">
                    <h4 style="margin: 0 0 5px 0;">
                        <i data-feather="settings" class="feather-icon"></i> Personalizzato
                    </h4>
                    <p style="margin: 0; font-size: 0.9em; color: var(--text-muted);">Seleziona periodo e stazioni specifiche</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i data-feather="settings" class="feather-icon"></i> Impostazioni
                </h2>
                <button class="modal-close" id="close-settings-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <h4>🌧️ Soglie Pluviometriche</h4>
                    <div class="settings-item">
                        <span>Allerta (mm/h):</span>
                        <input type="number" id="threshold-rain-warning" step="5" min="0">
                    </div>
                    <div class="settings-item">
                        <span>Critica (mm/h):</span>
                        <input type="number" id="threshold-rain-critical" step="5" min="0">
                    </div>
                </div>

                <div class="settings-group">
                    <h4>💨 Soglie Anemometriche</h4>
                    <div class="settings-item">
                        <span>Allerta (km/h):</span>
                        <input type="number" id="threshold-wind-warning" step="5" min="0">
                    </div>
                    <div class="settings-item">
                        <span>Critica (km/h):</span>
                        <input type="number" id="threshold-wind-critical" step="5" min="0">
                    </div>
                </div>

                <div class="settings-group">
                    <h4>💧 Soglie Idrometriche</h4>
                    <div id="hydro-thresholds-settings">
                        <!-- Le soglie verranno popolate dinamicamente qui -->
                    </div>
                </div>

                <div class="settings-group">
                    <h4>🎨 Personalizzazione Tema</h4>
                    <div class="settings-item">
                        <label for="theme-toggle">Modalità Scura</label>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <label for="primary-color-picker">Colore Primario</label>
                        <input type="color" id="primary-color-picker">
                    </div>
                </div>

                <div class="settings-group">
                    <h4>🔄 Aggiornamento Automatico</h4>
                    <div class="settings-item">
                        <span>Intervallo dati (secondi):</span>
                        <input type="number" id="update-interval-data" step="10" min="10">
                    </div>
                    <div class="settings-item">
                        <span>Intervallo previsioni (secondi):</span>
                        <input type="number" id="update-interval-forecast" step="30" min="30">
                    </div>
                </div>
                <div class="settings-group">
                    <h4>📊 Aggiornamenti Grafici</h4>
                    <div class="settings-item">
                        <label>
                            <input type="checkbox" id="auto-refresh-charts" checked>
                            Rigenera grafici automaticamente
                        </label>
                        <small>Aggiorna i grafici ad ogni ciclo di refresh</small>
                    </div>
                    <div class="settings-item">
                        <label>
                            <input type="checkbox" id="update-only-active-chart" checked>
                            Aggiorna solo grafico visibile
                        </label>
                        <small>Migliora le performance aggiornando solo il grafico attivo</small>
                    </div>
                </div>

                <!-- Nel modal delle impostazioni, dopo gli intervalli esistenti --> 
                <div class="settings-section"> 
                    <h3>⚙️ Impostazioni Avanzate</h3> 
                    <div class="setting-item"> 
                        <label for="fetch-timeout">Timeout richieste (secondi)</label> 
                        <input type="number" id="fetch-timeout" min="5" max="60" value="15"> 
                        <small>Tempo massimo di attesa per ogni richiesta</small> 
                    </div> 
                    <div class="setting-item"> 
                        <label for="max-retries">Numero di tentativi</label> 
                        <input type="number" id="max-retries" min="1" max="5" value="3"> 
                        <small>Quante volte riprovare in caso di errore</small> 
                    </div> 
                    <div class="setting-item"> 
                        <label> <input type="checkbox" id="prevent-overlap" checked> 
                        Previeni sovrapposizione aggiornamenti </label> 
                        <small>Salta un ciclo se il precedente è ancora in corso</small> 
                    </div> 
                </div>

                <button class="filter-container button" id="save-settings-btn" style="width: 100%; margin-top: 20px; justify-content: center;">
                    <i data-feather="save" class="feather-icon" style="width: 16px; height: 16px;"></i> Salva Impostazioni
                </button>
            </div>
        </div>
    </div>

    <audio id="alert-sound" preload="auto">
        <source src="suoni/suono_notifica_allarme.mp3" type="audio/mpeg">
        <source src="suoni/suono_notifica_allarme.ogg" type="audio/ogg">
        <source src="suoni/suono_notifica_allarme.wav" type="audio/wav">
        Il tuo browser non supporta l'elemento audio.
    </audio>

    <script>
document.addEventListener('DOMContentLoaded', () => {
const PWD_HASH = 'b8dffa399635231e7b7038b2a64d576374982ebb2b858fe721ee7f6f8ff697a9';

const loginOverlay = document.getElementById('login-overlay');
const passwordInput = document.getElementById('password-input');
const loginButton = document.getElementById('login-button');
const errorMessage = document.getElementById('error-message');
const appContainer = document.getElementById('app-container');

async function checkPassword() {
const enteredPassword = passwordInput.value;
if (!enteredPassword) { errorMessage.textContent = 'Inserisci una password.'; return; }

loginButton.disabled = true;
loginButton.textContent = 'Verifico...';

try {
const encoder = new TextEncoder();
const data = encoder.encode(enteredPassword);
const hashBuffer = await crypto.subtle.digest('SHA-256', data);
const hashArray = Array.from(new Uint8Array(hashBuffer));
const enteredHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

if (enteredHash === PWD_HASH) {
loginOverlay.style.opacity = '0';
loginOverlay.style.visibility = 'hidden';
setTimeout(() => {
loginOverlay.remove();
appContainer.classList.remove('content-hidden');
// Chiamata alla funzione che avvia la dashboard
initializeDashboard();
}, 500);
} else {
errorMessage.textContent = 'Password non corretta. Riprova.';
passwordInput.value = '';
passwordInput.focus();
loginButton.disabled = false;
loginButton.textContent = 'Accedi';
}
} catch (e) {
errorMessage.textContent = 'Errore durante la verifica.';
loginButton.disabled = false;
loginButton.textContent = 'Accedi';
}
}

loginButton.addEventListener('click', checkPassword);
passwordInput.addEventListener('keyup', (event) => {
errorMessage.textContent = '';
if (event.key === 'Enter') { checkPassword(); }
});

passwordInput.focus();
});
        // ==================== CONFIGURATION ====================
        // Costanti UI
        const UI_CONSTANTS = {
            MOBILE_BREAKPOINT: 768,
            DEBOUNCE_DELAY: 250,
            TOAST_DURATION: 5000,
            FADE_DURATION: 300,
            PULL_THRESHOLD: 100,
            SWIPE_THRESHOLD: 50
        };

        // Costanti Mappa
        const MAP_CONSTANTS = {
            CENTER_LAT: 43.63,
            CENTER_LON: 13.10,
            DEFAULT_ZOOM: 11,
            ICON_SIZE_DESKTOP: 50,
            ICON_SIZE_MOBILE: 60
        };

        // Messaggi Errore
        const ERROR_MESSAGES = {
            FETCH_FAILED: 'Errore nel caricamento dei dati',
            CHART_ERROR: 'Errore nella creazione del grafico',
            PARSE_ERROR: 'Errore nell\'elaborazione dei dati',
            NO_DATA: 'Nessun dato disponibile'
        };

        // === UTILITY FUNCTIONS ===
        const utils = {
            // Controlla se siamo su mobile
            isMobile: () => window.innerWidth <= UI_CONSTANTS.MOBILE_BREAKPOINT,
            
            // Formatta numeri con fallback
            formatNumber: (value, decimals = 2, fallback = 'N/D') => {
                const num = parseAndFixDecimal(value);
                return isNaN(num) ? fallback : num.toFixed(decimals);
            },
            
            // Debounce generico
            debounce: (func, delay) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, delay);
                };
            },
            
            // Sleep helper
            sleep: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
            
            // Controlla se un valore è valido
            isValidValue: (value) => {
                return value !== null && 
                       value !== undefined && 
                       value !== 'N/A' && 
                       value !== '' && 
                       !isNaN(parseAndFixDecimal(value));
            }
        };

        // Sistema di logging
        const LOG = {
            errors: [],
            warnings: [],
            
            error: (message, data) => {
                const entry = {
                    type: 'error',
                    message,
                    data,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                };
                LOG.errors.push(entry);
                console.error('🔴 ERROR:', entry);
                
                // Mantieni solo ultimi 50 errori
                if (LOG.errors.length > 50) {
                    LOG.errors.shift();
                }
            },
            
            warn: (message, data) => {
                const entry = {
                    type: 'warning',
                    message,
                    data,
                    timestamp: new Date().toISOString()
                };
                LOG.warnings.push(entry);
                console.warn('🟡 WARNING:', entry);
            },
            
            // Esporta log per debug
            export: () => {
                const blob = new Blob([JSON.stringify({
                    errors: LOG.errors,
                    warnings: LOG.warnings,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                }, null, 2)], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `dashboard-log-${Date.now()}.json`;
                link.click();
            }
        };

        // Cattura errori globali
        window.addEventListener('error', (e) => {
            LOG.error('Uncaught error', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno
            });
        });

        window.addEventListener('unhandledrejection', (e) => {
            LOG.error('Unhandled promise rejection', {
                reason: e.reason,
                promise: e.promise
            });
        });

        function fetchDataWithTimeout(url, timeout = CONFIG.advanced.fetchTimeout) {
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error(`Timeout: la richiesta a ${url} ha impiegato più di ${timeout}ms`));
                }, timeout);
                Papa.parse(`${url}&t=${Date.now()}`, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        clearTimeout(timeoutId);
                        resolve(results.data);
                    },
                    error: function(error) {
                        clearTimeout(timeoutId);
                        reject(error);
                    }
                });
            });
        }

        async function executeWithRetry(fn, context = 'operazione', maxRetries = CONFIG.advanced.maxRetries) {
            let lastError;
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const result = await fn();
                    if (STATE.updateStats.consecutiveErrors > 0) {
                        console.log(`✅ ${context} ripristinata dopo ${STATE.updateStats.consecutiveErrors} errori`);
                        STATE.updateStats.consecutiveErrors = 0;
                    }
                    return result;
                } catch (error) {
                    lastError = error;
                    console.warn(`⚠️ Tentativo ${attempt}/${maxRetries} fallito per ${context}:`, error.message);
                    if (attempt < maxRetries) {
                        const delay = CONFIG.advanced.retryDelay * Math.pow(2, attempt - 1);
                        console.log(`⏳ Riprovo tra ${delay}ms...`);
                        await utils.sleep(delay);
                    }
                }
            }
            STATE.updateStats.consecutiveErrors++;
            STATE.updateStats.lastError = new Date();
            throw new Error(`${context} fallita dopo ${maxRetries} tentativi: ${lastError.message}`);
        }

        // Configurazione di base, può essere sovrascritta dalle impostazioni salvate
        let CONFIG = {
            urls: {
                forecast: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=752084732&single=true&output=csv',
                forecastBettolelle3h: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=879704541&single=true&output=csv',
                forecastPonteGaribaldi6h: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=2110898760&single=true&output=csv',
                regionLatest: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=754529338&single=true&output=csv',
                weatherlinkLatest: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=377471478&single=true&output=csv',
                regionHistory: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=164189198&single=true&output=csv',
                weatherlinkHistory: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=277108921&single=true&output=csv',
                alertsToday: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=62264278&single=true&output=csv',
                alertsTomorrow: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQRYZz5cm8M6XWpz9aFh62Pw-2q-7pIpViKFV_Zv4qlJMWYTQwg2zMW9L1U_s3QfPdrQtNPvmD8cBUx/pub?gid=903050518&single=true&output=csv'
            },
            intervals: {
                dataUpdate: 300000,      // 1 minuto
                forecastUpdate: 300000  // 5 minuti
            },
            defaults: {
                timeWindow: 12,         // ore
                gaugeMaxSpeed: 80,      // km/h
                chartColors: ['#00bcd4', '#ffc107', '#9c27b0', '#f44336', '#4caf50', '#ff9800', '#3f51b5', '#e91e63']
            },
            thresholds: {
                hydroWarning: 2.0,      // metri - DEPRECATED
                hydroCritical: 3.0,     // metri - DEPRECATED
                hydroThresholds: {
                    'Serra dei Conti': { warning: 1.2, critical: 1.7 },
                    'Pianello di Ostra': { warning: 1.5, critical: 2.0 },
                    'Nevola': { warning: 2.0, critical: 2.5 },
                    'Passo Ripe': { warning: 1.0, critical: 1.2 },
                    'Misa (Bettolelle)': { warning: 1.8, critical: 2.0 },
                    'Ponte Garibaldi': { warning: 1.5, critical: 2.2 },
                    'Cesano': { warning: 0.5, critical: 1.0 },
                    'Foce Cesano': { warning: 1.3, critical: 1.5 }
                },
                rainWarning: 20,        // mm/h
                rainCritical: 40,       // mm/h
                windWarning: 40,        // km/h
                windCritical: 60        // km/h
            },
            advanced: {
                fetchTimeout: 15000,
                maxRetries: 3,
                retryDelay: 2000,
                preventOverlap: true
            },
            chartUpdates: {
                autoRefresh: true,
                onlyActiveChart: true
            }
        };

        // ==================== GLOBAL STATE ====================
        const STATE = {
            regionHistoryData: [],
            weatherlinkHistoryData: [],
            regionLatestData: null,
            weatherlinkLatestData: null,
            forecastData: [],
            // NUOVO: flag per controllare quando rigenerare i grafici
            lastHistoricalUpdate: null,
            needsChartUpdate: false,
            forecastDataBettolelle3h: [],
            forecastDataPonteGaribaldi6h: [],
            map: null,
            dashboardMap: null,
            mapMarkers: {},
            dashboardMapMarkers: {},
            charts: {
                forecast: null,
                forecastBettolelle3h: null,
                forecastPonteGaribaldi6h: null,
                hydroHistory: null,
                rainHistory: null,
                windHistory: null,
                overviewHydro: null,
                overviewRain: null
            },
            currentHighlightedIndex: -1,
            lastUpdate: null,
            isOnline: true,
            alerts: [],
            hasActiveAlerts: false,
            updateIntervals: {
                data: null,
                forecast: null
            },
            countdownInterval: null,
            officialAlerts: null,
            isUpdating: {
                data: false,
                forecast: false
            },
            updateStats: {
                lastSuccess: null,
                lastError: null,
                consecutiveErrors: 0
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        function parseAndFixDecimal(value) {
            if (value === null || value === undefined || value === 'N/A' || String(value).trim() === '') return NaN;
            return parseFloat(String(value).replace(',', '.'));
        }

        /**
         * BUG FIX: La funzione originale per il parsing della data era poco robusta
         * e falliva con alcuni formati di orario, causando la sparizione dei dati
         * nelle ore mattutine. Questa nuova versione è molto più affidabile.
         */
        function parseCustomDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;

            // Pulisce la stringa, sostituendo i punti con due punti nell'orario (es. 10.45 -> 10:45)
            const cleanedString = dateString.trim().replace(/(\d{1,2})\.(\d{2})$/, '$1:$2');

            // Regex per catturare i componenti della data nel formato GG/MM/AAAA HH:MM(:SS)
            const match = cleanedString.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?/);

            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10);
                const year = parseInt(match[3], 10);
                const hour = parseInt(match[4], 10);
                const minute = parseInt(match[5], 10);
                const second = match[6] ? parseInt(match[6], 10) : 0;

                // Crea l'oggetto Date. NOTA: il mese è 1-based (da 1 a 12) nel regex, 
                // ma 0-based (da 0 a 11) nel costruttore Date di JavaScript.
                const date = new Date(year, month - 1, day, hour, minute, second);

                // Valida la data creata per scartare input non validi (es. 31/02/2024),
                // che JavaScript altrimenti convertirebbe in una data valida di Marzo.
                // Controlliamo che i componenti della data costruita corrispondano a quelli letti.
                if (date.getFullYear() === year &&
                    date.getMonth() === month - 1 &&
                    date.getDate() === day &&
                    !isNaN(date.getTime())) {
                    return date;
                }
            }

            // Se il parsing fallisce, avvisa in console. La vecchia funzione falliva silenziosamente.
            // console.warn(`Impossibile analizzare la data: "${dateString}"`); // Abilitare per debug
            
            // Fallback: prova formato ISO standard
            try {
                const isoDate = new Date(dateString);
                if (!isNaN(isoDate.getTime())) {
                    console.warn(`Data parsata con fallback ISO: ${dateString}`);
                    return isoDate;
                }
            } catch (e) {
                // Ignora
            }
            
            console.error(`⚠️ Impossibile parsare la data: "${dateString}"`);
            return null;
        }


        function formatDateTime(date) {
            if (!date) return '--:--';
            const pad = (n) => String(n).padStart(2, '0');
            return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }
        
        function toISOLocal(date) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function filterDataByTime(data, timeColumn, start, end) {
            const startTime = start ? new Date(start).getTime() : null;
            const endTime = end ? new Date(end).getTime() : null;
            
            if (startTime || endTime) {
                return data.filter(r => {
                    const d = parseCustomDate(r[timeColumn]);
                    if (!d) return false;
                    const t = d.getTime();
                    if (startTime && t < startTime) return false;
                    if (endTime && t > endTime) return false;
                    return true;
                });
            }
            
            const now = new Date();
            const defaultStart = now.getTime() - CONFIG.defaults.timeWindow * 3600000;
            return data.filter(r => {
                const d = parseCustomDate(r[timeColumn]);
                return d ? d.getTime() >= defaultStart : false;
            });
        }


        function calculateStats(values) {
            const validValues = values.filter(v => !isNaN(v) && v !== null);
            if (validValues.length === 0) return { min: NaN, max: NaN, avg: NaN, sum: NaN };
            
            const sum = validValues.reduce((a, b) => a + b, 0);
            return {
                min: Math.min(...validValues),
                max: Math.max(...validValues),
                avg: sum / validValues.length,
                sum: sum
            };
        }

        function getAlertLevel(value, warningThreshold, criticalThreshold) {
            if (isNaN(value)) return 'normal';
            if (value >= criticalThreshold) return 'critical';
            if (value >= warningThreshold) return 'warning';
            return 'normal';
        }

        // ==================== UI FUNCTIONS ====================
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close">×</button>
            `;
            
            container.appendChild(toast);
            
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function updateLastUpdate() {
            STATE.lastUpdate = new Date();
            document.getElementById('last-update').textContent = `Ultimo aggiornamento: ${formatDateTime(STATE.lastUpdate)}`;
            
            startUpdateCountdown();
        }

        function startUpdateCountdown() {
            if (STATE.countdownInterval) {
                clearInterval(STATE.countdownInterval);
            }
            
            const nextUpdateElement = document.getElementById('next-update');
            const updateIntervalMs = CONFIG.intervals.dataUpdate;
            const nextUpdateTime = new Date(STATE.lastUpdate.getTime() + updateIntervalMs);
            
            STATE.countdownInterval = setInterval(function() {
                const now = new Date();
                const remainingMs = nextUpdateTime - now;
                
                if (remainingMs <= 0) {
                    nextUpdateElement.textContent = 'Prossimo aggiornamento: in corso...';
                    clearInterval(STATE.countdownInterval);
                    return;
                }
                
                const remainingSeconds = Math.floor(remainingMs / 1000);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                
                nextUpdateElement.innerHTML = `Prossimo aggiornamento: <strong>${minutes}:${String(seconds).padStart(2, '0')}</strong>`;
            }, 1000);
        }

        function updateConnectionStatus(online) {
            STATE.isOnline = online;
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (online) {
                dot.className = 'status-dot online';
                text.textContent = 'Online';
            } else {
                dot.className = 'status-dot offline';
                text.textContent = 'Offline';
            }
        }

        function updateStatCard(cardId, value, unit, fallback = '--') {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const valueEl = card.querySelector('.value');
            let finalValue = fallback;
            const numValue = parseAndFixDecimal(value);
            
            if (!isNaN(numValue)) {
                finalValue = numValue.toFixed(2);
            }
            
            const unitEl = valueEl.querySelector('.unit');
            if (unitEl) {
                unitEl.textContent = unit;
                valueEl.firstChild.nodeValue = finalValue;
            }
        }

        function updateWindBar(station, speed, gust) {
            const cleanSpeed = parseAndFixDecimal(speed) || 0;
            const cleanGust = parseAndFixDecimal(gust) || 0;
            
            document.getElementById(`speed-value-${station}`).textContent = `${cleanSpeed.toFixed(1)} km/h`;
            document.getElementById(`gust-value-${station}`).textContent = `${cleanGust.toFixed(1)} km/h`;
            
            const speedPercent = (Math.min(cleanSpeed, CONFIG.defaults.gaugeMaxSpeed) / CONFIG.defaults.gaugeMaxSpeed) * 100;
            const gustPercent = (Math.min(cleanGust, CONFIG.defaults.gaugeMaxSpeed) / CONFIG.defaults.gaugeMaxSpeed) * 100;
            
            document.getElementById(`speed-bar-${station}`).style.width = `${speedPercent}%`;
            document.getElementById(`gust-bar-${station}`).style.width = `${gustPercent}%`;
        }

        /** * Mostra errore di aggiornamento all'utente */ 
        function showUpdateError(type) { 
            const errorBadge = document.getElementById('update-status-badge'); 
            if (!errorBadge) { 
                // Crealo se non esiste 
                const badge = document.createElement('span'); 
                badge.id = 'update-status-badge'; 
                badge.className = 'update-error-badge'; 
                badge.innerHTML = '⚠️ Errore aggiornamento'; 
                badge.title = `Problemi nell'aggiornamento ${type}. Riproverò automaticamente.`; 
                const lastUpdateEl = document.getElementById('last-update'); 
                if (lastUpdateEl) { 
                    lastUpdateEl.parentNode.insertBefore(badge, lastUpdateEl.nextSibling); 
                } 
            } // Rimuovi il badge dopo 10 secondi se tutto torna normale 
            setTimeout(() => { 
                if (STATE.updateStats.consecutiveErrors === 0) { 
                    errorBadge?.remove(); 
                } 
            }, 10000); 
        }

        /** * Indicatore di caricamento durante aggiornamento */ 
        function showLoadingIndicator(show = true) { 
            let indicator = document.getElementById('loading-indicator'); 
            if (show) { 
                if (!indicator) { 
                    indicator = document.createElement('div'); 
                    indicator.id = 'loading-indicator'; 
                    indicator.className = 'loading-pulse'; 
                    indicator.innerHTML = '<span class="pulse-dot"></span> Aggiornamento in corso...'; 
                    const header = document.querySelector('.dashboard-header'); 
                    if (header) { 
                        header.appendChild(indicator); 
                    } 
                } 
                indicator.style.display = 'flex'; 
            } else { 
                if (indicator) { 
                    indicator.style.display = 'none'; 
                } 
            } 
        }

        // ==================== ALERT SYSTEM ====================
        function checkAlerts() {
            STATE.alerts = [];

            if (!STATE.regionLatestData || !STATE.weatherlinkLatestData) return;

            const region = STATE.regionLatestData;
            const weather = STATE.weatherlinkLatestData;

            // Check hydro levels
            const hydroStations = [
                { name: 'Misa (Bettolelle)', value: parseAndFixDecimal(region['Misa - Livello Misa (mt)']) },
                { name: 'Pianello di Ostra', value: parseAndFixDecimal(region['Pianello di Ostra - Livello Misa (mt)']) },
                { name: 'Ponte Garibaldi', value: parseAndFixDecimal(region['Ponte Garibaldi - Livello Misa 2 (mt)']) },
                { name: 'Serra dei Conti', value: parseAndFixDecimal(region['Serra dei Conti - Livello Misa (mt)']) },
                { name: 'Foce Cesano', value: parseAndFixDecimal(region['Foce Cesano - Livello Cesano (mt)']) },
                { name: 'Cesano', value: parseAndFixDecimal(region['Cesano - Livello Cesano (mt)']) },
                { name: 'Passo Ripe', value: parseAndFixDecimal(region['Passo Ripe - Livello Nevola (mt)']) },
                { name: 'Nevola', value: parseAndFixDecimal(region['Nevola - Livello Nevola (mt)']) }
            ];

            hydroStations.forEach(station => {
                if (isNaN(station.value)) return;
                const thresholds = CONFIG.thresholds.hydroThresholds[station.name] || { warning: 99, critical: 999 };
                const level = getAlertLevel(station.value, thresholds.warning, thresholds.critical);
                if (level !== 'normal') {
                    STATE.alerts.push({
                        type: 'hydro',
                        level: level,
                        station: station.name,
                        value: station.value,
                        message: `Livello idrometrico ${level === 'critical' ? 'CRITICO' : 'di ATTENZIONE'}: ${station.value.toFixed(2)} m`
                    });
                }
            });

            // Check rain intensity (convert mm/min to mm/h)
            const rainStations = [
                { name: 'Arcevia', value: parseAndFixDecimal(region['Arcevia - Intensita di pioggia (mm/min)']) * 60 },
                { name: 'Barbara', value: parseAndFixDecimal(region['Barbara - Intensita di pioggia (mm/min)']) * 60 },
                { name: 'Corinaldo', value: parseAndFixDecimal(region['Corinaldo - Intensita di pioggia (mm/min)']) * 60 },
                { name: 'Misa', value: parseAndFixDecimal(region['Misa - Intensita Pioggia (mm/min)']) * 60 },
                { name: 'Senigallia', value: parseAndFixDecimal(region['Senigallia - Intensita Pioggia (mm/min)']) * 60 },
                { name: 'Montignano', value: parseAndFixDecimal(weather['Montignano - Intensità Pioggia (mm/hr)']) },
                { name: "Sant'Angelo", value: parseAndFixDecimal(weather["Sant'Angelo - Intensità Pioggia (mm/hr)"]) },
                { name: 'Scapezzano', value: parseAndFixDecimal(weather['Scapezzano - Intensità Pioggia (mm/hr)']) }
            ];

            rainStations.forEach(station => {
                if (isNaN(station.value) || station.value <= 0) return;
                const level = getAlertLevel(station.value, CONFIG.thresholds.rainWarning, CONFIG.thresholds.rainCritical);
                if (level !== 'normal') {
                    STATE.alerts.push({
                        type: 'rain',
                        level: level,
                        station: station.name,
                        value: station.value,
                        message: `Intensità pioggia ${level === 'critical' ? 'CRITICA' : 'di ATTENZIONE'}: ${station.value.toFixed(1)} mm/h`
                    });
                }
            });

            // Check wind gusts
            const windStations = [
                { name: 'Montignano', value: parseAndFixDecimal(weather['Montignano - Raffica Vento 10 min (km/h)']) },
                { name: "Sant'Angelo", value: parseAndFixDecimal(weather["Sant'Angelo - Raffica Vento 10 min (km/h)"]) },
                { name: 'Scapezzano', value: parseAndFixDecimal(weather['Scapezzano - Raffica Vento 10 min (km/h)']) }
            ];

            windStations.forEach(station => {
                if (isNaN(station.value)) return;
                const level = getAlertLevel(station.value, CONFIG.thresholds.windWarning, CONFIG.thresholds.windCritical);
                if (level !== 'normal') {
                    STATE.alerts.push({
                        type: 'wind',
                        level: level,
                        station: station.name,
                        value: station.value,
                        message: `Raffica vento ${level === 'critical' ? 'CRITICA' : 'di ATTENZIONE'}: ${station.value.toFixed(1)} km/h`
                    });
                }
            });

            // Analisi dei dati di previsione
            if (STATE.forecastData && STATE.forecastData.length > 0) {
                let maxPredictedLevel = -Infinity;
                let peakTimestamp = null;
                const forecastColumn = 'Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)';

                STATE.forecastData.forEach(record => {
                    const level = parseAndFixDecimal(record[forecastColumn]);
                    if (!isNaN(level) && level > maxPredictedLevel) {
                        maxPredictedLevel = level;
                        peakTimestamp = record['Timestamp Previsione'];
                    }
                });

                if (maxPredictedLevel > -Infinity) {
                    const thresholds = CONFIG.thresholds.hydroThresholds['Misa (Bettolelle)'];
                    const forecastLevel = getAlertLevel(maxPredictedLevel, thresholds.warning, thresholds.critical);
                    if (forecastLevel !== 'normal') {
                        STATE.alerts.push({
                            type: 'hydro-forecast',
                            level: forecastLevel,
                            station: 'Misa (Bettolelle) - Previsione',
                            value: maxPredictedLevel,
                            message: `PREVISIONE DI ${forecastLevel === 'critical' ? 'CRITICITÀ' : 'ATTENZIONE'}: Previsto picco di ${maxPredictedLevel.toFixed(2)} m intorno alle ore ${peakTimestamp}`
                        });
                    }
                }
            }
   // Analisi Previsione Bettolelle 3h
    if (STATE.forecastDataBettolelle3h && STATE.forecastDataBettolelle3h.length > 0) {
        let maxPredictedLevel3h = -Infinity;
        let peakTimestamp3h = null;
        const forecastColumn3h = 'Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)';

        STATE.forecastDataBettolelle3h.forEach(record => {
            const level = parseAndFixDecimal(record[forecastColumn3h]);
            if (!isNaN(level) && level > maxPredictedLevel3h) {
                maxPredictedLevel3h = level;
                peakTimestamp3h = record['Timestamp Previsione'];
            }
        });

        if (maxPredictedLevel3h > -Infinity) {
            const thresholds = CONFIG.thresholds.hydroThresholds['Misa (Bettolelle)'];
            const forecastLevel = getAlertLevel(maxPredictedLevel3h, thresholds.warning, thresholds.critical);
            if (forecastLevel !== 'normal') {
                STATE.alerts.push({
                    type: 'hydro-forecast',
                    level: forecastLevel,
                    station: 'Misa (Bettolelle) - Previsione 3h',
                    value: maxPredictedLevel3h,
                    message: `PREVISIONE 3h DI ${forecastLevel === 'critical' ? 'CRITICITÀ' : 'ATTENZIONE'}: Previsto picco di ${maxPredictedLevel3h.toFixed(2)} m intorno alle ore ${peakTimestamp3h}`
                });
            }
        }
    }

    // Analisi Previsione Ponte Garibaldi 6h
    if (STATE.forecastDataPonteGaribaldi6h && STATE.forecastDataPonteGaribaldi6h.length > 0) {
        let maxPredictedLevel6h = -Infinity;
        let peakTimestamp6h = null;
        const forecastColumn6h = 'Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q50)';

        STATE.forecastDataPonteGaribaldi6h.forEach(record => {
            const level = parseAndFixDecimal(record[forecastColumn6h]);
            if (!isNaN(level) && level > maxPredictedLevel6h) {
                maxPredictedLevel6h = level;
                peakTimestamp6h = record['Timestamp Previsione'];
            }
        });

        if (maxPredictedLevel6h > -Infinity) {
            const thresholds = CONFIG.thresholds.hydroThresholds['Ponte Garibaldi'];
            const forecastLevel = getAlertLevel(maxPredictedLevel6h, thresholds.warning, thresholds.critical);
            if (forecastLevel !== 'normal') {
                STATE.alerts.push({
                    type: 'hydro-forecast',
                    level: forecastLevel,
                    station: 'Misa (Ponte Garibaldi) - Previsione 6h',
                    value: maxPredictedLevel6h,
                    message: `PREVISIONE 6h DI ${forecastLevel === 'critical' ? 'CRITICITÀ' : 'ATTENZIONE'}: Previsto picco di ${maxPredictedLevel6h.toFixed(2)} m intorno alle ore ${peakTimestamp6h}`
                });
            }
        }
    }
            updateAlertsDisplay();
        }

        function updateAlertsDisplay() {
            const alertSound = document.getElementById('alert-sound');
            const newAlertsPresent = STATE.alerts.length > 0;

            if (newAlertsPresent && !STATE.hasActiveAlerts) {
                alertSound.play().catch(error => console.error("Errore nella riproduzione del suono:", error));
                
                if ('Notification' in window && Notification.permission === 'granted') {
                    STATE.alerts.forEach(alert => {
                        if (alert.level === 'critical') {
                            new Notification('⚠️ ALLERTA CRITICA - Dashboard Meteo', {
                                body: `${alert.station}: ${alert.message}`,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23f44336" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
                                tag: `alert-${alert.type}-${alert.station}`,
                                requireInteraction: true,
                                badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23f44336"><circle cx="12" cy="12" r="10"/></svg>'
                            });
                        }
                    });
                }
            }

            STATE.hasActiveAlerts = newAlertsPresent;
            
            const container = document.getElementById('alerts-container');
            
            if (STATE.alerts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Nessuna allerta al momento</p>';
                return;
            }

            container.innerHTML = STATE.alerts.map(alert => {
                let icon = 'alert-triangle';
                if(alert.type.includes('hydro')) icon = 'droplet';
                if(alert.type.includes('rain')) icon = 'cloud-rain';
                if(alert.type.includes('wind')) icon = 'wind';

                return `
                <div class="alert-item ${alert.level}">
                    <div class="alert-icon">
                        ${alert.type === 'hydro-forecast' ? '<span style="font-weight: bold; color: var(--warning-color);">PREV</span>' : `<i data-feather="${icon}" class="feather-icon"></i>`}
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.station}</div>
                        <div class="alert-message">${alert.message}</div>
                    </div>
                    <div class="alert-time">${formatDateTime(STATE.lastUpdate)}</div>
                </div>
            `}).join('');
            
            feather.replace();
        }

        // ==================== OFFICIAL ALERTS FUNCTIONS ====================
        async function updateOfficialAlerts() {
            console.log('updateOfficialAlerts START');
            try {
                console.log('Fetching official alerts data...');
                const [todayData, tomorrowData] = await Promise.all([
                    fetchDataWithTimeout(CONFIG.urls.alertsToday),
                    fetchDataWithTimeout(CONFIG.urls.alertsTomorrow)
                ]);

                console.log('Official alerts data fetched:', { today: todayData?.length, tomorrow: tomorrowData?.length });

                const alertLevels = { 'Verde': 1, 'Gialla': 2, 'Arancione': 3, 'Rossa': 4 };
                const risks = ['idraulica', 'idrogeologica', 'mareggiate', 'neve', 'temporali', 'vento'];

                const processAlerts = (data) => {
                    const maxAlerts = {};
                    risks.forEach(risk => maxAlerts[risk] = 'Verde');

                    if (data && data.length > 0) {
                        for (const row of data) {
                            for (const risk of risks) {
                                const currentLevel = row[risk] || 'Verde';
                                if (alertLevels[currentLevel] > alertLevels[maxAlerts[risk]]) {
                                    maxAlerts[risk] = currentLevel;
                                }
                            }
                        }
                    }
                    return maxAlerts;
                };

                STATE.officialAlerts = {
                    today: processAlerts(todayData),
                    tomorrow: processAlerts(tomorrowData)
                };
                
                console.log('Processed alerts:', STATE.officialAlerts);

                updateOfficialAlertsCards(); // ← NUOVA FUNZIONE
                console.log('updateOfficialAlerts END');

            } catch (error) {
                console.error("Errore nel caricamento delle allerte regionali:", error);
                // Aggiorna le card con errore
                ['overview-alerts-today', 'overview-alerts-tomorrow'].forEach(id => {
                    const card = document.getElementById(id);
                    if (card) {
                        const valueEl = card.querySelector('.quick-stat-value');
                        const trendEl = card.querySelector('.quick-stat-trend span');
                        if (valueEl) valueEl.innerHTML = '✗';
                        if (trendEl) trendEl.textContent = 'Errore caricamento';
                    }
                });
            }
        }

        /**
         * Aggiorna le card delle allerte regionali in formato quick-stat
         */
        function updateOfficialAlertsCards() {
            console.log('updateOfficialAlertsCards START', STATE.officialAlerts);
            
            if (!STATE.officialAlerts) {
                console.warn('No official alerts data available');
                return;
            }

            // Configurazione rischi con icone
            const riskConfig = {
                idraulica: { icon: 'droplet', label: 'Idraulico' },
                idrogeologica: { icon: 'bar-chart-2', label: 'Idrogeologico' },
                temporali: { icon: 'cloud-lightning', label: 'Temporali' },
                vento: { icon: 'wind', label: 'Vento' }
            };

            // Funzione helper per processare un giorno
            const processDayAlerts = (dayAlerts, cardId) => {
                const card = document.getElementById(cardId);
                if (!card) return;

                // Conta le allerte per livello
                const alertLevels = { 'Verde': 1, 'Gialla': 2, 'Arancione': 3, 'Rossa': 4 };
                let maxLevel = 'Verde';
                let maxLevelValue = 0;
                const activeAlerts = []; // Allerte non verdi

                // Analizza ogni tipo di rischio
                Object.entries(dayAlerts).forEach(([risk, level]) => {
                    if (riskConfig[risk]) {
                        const levelValue = alertLevels[level] || 1;
                        
                        // Trova il livello massimo
                        if (levelValue > maxLevelValue) {
                            maxLevel = level;
                            maxLevelValue = levelValue;
                        }

                        // Aggiungi alle allerte attive se non è verde
                        if (level !== 'Verde') {
                            activeAlerts.push({
                                risk: riskConfig[risk].label,
                                level: level,
                                icon: riskConfig[risk].icon
                            });
                        }
                    }
                });

                // AGGIORNA GLI ELEMENTI DELLA CARD
                const valueEl = card.querySelector('.quick-stat-value');
                const badgeEl = card.querySelector('.alert-badge');
                const trendEl = card.querySelector('.quick-stat-trend span');
                const iconContainer = card.querySelector('.quick-stat-icon');

                // 1. Aggiorna il VALORE (elenco dei rischi o checkmark)
                if (activeAlerts.length === 0) {
                    valueEl.innerHTML = '✓';
                    valueEl.style.fontSize = '2.5em';
                    // Ripristina gli stili per la visualizzazione standard
                    valueEl.style.display = '';
                    valueEl.style.flexDirection = '';
                    valueEl.style.alignItems = '';
                    valueEl.style.gap = '';
                } else {
                    valueEl.innerHTML = ''; // Pulisci il contenuto precedente
                    valueEl.style.fontSize = '0.9em'; // Adatta la dimensione per il testo
                    valueEl.style.display = 'flex';
                    valueEl.style.flexDirection = 'column';
                    valueEl.style.alignItems = 'flex-start'; // Allinea i rischi a sinistra
                    valueEl.style.gap = '4px'; // Spazio tra i nomi dei rischi

                    const colorMap = {
                        'Gialla': '#ffc107',
                        'Arancione': '#ff9800',
                        'Rossa': '#f44336'
                    };

                    activeAlerts.forEach(alert => {
                        const riskEl = document.createElement('div');
                        riskEl.textContent = alert.risk;
                        riskEl.style.color = colorMap[alert.level] || 'var(--text-color)';
                        riskEl.style.fontWeight = '700';
                        valueEl.appendChild(riskEl);
                    });
                }

                // 2. Aggiorna il BADGE con il livello massimo
                const levelClass = maxLevel.toLowerCase();
                badgeEl.className = `alert-badge ${levelClass}`;
                badgeEl.textContent = maxLevel.toUpperCase();

                // 3. Aggiorna la CLASSE della card per il colore dell'icona
                card.className = `quick-stat-card alert-${levelClass}`;

                // 4. Aggiorna il TREND (testo informativo)
                if (activeAlerts.length === 0) {
                    trendEl.textContent = 'Nessuna allerta attiva.';
                    trendEl.parentElement.className = 'quick-stat-trend trend-neutral';
                } else {
                    if (activeAlerts.length === 1) {
                        trendEl.textContent = '1 allerta attiva.';
                    } else {
                        trendEl.textContent = `${activeAlerts.length} allerte attive. Livello massimo: ${maxLevel.toUpperCase()}.`;
                    }
                    // Aggiorna la classe del trend per abbinarla al livello massimo di allerta
                    if (maxLevel === 'Rossa') {
                        trendEl.parentElement.className = 'quick-stat-trend trend-up'; // Usa trend-up per il rosso
                    } else if (maxLevel === 'Arancione' || maxLevel === 'Gialla') {
                        trendEl.parentElement.className = 'quick-stat-trend trend-up'; // O un'altra classe per warning
                    } else {
                        trendEl.parentElement.className = 'quick-stat-trend trend-neutral';
                    }
                }

                console.log(`Card ${cardId} updated:`, {
                    maxLevel,
                    activeCount: activeAlerts.length,
                    activeAlerts
                });
            };

            // Processa entrambe le card
            processDayAlerts(STATE.officialAlerts.today, 'overview-alerts-today');
            processDayAlerts(STATE.officialAlerts.tomorrow, 'overview-alerts-tomorrow');

            console.log('updateOfficialAlertsCards END');
        }


        // ==================== DATA FETCHING ====================

async function updateAllLatestData() {
            showLoadingIndicator(true);
            try {
                const [regionData, weatherlinkData] = await Promise.all([
                    fetchDataWithTimeout(CONFIG.urls.regionLatest),
                    fetchDataWithTimeout(CONFIG.urls.weatherlinkLatest)
                ]);

                if (regionData && regionData.length > 0) {
                    const d = regionData[0];
                    STATE.regionLatestData = d;
                    updateStatCard('hydro-misa-bettolelle', d['Misa - Livello Misa (mt)'], 'm');
                    updateStatCard('hydro-pianello-ostra', d['Pianello di Ostra - Livello Misa (mt)'], 'm');
                    updateStatCard('hydro-ponte-garibaldi', d['Ponte Garibaldi - Livello Misa 2 (mt)'], 'm');
                    updateStatCard('hydro-serra-dei-conti', d['Serra dei Conti - Livello Misa (mt)'], 'm');
                    updateStatCard('hydro-foce-cesano', d['Foce Cesano - Livello Cesano (mt)'], 'm');
                    updateStatCard('hydro-cesano', d['Cesano - Livello Cesano (mt)'], 'm');
                    updateStatCard('hydro-corinaldo-nevola', d['Nevola - Livello Nevola (mt)'], 'm');
                    updateStatCard('hydro-passo-ripe', d['Passo Ripe - Livello Nevola (mt)'], 'm');
                    
                    const convertToHourRate = (rawValue) => (parseAndFixDecimal(rawValue) * 60);
                    updateStatCard('rain-arcevia', convertToHourRate(d['Arcevia - Intensita di pioggia (mm/min)']), 'mm/hr');
                    updateStatCard('rain-barbara', convertToHourRate(d['Barbara - Intensita di pioggia (mm/min)']), 'mm/hr');
                    updateStatCard('rain-corinaldo', convertToHourRate(d['Corinaldo - Intensita di pioggia (mm/min)']), 'mm/hr');
                    updateStatCard('rain-misa', convertToHourRate(d['Misa - Intensita Pioggia (mm/min)']), 'mm/hr');
                    updateStatCard('rain-senigallia', convertToHourRate(d['Senigallia - Intensita Pioggia (mm/min)']), 'mm/hr');
                }

                if (weatherlinkData && weatherlinkData.length > 0) {
                    const d = weatherlinkData[0];
                    STATE.weatherlinkLatestData = d;
                    updateWindBar('montignano', d['Montignano - Velocità Vento (km/h)'], d['Montignano - Raffica Vento 10 min (km/h)']);
                    updateWindBar('santangelo', d["Sant'Angelo - Velocità Vento (km/h)"], d["Sant'Angelo - Raffica Vento 10 min (km/h)"]);
                    updateWindBar('scapezzano', d['Scapezzano - Velocità Vento (km/h)'], d['Scapezzano - Raffica Vento 10 min (km/h)']);
                    
                    updateStatCard('rain-montignano', d['Montignano - Intensità Pioggia (mm/hr)'], 'mm/hr');
                    updateStatCard('rain-santangelo', d["Sant'Angelo - Intensità Pioggia (mm/hr)"], 'mm/hr');
                    updateStatCard('rain-scapezzano', d['Scapezzano - Intensità Pioggia (mm/hr)'], 'mm/hr');
                }
                
                updateLastUpdate();
                checkAlerts();
                updateOverviewStats();
                if (STATE.map) {
                    updateMapMarkers();
                }
                
                // --- AGGIUNGI QUESTA SEZIONE ---
                if (STATE.dashboardMap) {
                    updateDashboardMapMarkers();
                }
                // -----------------------------

            } catch (error) {
                console.error("Fallimento nell'aggiornare i dati più recenti:", error);
            }
            finally { 
                showLoadingIndicator(false); 
            }
        }

        /**
         * Aggiorna i dati storici da Google Sheets
         * Questa funzione viene chiamata durante il ciclo di aggiornamento automatico
         */
/**
 * VERSIONE OTTIMIZZATA: Carica solo gli ultimi 7 giorni di dati
 * Se necessario, carica dati più vecchi on-demand
 */
async function updateHistoricalData(daysToLoad = 7, forceFullLoad = false) {
    console.log(`🔄 Caricamento dati storici (${forceFullLoad ? 'COMPLETO' : `ultimi ${daysToLoad} giorni`})...`);
    
    try {
        // Calcola timestamp limite per il filtro
        const now = Date.now();
        const timeLimit = forceFullLoad ? 0 : now - (daysToLoad * 24 * 60 * 60 * 1000);
        
        const [regionHistory, weatherlinkHistory] = await Promise.all([
            executeWithRetry(() => 
                fetchDataWithTimeout(CONFIG.urls.regionHistory),
                'dati storici regionali'
            ),
            executeWithRetry(() => 
                fetchDataWithTimeout(CONFIG.urls.weatherlinkHistory),
                'dati storici weatherlink'
            )
        ]);

        // FILTRO: mantieni solo i dati recenti (se non è un caricamento completo)
        const filterByDate = (data) => {
            if (forceFullLoad) return data.filter(r => r && r.Data_Ora);
            
            return data.filter(r => {
                if (!r || !r.Data_Ora) return false;
                const date = parseCustomDate(r.Data_Ora);
                return date && date.getTime() >= timeLimit;
            });
        };

        const filteredRegion = filterByDate(regionHistory);
        const filteredWeatherlink = filterByDate(weatherlinkHistory);

        // Verifica se ci sono nuovi dati
        let hasNewData = false;
        
        if (filteredRegion.length > 0 && 
            filteredRegion.length !== STATE.regionHistoryData.length) {
            STATE.regionHistoryData = filteredRegion;
            hasNewData = true;
            console.log(`✅ Caricati ${filteredRegion.length} record regionali (era ${regionHistory.length} prima del filtro)`);
        }
        
        if (filteredWeatherlink.length > 0 && 
            filteredWeatherlink.length !== STATE.weatherlinkHistoryData.length) {
            STATE.weatherlinkHistoryData = filteredWeatherlink;
            hasNewData = true;
            console.log(`✅ Caricati ${filteredWeatherlink.length} record weatherlink (era ${weatherlinkHistory.length} prima del filtro)`);
        }

        if (hasNewData) {
            STATE.needsChartUpdate = true;
            STATE.lastHistoricalUpdate = new Date();
            
            // Salva info sul caricamento parziale
            STATE.isPartialDataLoad = !forceFullLoad;
            STATE.oldestDataTimestamp = timeLimit;
            
            console.log('📊 Nuovi dati storici rilevati, grafici verranno rigenerati');
        }

        updateDataRangeIndicator();

        return {
            success: true,
            recordsLoaded: filteredRegion.length + filteredWeatherlink.length,
            isPartial: !forceFullLoad
        };
    } catch (error) {
        console.error('❌ Errore caricamento dati storici:', error);
        throw error;
    }
}

        /**
         * Rigenera tutti i grafici che sono attualmente visibili
         * Viene chiamata dopo l'aggiornamento dei dati storici
         */
        function regenerateActiveCharts() {
    if (!CONFIG.chartUpdates.autoRefresh) {
        console.log('⏭️ Auto-refresh grafici disabilitato');
        return;
    }
    
    if (!STATE.needsChartUpdate) {
        console.log('⏭️ Nessun nuovo dato storico, salto rigenerazione grafici');
        return;
    }
    
    console.log('📊 Rigenerazione grafici attivi...');
    STATE.needsChartUpdate = false;
    
    // Se onlyActiveChart è false, chiama la funzione per rigenerare tutto
    if (!CONFIG.chartUpdates.onlyActiveChart) {
        regenerateAllCharts(); // Questa ora contiene la logica corretta
        return;
    }
    
    // Altrimenti, rigenera solo quello attivo ricalcolando il tempo
    const activeSection = document.querySelector('.page-section.active');
    if (!activeSection) return;

    switch(activeSection.id) {
        case 'idrometri':
            // Simula il click sul filtro attivo per ricalcolare l'intervallo di tempo
            document.querySelector('#quick-filters-hydro .quick-filter-btn.active')?.click();
            break;
            
        case 'pluviometri':
            document.querySelector('#quick-filters-rain .quick-filter-btn.active')?.click();
            break;
            
        case 'anemometri':
            document.querySelector('#quick-filters-wind .quick-filter-btn.active')?.click();
            break;
        
        // Per overview e analisi, la logica esistente va bene
        case 'overview':
            console.log('🔄 Aggiornamento grafici overview...');
            drawOverviewCharts();
            break;
        case 'analisi':
            console.log('🔄 Aggiornamento statistiche...');
            updateStatisticsTables();
            break;
    }
}

        /**
         * Rigenera TUTTI i grafici, non solo quelli visibili
         * Usata durante il refresh manuale
         */
        function regenerateAllCharts() {
    console.log('📊 Rigenerazione completa di tutti i grafici...');
    STATE.needsChartUpdate = false; // Manteniamo la correzione di prima

    // Overview e Statistiche si aggiornano sempre
    drawOverviewCharts();
    updateStatisticsTables();
    
    // Per i grafici con filtri temporali, simuliamo il click sul filtro attivo
    // Questo garantisce che l'intervallo di tempo venga ricalcolato correttamente
    
    // Se il grafico idrometri è stato inizializzato...
    if (STATE.charts.hydroHistory) {
        document.querySelector('#quick-filters-hydro .quick-filter-btn.active')?.click();
    }
    
    // Se il grafico pluviometri è stato inizializzato...
    if (STATE.charts.rainHistory) {
        document.querySelector('#quick-filters-rain .quick-filter-btn.active')?.click();
    }
    
    // Se il grafico anemometri è stato inizializzato...
    if (STATE.charts.windHistory) {
        document.querySelector('#quick-filters-wind .quick-filter-btn.active')?.click();
    }
}

        // ==================== OVERVIEW FUNCTIONS ====================
        function updateOverviewStats() {
            if (!STATE.regionLatestData || !STATE.weatherlinkLatestData) return;

            const region = STATE.regionLatestData;
            const weather = STATE.weatherlinkLatestData;
            
            const hydroStations = [
                { name: 'Misa (Bettolelle)', value: parseAndFixDecimal(region['Misa - Livello Misa (mt)']) },
                { name: 'Pianello di Ostra', value: parseAndFixDecimal(region['Pianello di Ostra - Livello Misa (mt)']) },
                { name: 'Ponte Garibaldi', value: parseAndFixDecimal(region['Ponte Garibaldi - Livello Misa 2 (mt)']) },
                { name: 'Serra dei Conti', value: parseAndFixDecimal(region['Serra dei Conti - Livello Misa (mt)']) },
                { name: 'Foce Cesano', value: parseAndFixDecimal(region['Foce Cesano - Livello Cesano (mt)']) },
                { name: 'Cesano', value: parseAndFixDecimal(region['Cesano - Livello Cesano (mt)']) },
                { name: 'Passo Ripe', value: parseAndFixDecimal(region['Passo Ripe - Livello Nevola (mt)']) },
                { name: 'Nevola', value: parseAndFixDecimal(region['Nevola - Livello Nevola (mt)']) }
            ];
            const validHydro = hydroStations.filter(s => !isNaN(s.value));
            const maxHydroStation = validHydro.length > 0 ? validHydro.reduce((max, s) => s.value > max.value ? s : max) : { value: NaN, name: '--'};
            
            const hydroCard = document.getElementById('overview-hydro-max');
            if (hydroCard) {
                const valueEl = hydroCard.querySelector('.quick-stat-value');
                const badgeEl = hydroCard.querySelector('.alert-badge');
                const trendEl = hydroCard.querySelector('.quick-stat-trend span');
                
                if (!isNaN(maxHydroStation.value)) {
                    valueEl.innerHTML = `${maxHydroStation.value.toFixed(2)}<span class="quick-stat-unit">m</span>`;
                    const thresholds = CONFIG.thresholds.hydroThresholds[maxHydroStation.name] || { warning: 99, critical: 999 };
                    const level = getAlertLevel(maxHydroStation.value, thresholds.warning, thresholds.critical);
                    badgeEl.className = `alert-badge ${level}`;
                    badgeEl.textContent = level.toUpperCase();
                    trendEl.textContent = `Stazione: ${maxHydroStation.name}`;
                }
            }

            const rainStationsData = [
                { name: 'Arcevia', value: parseAndFixDecimal(region['Arcevia - Pioggia TOT Oggi (mm)']) },
                { name: 'Barbara', value: parseAndFixDecimal(region['Barbara - Pioggia TOT Oggi (mm)']) },
                { name: 'Corinaldo', value: parseAndFixDecimal(region['Corinaldo - Pioggia TOT Oggi (mm)']) },
                { name: 'Misa', value: parseAndFixDecimal(region['Misa - Pioggia TOT Oggi (mm)']) },
                { name: 'Montignano', value: parseAndFixDecimal(weather['Montignano - Pioggia Giornaliera (mm)']) },
                { name: "Sant'Angelo", value: parseAndFixDecimal(weather["Sant'Angelo - Pioggia Giornaliera (mm)"]) },
                { name: 'Scapezzano', value: parseAndFixDecimal(weather['Scapezzano - Pioggia Giornaliera (mm)']) }
            ];

            const validRainStations = rainStationsData.filter(s => !isNaN(s.value));
            const maxRainStation = validRainStations.length > 0 ? validRainStations.reduce((max, s) => s.value > max.value ? s : max) : { value: NaN, name: '--'};
            
            const rainCard = document.getElementById('overview-rain-total');
            if(rainCard){
                const valueEl = rainCard.querySelector('.quick-stat-value');
                const trendEl = rainCard.querySelector('.quick-stat-trend span');
                if (!isNaN(maxRainStation.value)) {
                    valueEl.innerHTML = `${maxRainStation.value.toFixed(1)}<span class="quick-stat-unit">mm</span>`;
                    trendEl.textContent = `Stazione: ${maxRainStation.name}`;
                }
            }

            const windStations = [
                { name: 'Montignano', value: parseAndFixDecimal(weather['Montignano - Raffica Vento 10 min (km/h)']) },
                { name: "Sant'Angelo", value: parseAndFixDecimal(weather["Sant'Angelo - Raffica Vento 10 min (km/h)"]) },
                { name: 'Scapezzano', value: parseAndFixDecimal(weather['Scapezzano - Raffica Vento 10 min (km/h)']) }
            ];
            const validWind = windStations.filter(s => !isNaN(s.value));
            const maxWindStation = validWind.length > 0 ? validWind.reduce((max, s) => s.value > max.value ? s : max) : { value: NaN, name: '--'};

            const windCard = document.getElementById('overview-wind-max');
            if (windCard) {
                const valueEl = windCard.querySelector('.quick-stat-value');
                const badgeEl = windCard.querySelector('.alert-badge');
                const trendEl = windCard.querySelector('.quick-stat-trend span');

                if (!isNaN(maxWindStation.value)) {
                    valueEl.innerHTML = `${maxWindStation.value.toFixed(1)}<span class="quick-stat-unit">km/h</span>`;
                    const level = getAlertLevel(maxWindStation.value, CONFIG.thresholds.windWarning, CONFIG.thresholds.windCritical);
                    badgeEl.className = `alert-badge ${level}`;
                    badgeEl.textContent = level.toUpperCase();
                    trendEl.textContent = `Stazione: ${maxWindStation.name}`;
                }
            }

            // Rain Intensity
            const rainIntensityStations = [
                { name: 'Arcevia', value: parseAndFixDecimal(region['Arcevia - Intensita di pioggia (mm/min)']) * 60 },
                { name: 'Barbara', value: parseAndFixDecimal(region['Barbara - Intensita di pioggia (mm/min)']) * 60 },
                { name: 'Corinaldo', value: parseAndFixDecimal(region['Corinaldo - Intensita di pioggia (mm/min)']) * 60 },
                { name: 'Misa', value: parseAndFixDecimal(region['Misa - Intensita Pioggia (mm/min)']) * 60 },
                { name: 'Senigallia', value: parseAndFixDecimal(region['Senigallia - Intensita Pioggia (mm/min)']) * 60 },
                { name: 'Montignano', value: parseAndFixDecimal(weather['Montignano - Intensità Pioggia (mm/hr)']) },
                { name: "Sant'Angelo", value: parseAndFixDecimal(weather["Sant'Angelo - Intensità Pioggia (mm/hr)"]) },
                { name: 'Scapezzano', value: parseAndFixDecimal(weather['Scapezzano - Intensità Pioggia (mm/hr)']) }
            ];
            const validRainIntensity = rainIntensityStations.filter(s => !isNaN(s.value));
            const maxRainIntensityStation = validRainIntensity.length > 0 ? validRainIntensity.reduce((max, s) => s.value > max.value ? s : max) : { value: NaN, name: '--'};
            
            const rainIntensityCard = document.getElementById('overview-rain-intensity');
            if (rainIntensityCard) {
                const valueEl = rainIntensityCard.querySelector('.quick-stat-value');
                const badgeEl = rainIntensityCard.querySelector('.alert-badge');
                const trendEl = rainIntensityCard.querySelector('.quick-stat-trend span');

                if (!isNaN(maxRainIntensityStation.value)) {
                    valueEl.innerHTML = `${maxRainIntensityStation.value.toFixed(1)}<span class="quick-stat-unit">mm/h</span>`;
                    const level = getAlertLevel(maxRainIntensityStation.value, CONFIG.thresholds.rainWarning, CONFIG.thresholds.rainCritical);
                    badgeEl.className = `alert-badge ${level}`;
                    badgeEl.textContent = level.toUpperCase();
                    trendEl.textContent = `Stazione: ${maxRainIntensityStation.name}`;
                }
            }
            
            // MODIFICA: Aggiornato il conteggio totale delle stazioni a 18
            const totalStations = 16;
            const activeStations = new Set();
            validHydro.forEach(s => activeStations.add(s.name));
            validWind.forEach(s => activeStations.add(s.name));
            const rainStationData = [
                { name: 'Arcevia', value: parseAndFixDecimal(region['Arcevia - Pioggia TOT Oggi (mm)']) },
                { name: 'Barbara', value: parseAndFixDecimal(region['Barbara - Pioggia TOT Oggi (mm)']) },
                { name: 'Corinaldo', value: parseAndFixDecimal(region['Corinaldo - Pioggia TOT Oggi (mm)']) },
                { name: 'Misa', value: parseAndFixDecimal(region['Misa - Pioggia TOT Oggi (mm)']) },
                { name: 'Senigallia', value: parseAndFixDecimal(region['Senigallia - Pioggia TOT Oggi (mm)']) }
            ];
            rainStationData.forEach(s => { if (!isNaN(s.value)) activeStations.add(s.name); });
            const activeCount = activeStations.size;
            const stationsCard = document.getElementById('overview-stations');
            if (stationsCard) {
                stationsCard.querySelector('.quick-stat-value').innerHTML = `${activeCount}<span class="quick-stat-unit">/${totalStations}</span>`;
            }
        }

        function drawOverviewCharts() {
            const ctxHydro = document.getElementById('overviewHydroChart');
            const ctxRain = document.getElementById('overviewRainChart');
            
            if (ctxHydro && STATE.regionHistoryData.length > 0) {
                const recentData = STATE.regionHistoryData.slice(-50);
                const labels = recentData.map(r => r['Data_Ora']);
                
                if (STATE.charts.overviewHydro) STATE.charts.overviewHydro.destroy();
                
                STATE.charts.overviewHydro = new Chart(ctxHydro, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Misa (Bettolelle)',
                            data: recentData.map(r => parseAndFixDecimal(r['Misa - Livello Misa (mt)'])),
                            borderColor: CONFIG.defaults.chartColors[0],
                            backgroundColor: CONFIG.defaults.chartColors[0] + '20',
                            fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' } }
                        }
                    }
                });
            }

            if (ctxRain && STATE.weatherlinkHistoryData.length > 0) {
                const recentData = STATE.weatherlinkHistoryData.slice(-50);
                const labels = recentData.map(r => r['Data_Ora']);
                
                if (STATE.charts.overviewRain) STATE.charts.overviewRain.destroy();
                
                STATE.charts.overviewRain = new Chart(ctxRain, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Montignano (mm/hr)',
                            data: recentData.map(r => parseAndFixDecimal(r['Montignano - Intensità Pioggia (mm/hr)'])),
                            backgroundColor: CONFIG.defaults.chartColors[1] + '80'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { beginAtZero: true, ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' } }
                        }
                    }
                });
            }
        }

        /**
         * Mostra un indicatore visivo durante l'aggiornamento dei grafici
         */
        function showChartUpdateIndicator(chartContainerId, show = true) {
            const container = document.getElementById(chartContainerId);
            if (!container) return;
            
            let indicator = container.querySelector('.chart-update-indicator');
            
            if (show && !indicator) {
                indicator = document.createElement('div');
                indicator.className = 'chart-update-indicator';
                indicator.innerHTML = `
                    <div class="spinner-small"></div>
                    <span>Aggiornamento...</span>
                `;
                container.style.position = 'relative';
                container.appendChild(indicator);
                
                // Rimuovi automaticamente dopo 2 secondi
                setTimeout(() => {
                    showChartUpdateIndicator(chartContainerId, false);
                }, 2000);
            } else if (!show && indicator) {
                indicator.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => indicator.remove(), 300);
            }
        }

        // ==================== CHART FUNCTIONS ====================
        function safeCreateChart(canvasId, config, chartKey) {
            try {
                return createChart(canvasId, config, chartKey);
            } catch (error) {
                console.error(`Errore creazione grafico ${chartKey}:`, error);
                
                // Mostra messaggio di errore nel canvas
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#f44336';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('❌ Errore caricamento grafico', canvas.width / 2, canvas.height / 2);
                    ctx.fillText('Riprova tra qualche istante', canvas.width / 2, canvas.height / 2 + 30);
                }
                
                showToast(`Errore nel grafico ${chartKey}`, 'error');
                return null;
            }
        }
        
        function createChart(canvasId, config, chartKey) {
            const canvas = document.getElementById(canvasId);
            
            // Cleanup completo
            if (canvas.chart) {
                canvas.chart.destroy();
                canvas.chart = null;
            }
            
            if (chartKey && STATE.charts[chartKey]) {
                STATE.charts[chartKey].destroy();
                STATE.charts[chartKey] = null;
            }
            
            const ctx = canvas.getContext('2d', { willReadFrequently: false });
            const newChart = new Chart(ctx, config);
            canvas.chart = newChart;
            
            if (chartKey) {
                STATE.charts[chartKey] = newChart;
            }
            return newChart;
        }

        const highlightPlugin = {
            id: 'highlightPlugin',
            afterDraw: (chart) => {
                if (STATE.currentHighlightedIndex === -1) return;
                const ctx = chart.ctx;
                const meta = chart.getDatasetMeta(0);
                if (!meta || !meta.data || STATE.currentHighlightedIndex >= meta.data.length) return;

                const point = meta.data[STATE.currentHighlightedIndex];
                if (!point) return;
                
                ctx.save();
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(0, 188, 212, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(point.x, chart.chartArea.top);
                ctx.lineTo(point.x, chart.chartArea.bottom);
                ctx.stroke();
                ctx.restore();

                chart.data.datasets.forEach((dataset, i) => {
                    const metaDataset = chart.getDatasetMeta(i);
                    if (!metaDataset || !metaDataset.data) return;
                    const pointAtIndex = metaDataset.data[STATE.currentHighlightedIndex];
                    if (!pointAtIndex) return;
                    
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(pointAtIndex.x, pointAtIndex.y, 8, 0, 2 * Math.PI);
                    ctx.fillStyle = dataset.borderColor;
                    ctx.fill();
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.restore();
                });
            }
        };

        function drawForecastChart(labels, q10, q50, q90) {
            const stats = {
                q10: calculateStats(q10),
                q50: calculateStats(q50),
                q90: calculateStats(q90)
            };
            
            const tableBody = document.querySelector('#forecast-stats-table tbody');
            tableBody.innerHTML = `
                <tr>
                    <td>Livello Medio</td>
                    <td>${stats.q10.avg ? stats.q10.avg.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.avg ? stats.q50.avg.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.avg ? stats.q90.avg.toFixed(3) + ' m' : '--'}</td>
                </tr>
                <tr>
                    <td>Picco Massimo</td>
                    <td>${stats.q10.max ? stats.q10.max.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.max ? stats.q50.max.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.max ? stats.q90.max.toFixed(3) + ' m' : '--'}</td>
                </tr>
                <tr>
                    <td>Valore Minimo</td>
                    <td>${stats.q10.min ? stats.q10.min.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.min ? stats.q50.min.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.min ? stats.q90.min.toFixed(3) + ' m' : '--'}</td>
                </tr>
            `;

            safeCreateChart('forecastChart', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Q10 (Minimo)', data: q10, borderColor: 'rgba(255, 159, 64, 1)', borderDash: [5, 5], borderWidth: 2, fill: false, pointRadius: 0, tension: 0.4 },
                        { label: 'Q90 (Massimo)', data: q90, borderColor: 'rgba(255, 159, 64, 1)', backgroundColor: 'rgba(255, 159, 64, 0.2)', borderDash: [5, 5], borderWidth: 2, fill: '-1', pointRadius: 0, tension: 0.4 },
                        { label: 'Q50 (Mediana)', data: q50, borderColor: 'rgba(255, 205, 86, 1)', borderWidth: 3, fill: false, pointRadius: 0, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Previsione Livello Idrometrico - Sensore 1112 (Bettolelle)', color: '#FFFFFF', font: { size: 16, weight: '300' } },
                        legend: { labels: { color: '#E0E0E0' } },
                        tooltip: { backgroundColor: 'rgba(30, 30, 30, 0.9)', callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y.toFixed(3)} m` } },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                            limits: {
                                x: { min: 'original', max: 'original' },
                                y: { min: 'original', max: 'original' }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#E0E0E0', maxRotation: 45 }, grid: { color: 'rgba(224, 224, 224, 0.1)' } },
                        y: { beginAtZero: true, ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Livello Idrometrico (m)', color: '#FFFFFF' } }
                    }
                },
                plugins: [highlightPlugin]
            }, 'forecast');
        }

        function updateForecastTable(data) {
    const isMobile = utils.isMobile();
    
    if (isMobile) {
        updateMobileForecastList(data);
    } else {
        updateDesktopForecastTable(data);
    }
}

function updateDesktopForecastTable(data) {
    const desktopTableContainer = document.getElementById('desktop-forecast-table');
    desktopTableContainer.style.display = 'block';
    
    const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
    
    // OTTIMIZZAZIONE: Usa DocumentFragment per batch insert
    const fragment = document.createDocumentFragment();
    
    data.forEach((row, index) => {
        let tr = document.createElement('tr');
        tr.dataset.index = index;
        tr.innerHTML = `
            <td>${row['Timestamp Previsione']}</td>
            <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q10)']).toFixed(3)}</td>
            <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)']).toFixed(3)}</td>
            <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)']).toFixed(3)}</td>
        `;
        
        // Event delegation invece di listener su ogni riga
        fragment.appendChild(tr);
    });
    
    tableBody.innerHTML = '';
    tableBody.appendChild(fragment);
    
    // Event delegation
    tableBody.addEventListener('mouseenter', (e) => {
        if (e.target.tagName === 'TD') {
            const tr = e.target.closest('tr');
            if (!tr || !tr.dataset.index) return;

            const index = parseInt(tr.dataset.index, 10);
            
            document.querySelectorAll('#dataTable tbody tr.highlighted').forEach(r => r.classList.remove('highlighted'));
            
            tr.classList.add('highlighted');
            
            STATE.currentHighlightedIndex = index;
            if (STATE.charts.forecast) {
                STATE.charts.forecast.update('none');
            }
        }
    }, true);
    
    tableBody.addEventListener('mouseleave', () => {
        document.querySelectorAll('#dataTable tbody tr.highlighted').forEach(r => r.classList.remove('highlighted'));
        
        STATE.currentHighlightedIndex = -1;
        if (STATE.charts.forecast) {
            STATE.charts.forecast.update('none');
        }
    }, true);
}

function updateMobileForecastList(data) {
    const desktopTableContainer = document.getElementById('desktop-forecast-table');
    const mobileListContainer = document.getElementById('mobile-forecast-list');

    desktopTableContainer.style.display = 'none';
    mobileListContainer.style.display = 'block';
    mobileListContainer.innerHTML = '';
    
    data.forEach((row, index) => {
        const card = document.createElement('div');
        card.className = 'table-mobile-item';
        card.innerHTML = `
            <div class="timestamp">${row['Timestamp Previsione']}</div>
            <div class="data-row">
                <span>Q50 (Mediana):</span>
                <strong>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)']).toFixed(3)} m</strong>
            </div>
            <div class="data-row">
                <span>Q90 (Massimo):</span>
                <strong>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)']).toFixed(3)} m</strong>
            </div>
        `;
        mobileListContainer.appendChild(card);
    });
}

        async function fetchForecastData() {
            try {
                const data = await fetchDataWithTimeout(CONFIG.urls.forecast);
                const filteredData = data.filter(row => row && row['Timestamp Previsione']);
                STATE.forecastData = filteredData;
                
                const labels = filteredData.map(row => row['Timestamp Previsione']);
                const q10 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q10)']));
                const q50 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)']));
                const q90 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)']));
                
                // Update table AND chart
                updateForecastTable(filteredData);
                drawForecastChart(labels, q10, q50, q90);
            } catch (error) {
                console.error('Error fetching forecast data:', error);
            }
        }

        // New functions for Bettolelle 3h
        function drawForecastChartBettolelle3h(labels, q10, q50, q90) {
            const stats = {
                q10: calculateStats(q10),
                q50: calculateStats(q50),
                q90: calculateStats(q90)
            };

            const tableBody = document.querySelector('#forecast-stats-table-bettolelle-3h tbody');
            tableBody.innerHTML = `
                <tr>
                    <td>Livello Medio</td>
                    <td>${stats.q10.avg ? stats.q10.avg.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.avg ? stats.q50.avg.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.avg ? stats.q90.avg.toFixed(3) + ' m' : '--'}</td>
                </tr>
                <tr>
                    <td>Picco Massimo</td>
                    <td>${stats.q10.max ? stats.q10.max.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.max ? stats.q50.max.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.max ? stats.q90.max.toFixed(3) + ' m' : '--'}</td>
                </tr>
                <tr>
                    <td>Valore Minimo</td>
                    <td>${stats.q10.min ? stats.q10.min.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.min ? stats.q50.min.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.min ? stats.q90.min.toFixed(3) + ' m' : '--'}</td>
                </tr>
            `;

            safeCreateChart('forecastChartBettolelle3h', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Q10 (Minimo)', data: q10, borderColor: 'rgba(255, 159, 64, 1)', borderDash: [5, 5], borderWidth: 2, fill: false, pointRadius: 0, tension: 0.4 },
                        { label: 'Q90 (Massimo)', data: q90, borderColor: 'rgba(255, 159, 64, 1)', backgroundColor: 'rgba(255, 159, 64, 0.2)', borderDash: [5, 5], borderWidth: 2, fill: '-1', pointRadius: 0, tension: 0.4 },
                        { label: 'Q50 (Mediana)', data: q50, borderColor: 'rgba(255, 205, 86, 1)', borderWidth: 3, fill: false, pointRadius: 0, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Previsione Idro Bettolelle 3h', color: '#FFFFFF', font: { size: 16, weight: '300' } },
                        legend: { labels: { color: '#E0E0E0' } },
                        tooltip: { backgroundColor: 'rgba(30, 30, 30, 0.9)', callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y.toFixed(3)} m` } },
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } }
                    },
                    scales: {
                        x: { ticks: { color: '#E0E0E0', maxRotation: 45 }, grid: { color: 'rgba(224, 224, 224, 0.1)' } },
                        y: { beginAtZero: true, ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Livello Idrometrico (m)', color: '#FFFFFF' } }
                    }
                }
            }, 'forecastBettolelle3h');
        }

        function updateForecastTableBettolelle3h(data) {
            const isMobile = utils.isMobile();

            const desktopTableContainer = document.getElementById('desktop-forecast-table-bettolelle-3h');
            const mobileListContainer = document.getElementById('mobile-forecast-list-bettolelle-3h');

            if (isMobile) {
                desktopTableContainer.style.display = 'none';
                mobileListContainer.style.display = 'block';
                mobileListContainer.innerHTML = '';

                data.forEach((row, index) => {
                    const card = document.createElement('div');
                    card.className = 'table-mobile-item';
                    card.innerHTML = `
                        <div class="timestamp">${row['Timestamp Previsione']}</div>
                        <div class="data-row">
                            <span>Q50 (Mediana):</span>
                            <strong>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)']).toFixed(3)} m</strong>
                        </div>
                        <div class="data-row">
                            <span>Q90 (Massimo):</span>
                            <strong>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)']).toFixed(3)} m</strong>
                        </div>
                    `;
                    mobileListContainer.appendChild(card);
                });
            } else {
                desktopTableContainer.style.display = 'block';
                mobileListContainer.style.display = 'none';
                const tableBody = document.getElementById('dataTableBettolelle3h').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';
                
                data.forEach((row, index) => {
                    let tr = tableBody.insertRow();
                    tr.innerHTML = `
                        <td>${row['Timestamp Previsione']}</td>
                        <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q10)']).toFixed(3)}</td>
                        <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)']).toFixed(3)}</td>
                        <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)']).toFixed(3)}</td>
                    `;
                });
            }
        }

        async function fetchForecastDataBettolelle3h() {
            try {
                const data = await fetchDataWithTimeout(CONFIG.urls.forecastBettolelle3h);
                const filteredData = data.filter(row => row && row['Timestamp Previsione']);
                STATE.forecastDataBettolelle3h = filteredData;
                const labels = filteredData.map(row => row['Timestamp Previsione']);
                const q10 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q10)']));
                const q50 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q50)']));
                const q90 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 1112 [m] (Bettolelle) (Q90)']));
                
                // Update table AND chart
                updateForecastTableBettolelle3h(filteredData);
                drawForecastChartBettolelle3h(labels, q10, q50, q90);
            } catch (error) {
                console.error('Error fetching Bettolelle 3h forecast data:', error);
            }
        }

        // New functions for Ponte Garibaldi 6h
        function drawForecastChartPonteGaribaldi6h(labels, q10, q50, q90) {
            const stats = {
                q10: calculateStats(q10),
                q50: calculateStats(q50),
                q90: calculateStats(q90)
            };

            const tableBody = document.querySelector('#forecast-stats-table-ponte-garibaldi-6h tbody');
            tableBody.innerHTML = `
                <tr>
                    <td>Livello Medio</td>
                    <td>${stats.q10.avg ? stats.q10.avg.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.avg ? stats.q50.avg.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.avg ? stats.q90.avg.toFixed(3) + ' m' : '--'}</td>
                </tr>
                <tr>
                    <td>Picco Massimo</td>
                    <td>${stats.q10.max ? stats.q10.max.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.max ? stats.q50.max.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.max ? stats.q90.max.toFixed(3) + ' m' : '--'}</td>
                </tr>
                <tr>
                    <td>Valore Minimo</td>
                    <td>${stats.q10.min ? stats.q10.min.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q50.min ? stats.q50.min.toFixed(3) + ' m' : '--'}</td>
                    <td>${stats.q90.min ? stats.q90.min.toFixed(3) + ' m' : '--'}</td>
                </tr>
            `;

            safeCreateChart('forecastChartPonteGaribaldi6h', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Q10 (Minimo)', data: q10, borderColor: 'rgba(255, 159, 64, 1)', borderDash: [5, 5], borderWidth: 2, fill: false, pointRadius: 0, tension: 0.4 },
                        { label: 'Q90 (Massimo)', data: q90, borderColor: 'rgba(255, 159, 64, 1)', backgroundColor: 'rgba(255, 159, 64, 0.2)', borderDash: [5, 5], borderWidth: 2, fill: '-1', pointRadius: 0, tension: 0.4 },
                        { label: 'Q50 (Mediana)', data: q50, borderColor: 'rgba(255, 205, 86, 1)', borderWidth: 3, fill: false, pointRadius: 0, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Previsione Idro Ponte Garibaldi 6h', color: '#FFFFFF', font: { size: 16, weight: '300' } },
                        legend: { labels: { color: '#E0E0E0' } },
                        tooltip: { backgroundColor: 'rgba(30, 30, 30, 0.9)', callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y.toFixed(3)} m` } },
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } }
                    },
                    scales: {
                        x: { ticks: { color: '#E0E0E0', maxRotation: 45 }, grid: { color: 'rgba(224, 224, 224, 0.1)' } },
                        y: { beginAtZero: true, ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Livello Idrometrico (m)', color: '#FFFFFF' } }
                    }
                }
            }, 'forecastPonteGaribaldi6h');
        }

        function updateForecastTablePonteGaribaldi6h(data) {
            const isMobile = utils.isMobile();
            
            const desktopTableContainer = document.getElementById('desktop-forecast-table-ponte-garibaldi-6h');
            const mobileListContainer = document.getElementById('mobile-forecast-list-ponte-garibaldi-6h');

            if (isMobile) {
                desktopTableContainer.style.display = 'none';
                mobileListContainer.style.display = 'block';
                mobileListContainer.innerHTML = '';

                data.forEach((row, index) => {
                    const card = document.createElement('div');
                    card.className = 'table-mobile-item';
                    card.innerHTML = `
                        <div class="timestamp">${row['Timestamp Previsione']}</div>
                        <div class="data-row">
                            <span>Q50 (Mediana):</span>
                            <strong>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q50)']).toFixed(3)} m</strong>
                        </div>
                        <div class="data-row">
                            <span>Q90 (Massimo):</span>
                            <strong>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q90)']).toFixed(3)} m</strong>
                        </div>
                    `;
                    mobileListContainer.appendChild(card);
                });
            } else {
                desktopTableContainer.style.display = 'block';
                mobileListContainer.style.display = 'none';
                const tableBody = document.getElementById('dataTablePonteGaribaldi6h').getElementsByTagName('tbody')[0];
                tableBody.innerHTML = '';
                
                data.forEach((row, index) => {
                    let tr = tableBody.insertRow();
                    tr.innerHTML = `
                        <td>${row['Timestamp Previsione']}</td>
                        <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q10)']).toFixed(3)}</td>
                        <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q50)']).toFixed(3)}</td>
                        <td>${parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q90)']).toFixed(3)}</td>
                    `;
                });
            }
        }

        function updateDataRangeIndicator() {
            const indicator = document.getElementById('data-range-indicator');
            if (!indicator) return;
            
            if (STATE.isPartialDataLoad) {
                const days = Math.floor((Date.now() - STATE.oldestDataTimestamp) / (24*60*60*1000));
                indicator.innerHTML = `📊 Dati: ultimi ${days} giorni`;
                indicator.style.color = 'var(--warning-color)';
            } else {
                indicator.innerHTML = '📊 Dati: storico completo';
                indicator.style.color = 'var(--success-color)';
            }
        }
        async function fetchForecastDataPonteGaribaldi6h() {
            try {
                const data = await fetchDataWithTimeout(CONFIG.urls.forecastPonteGaribaldi6h);
                const filteredData = data.filter(row => row && row['Timestamp Previsione']);
                STATE.forecastDataPonteGaribaldi6h = filteredData;
                const labels = filteredData.map(row => row['Timestamp Previsione']);
                const q10 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q10)']));
                const q50 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q50)']));
                const q90 = filteredData.map(row => parseAndFixDecimal(row['Previsto: Livello Idrometrico Sensore 3405 [m] (Ponte Garibaldi) (Q90)']));
                
                // Update table AND chart
                updateForecastTablePonteGaribaldi6h(filteredData);
                drawForecastChartPonteGaribaldi6h(labels, q10, q50, q90);
            } catch (error) {
                console.error('Error fetching Ponte Garibaldi 6h forecast data:', error);
            }
        }

        function drawHydroHistoryChart(startDate, endDate) {
            showChartUpdateIndicator('hydroHistoryChart-container', true);
            const start = startDate ? toISOLocal(startDate) : document.getElementById('start-time-hydro').value;
            const end = endDate ? toISOLocal(endDate) : document.getElementById('end-time-hydro').value;
            
            const filteredData = filterDataByTime(STATE.regionHistoryData, 'Data_Ora', start, end);
            
            const labels = filteredData.map(r => r['Data_Ora']);
            const datasets = [
                { col: 'Misa - Livello Misa (mt)', lbl: 'Misa (Bettolelle)' },
                { col: 'Pianello di Ostra - Livello Misa (mt)', lbl: 'Misa (Pianello Ostra)' },
                { col: 'Ponte Garibaldi - Livello Misa 2 (mt)', lbl: 'Misa (P. Garibaldi)' },
                { col: 'Serra dei Conti - Livello Misa (mt)', lbl: 'Misa (Serra dei Conti)' },
                { col: 'Foce Cesano - Livello Cesano (mt)', lbl: 'Foce Cesano' },
                { col: 'Cesano - Livello Cesano (mt)', lbl: 'Cesano' },
                { col: 'Passo Ripe - Livello Nevola (mt)', lbl: 'Nevola (Passo Ripe)' },
                { col: 'Nevola - Livello Nevola (mt)', lbl: 'Nevola (Corinaldo)' }
            ].map((s, i) => ({
                label: s.lbl, data: filteredData.map(r => parseAndFixDecimal(r[s.col])),
                borderColor: CONFIG.defaults.chartColors[i], fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2
            }));

            safeCreateChart('hydroHistoryChart', {
                type: 'line', data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Andamento Storico Livelli Idrometrici', color: '#FFFFFF', font: { size: 16 } },
                        legend: { labels: { color: '#E0E0E0' } },
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } }
                    },
                    scales: {
                        x: { ticks: { color: '#E0E0E0', maxRotation: 45 }, grid: { color: 'rgba(224, 224, 224, 0.1)' } },
                        y: { ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Livello (m)', color: '#FFFFFF' } }
                    }
                }
            }, 'hydroHistory');
        }

        function drawRainHistoryChart(startDate, endDate) {
            showChartUpdateIndicator('rainHistoryChart-container', true);
            const start = startDate ? toISOLocal(startDate) : document.getElementById('start-time-rain').value;
            const end = endDate ? toISOLocal(endDate) : document.getElementById('end-time-rain').value;
            
            const filteredRegion = filterDataByTime(STATE.regionHistoryData, 'Data_Ora', start, end);
            const filteredWeather = filterDataByTime(STATE.weatherlinkHistoryData, 'Data_Ora', start, end);
            
            const selected = Array.from(document.querySelectorAll('#station-selection-rain input:checked')).map(i => i.value);
            const labels = [...new Set([...filteredRegion.map(r => r.Data_Ora), ...filteredWeather.map(r => r.Data_Ora)])]
                .sort((a, b) => (parseCustomDate(a) || 0) - (parseCustomDate(b) || 0));
            
            const mapRegion = new Map(filteredRegion.map(r => [r.Data_Ora, r]));
            const mapWeather = new Map(filteredWeather.map(r => [r.Data_Ora, r]));
            
            const datasets = selected.map((col, i) => {
                const name = col.split(' - ')[0];
                const sourceMap = ['Montignano', "Sant'Angelo", 'Scapezzano'].includes(name) ? mapWeather : mapRegion;
                const data = labels.map(l => { const row = sourceMap.get(l); return row ? parseAndFixDecimal(row[col]) : null; });
                
                // Only return the dataset if it has at least one valid data point
                if (data.some(d => d !== null && !isNaN(d))) {
                    return {
                        label: name, data: data,
                        borderColor: CONFIG.defaults.chartColors[i % CONFIG.defaults.chartColors.length],
                        fill: false, tension: 0.3, pointRadius: 1, borderWidth: 2
                    };
                }
                return null; // Return null for datasets with no data
            }).filter(Boolean); // Filter out the null datasets

            safeCreateChart('rainHistoryChart', {
                type: 'line', data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Andamento Storico Pioggia Cumulata', color: '#FFFFFF', font: { size: 16 } },
                        legend: { labels: { color: '#E0E0E0' } },
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } }
                    },
                    scales: {
                        x: { ticks: { color: '#E0E0E0', maxRotation: 45 }, grid: { color: 'rgba(224, 224, 224, 0.1)' } },
                        y: { beginAtZero: true, ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Pioggia (mm)', color: '#FFFFFF' } }
                    }
                }
            }, 'rainHistory');
        }

        function drawWindHistoryChart(startDate, endDate) {
            showChartUpdateIndicator('windHistoryChart-container', true);
            const station = document.getElementById('station-selection-wind').value;
            const start = startDate ? toISOLocal(startDate) : document.getElementById('start-time-wind').value;
            const end = endDate ? toISOLocal(endDate) : document.getElementById('end-time-wind').value;
            
            const filteredData = filterDataByTime(STATE.weatherlinkHistoryData, 'Data_Ora', start, end);
            
            const labels = filteredData.map(r => r['Data_Ora']);
            
            const datasets = [
                { label: `Velocità (${station})`, data: filteredData.map(r => parseAndFixDecimal(r[`${station} - Velocità Vento (km/h)`])), borderColor: CONFIG.defaults.chartColors[0], fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                { label: `Raffica (${station})`, data: filteredData.map(r => parseAndFixDecimal(r[`${station} - Raffica Vento 10 min (km/h)`])), borderColor: CONFIG.defaults.chartColors[1], borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2 }
            ];

            safeCreateChart('windHistoryChart', {
                type: 'line', data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: `Andamento Storico Vento - ${station}`, color: '#FFFFFF', font: { size: 16 } },
                        legend: { labels: { color: '#E0E0E0' } },
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, mode: 'x' } }
                    },
                    scales: {
                        x: { ticks: { color: '#E0E0E0', maxRotation: 45 }, grid: { color: 'rgba(224, 224, 224, 0.1)' } },
                        y: { beginAtZero: true, ticks: { color: '#E0E0E0' }, grid: { color: 'rgba(224, 224, 224, 0.1)' }, title: { display: true, text: 'Velocità (km/h)', color: '#FFFFFF' } }
                    }
                }
            }, 'windHistory');
        }

        // ==================== STATISTICS FUNCTIONS ====================
        function updateStatisticsTables() {
            const yesterday = new Date(new Date().getTime() - 24 * 3600000);
            
            const recentRegion = STATE.regionHistoryData.filter(r => (parseCustomDate(r.Data_Ora) || 0) >= yesterday);
            const recentWeather = STATE.weatherlinkHistoryData.filter(r => (parseCustomDate(r.Data_Ora) || 0) >= yesterday);
            
            updateHydroStatsTable(recentRegion);
            updateWindStatsTable(recentWeather);
        }

        function updateHydroStatsTable(data) {
            const tbody = document.querySelector('#hydro-stats-table tbody');
            if (!tbody) return;
            
            const stations = [
                { col: 'Misa - Livello Misa (mt)', name: 'Misa (Bettolelle)' },
                { col: 'Pianello di Ostra - Livello Misa (mt)', name: 'Pianello di Ostra' },
                { col: 'Ponte Garibaldi - Livello Misa 2 (mt)', name: 'Ponte Garibaldi' },
                { col: 'Serra dei Conti - Livello Misa (mt)', name: 'Serra dei Conti' },
                { col: 'Foce Cesano - Livello Cesano (mt)', name: 'Foce Cesano' },
                { col: 'Cesano - Livello Cesano (mt)', name: 'Cesano' },
                { col: 'Passo Ripe - Livello Nevola (mt)', name: 'Nevola (Passo Ripe)' },
                { col: 'Nevola - Livello Nevola (mt)', name: 'Nevola (Corinaldo)' }
            ];
            
            tbody.innerHTML = '';
            stations.forEach(station => {
                const values = data.map(r => parseAndFixDecimal(r[station.col])).filter(v => !isNaN(v));
                if (values.length === 0) return;
                
                const stats = calculateStats(values);
                const variation = (values[values.length -1] - values[0]).toFixed(3);
                
                const row = tbody.insertRow();
                row.innerHTML = `<td>${station.name}</td><td>${stats.min.toFixed(3)}</td><td>${stats.max.toFixed(3)}</td><td>${stats.avg.toFixed(3)}</td><td>${variation > 0 ? '+' : ''}${variation} m</td>`;
            });
        }

        function updateWindStatsTable(data) {
            const tbody = document.querySelector('#wind-stats-table tbody');
            if (!tbody) return;
            
            const stations = ['Montignano', "Sant'Angelo", 'Scapezzano'];
            tbody.innerHTML = '';
            
            stations.forEach(station => {
                const speeds = data.map(r => parseAndFixDecimal(r[`${station} - Velocità Vento (km/h)`])).filter(v => !isNaN(v));
                const gusts = data.map(r => parseAndFixDecimal(r[`${station} - Raffica Vento 10 min (km/h)`])).filter(v => !isNaN(v));
                if (speeds.length === 0) return;

                const avgSpeed = calculateStats(speeds).avg.toFixed(1);
                const maxGust = calculateStats(gusts).max.toFixed(1);
                
                const row = tbody.insertRow();
                row.innerHTML = `<td>${station}</td><td>${avgSpeed} km/h</td><td>${maxGust} km/h</td><td>N/D</td>`;
            });
        }
        
        // ==================== MAP FUNCTIONS ====================
        function initDashboardMap() {
            if (STATE.dashboardMap) return; // Già inizializzata

            const mapContainer = document.getElementById('dashboard-map-container');
            if (!mapContainer) return;

            STATE.dashboardMap = L.map('dashboard-map-container', {
                scrollWheelZoom: true,
                zoomControl: true
            }).setView([MAP_CONSTANTS.CENTER_LAT, MAP_CONSTANTS.CENTER_LON], MAP_CONSTANTS.DEFAULT_ZOOM);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19,
                zIndex: 1
            }).addTo(STATE.dashboardMap);

            getStationConfig().forEach(station => {
                const marker = L.marker([station.lat, station.lon], { opacity: 0 }).addTo(STATE.dashboardMap);
                STATE.dashboardMapMarkers[station.name] = { marker, station };
                marker.bindPopup(`<h3>${station.name}</h3><p>Caricamento dati...</p>`);
                setTimeout(() => marker.setOpacity(1), 100 * getStationConfig().indexOf(station));
            });

            updateDashboardMapMarkers();
            setupRadarControls(STATE.dashboardMap, 'dashboard');
            fetchRadarData(STATE.dashboardMap); // Chiamata iniziale per caricare i dati
            STATE.dashboardMap.addControl(new RadarLegendControl({ position: 'bottomleft' }));
        }

        function initMap() {
            if (STATE.map) {
                STATE.map.remove();
            }

            const centerLat = 43.63;
            const centerLon = 13.10;

            STATE.map = L.map('map-container').setView([centerLat, centerLon], 11);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(STATE.map);

            getStationConfig().forEach(station => {
                // Marker inizialmente invisibile
                const marker = L.marker([station.lat, station.lon], {
                    opacity: 0
                }).addTo(STATE.map);
                
                STATE.mapMarkers[station.name] = { marker: marker, station: station };
                
                marker.bindPopup(`<h3>${station.name}</h3><p>Caricamento dati...</p>`);
                
                // Fade in progressivo
                setTimeout(() => {
                    marker.setOpacity(1);
                }, 100 * getStationConfig().indexOf(station));

                marker.on('popupopen', function() {
                    const link = document.querySelector('.leaflet-popup-content a.nav-link');
                    if (link) {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const targetSection = this.getAttribute('href');
                            document.querySelector(`.nav-link[href="${targetSection}"]`)?.click();
                            STATE.map.closePopup();
                        });
                    }
                });
            });

            updateMapMarkers();
            setupRadarControls(STATE.map, 'main');
            fetchRadarData(STATE.map); // Chiamata iniziale per caricare i dati
            STATE.map.addControl(new RadarLegendControl({ position: 'bottomleft' }));
        }
        
        function updateMapMarkers() {
            if (!STATE.map || (!STATE.regionLatestData && !STATE.weatherlinkLatestData)) return;
            updateMarkerSet(STATE.mapMarkers, STATE.regionLatestData, STATE.weatherlinkLatestData);
        }

        function updateDashboardMapMarkers() {
            if (!STATE.dashboardMap || (!STATE.regionLatestData && !STATE.weatherlinkLatestData)) return;
            updateMarkerSet(STATE.dashboardMapMarkers, STATE.regionLatestData, STATE.weatherlinkLatestData);
        }

        function updateMarkerSet(markerSet, regionData, weatherlinkData) {
            Object.values(markerSet).forEach(markerData => {
                const { station, marker } = markerData;
                const sourceData = station.keys.source === 'region' ? regionData : weatherlinkData;
                if (!sourceData) return;

                let displayValue = NaN;
                let alertLevel = 'normal';
                let valueStr = 'N/D';
                let popupContent = `<h3>${station.name}</h3>`;

                // Determina il valore da visualizzare e il livello di allerta
                if (station.displayValue === 'hydro_level' && station.keys.level) {
                    displayValue = parseAndFixDecimal(sourceData[station.keys.level]);
                    const thresholds = CONFIG.thresholds.hydroThresholds[station.name] || { warning: 99, critical: 999 };
                    alertLevel = getAlertLevel(displayValue, thresholds.warning, thresholds.critical);
                    valueStr = isNaN(displayValue) ? 'N/D' : displayValue.toFixed(2);
                } else if (station.displayValue === 'rain_intensity') {
                    if (station.keys.intensity_min) {
                        const rainMin = parseAndFixDecimal(sourceData[station.keys.intensity_min]);
                        if (!isNaN(rainMin)) displayValue = rainMin * 60;
                    } else if (station.keys.intensity_hr) {
                        displayValue = parseAndFixDecimal(sourceData[station.keys.intensity_hr]);
                    }
                    alertLevel = getAlertLevel(displayValue, CONFIG.thresholds.rainWarning, CONFIG.thresholds.rainCritical);
                    valueStr = isNaN(displayValue) ? 'N/D' : displayValue.toFixed(1);
                }

                // Colora il marker in base all'allerta
                const iconColor = alertLevel === 'critical' ? 'var(--danger-color)' : alertLevel === 'warning' ? 'var(--warning-color)' : 'var(--primary-color)';
                
                const isMobile = utils.isMobile();
                const iconSize = isMobile ? MAP_CONSTANTS.ICON_SIZE_MOBILE : MAP_CONSTANTS.ICON_SIZE_DESKTOP;
                const fontSize = isMobile ? '20px' : '18px';

                const rainStations = ['Arcevia', 'Barbara', 'Corinaldo', 'Scapezzano', 'Montignano', "Sant'Angelo", 'Senigallia'];
                let iconShape = rainStations.includes(station.name) ? 'triangle' : 'circle';

                let iconHtml = '';

                if (iconShape === 'triangle') {
                    // Icona a triangolo per pluviometri
                    iconHtml = `
                        <div style="
                            width: 0;
                            height: 0;
                            border-left: ${iconSize/2}px solid transparent;
                            border-right: ${iconSize/2}px solid transparent;
                            border-bottom: ${iconSize}px solid ${iconColor};
                            position: relative;
                            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
                        ">
                            <div style="
                                position: absolute;
                                top: ${iconSize * 0.5}px;
                                left: -${iconSize/2.5}px;
                                width: ${iconSize/1.25}px;
                                color: white;
                                font-size: ${fontSize};
                                font-weight: bold;
                                text-align: center;
                                text-shadow: 0 1px 3px rgba(0,0,0,0.5);
                            ">${valueStr}</div>
                        </div>
                    `;
                } else {
                    // Icona a cerchio per idrometri
                    iconHtml = `
                        <div style="background-color: ${iconColor}; color: white; 
                            width: ${iconSize}px; height: ${iconSize}px; 
                            border-radius: 50%; border: 3px solid white; 
                            display: flex; align-items: center; justify-content: center; 
                            text-align: center; font-size: ${fontSize}; font-weight: bold; 
                            box-shadow: var(--shadow-lg);">
                            ${valueStr}
                        </div>
                    `;
                }

                marker.setIcon(L.divIcon({ 
                    className: 'custom-marker', 
                    html: iconHtml, 
                    iconSize: [iconSize, iconSize], 
                    iconAnchor: [iconSize/2, iconSize] // Ancoraggio alla base
                }));

                if (alertLevel === 'critical' || alertLevel === 'warning') {
                    marker._icon.classList.add(`alert-${alertLevel}`);
                }

                // Costruisce il contenuto del popup in modo dinamico
                if (station.keys.level) {
                    const level = parseAndFixDecimal(sourceData[station.keys.level]);
                    popupContent += `<p><strong>Livello Idrometrico:</strong> ${isNaN(level) ? 'N/D' : `<strong>${level.toFixed(2)} m</strong>`}</p>`;
                }
                let rainHour = NaN;
                if (station.keys.intensity_min) {
                    const rainMin = parseAndFixDecimal(sourceData[station.keys.intensity_min]);
                    if (!isNaN(rainMin)) rainHour = rainMin * 60;
                } else if (station.keys.intensity_hr) {
                    rainHour = parseAndFixDecimal(sourceData[station.keys.intensity_hr]);
                }
                if (!isNaN(rainHour)) {
                    popupContent += `<p><strong>Intensità Pioggia:</strong> <strong>${rainHour.toFixed(1)} mm/h</strong></p>`;
                }
                if (station.keys.total_day) {
                    const total = parseAndFixDecimal(sourceData[station.keys.total_day]);
                    popupContent += `<p><strong>Pioggia Oggi:</strong> ${isNaN(total) ? 'N/D' : `<strong>${total.toFixed(1)} mm</strong>`}</p>`;
                }
                if (station.keys.wind) {
                    const wind = parseAndFixDecimal(sourceData[station.keys.wind]);
                    popupContent += `<p><strong>Vento:</strong> ${isNaN(wind) ? 'N/D' : `<strong>${wind.toFixed(1)} km/h</strong>`}</p>`;
                }
                if (station.keys.gust) {
                    const gust = parseAndFixDecimal(sourceData[station.keys.gust]);
                    popupContent += `<p><strong>Raffica:</strong> ${isNaN(gust) ? 'N/D' : `<strong>${gust.toFixed(1)} km/h</strong>`}</p>`;
                }
                
                popupContent += `<a href="#${station.section}" class="nav-link">Vedi Dettagli</a>`;
                marker.setPopupContent(popupContent);
            });
        }
        
        function getStationConfig() {
            return [
                // Stazioni unificate con marker a cerchio
                { 
                    name: 'Misa (Bettolelle)', lat: 43.66250, lon: 13.16472, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level', // Mostra il livello idrometrico nel cerchio
                    keys: {
                        level: 'Misa - Livello Misa (mt)',
                        intensity_min: 'Misa - Intensita Pioggia (mm/min)',
                        total_day: 'Misa - Pioggia TOT Oggi (mm)',
                        source: 'region'
                    }
                },
                { 
                    name: 'Arcevia', lat: 43.49722, lon: 12.93667, type: 'circle', section: 'pluviometri', 
                    displayValue: 'rain_intensity', // Mostra l'intensità pioggia nel cerchio
                    keys: {
                        intensity_min: 'Arcevia - Intensita di pioggia (mm/min)',
                        total_day: 'Arcevia - Pioggia TOT Oggi (mm)',
                        source: 'region'
                    }
                },
                { 
                    name: 'Barbara', lat: 43.58000, lon: 13.02889, type: 'circle', section: 'pluviometri', 
                    displayValue: 'rain_intensity',
                    keys: {
                        intensity_min: 'Barbara - Intensita di pioggia (mm/min)',
                        total_day: 'Barbara - Pioggia TOT Oggi (mm)',
                        source: 'region'
                    }
                },
                { 
                    name: 'Corinaldo', lat: 43.66028, lon: 13.04611, type: 'circle', section: 'pluviometri', 
                    displayValue: 'rain_intensity',
                    keys: {
                        intensity_min: 'Corinaldo - Intensita di pioggia (mm/min)',
                        total_day: 'Corinaldo - Pioggia TOT Oggi (mm)',
                        source: 'region'
                    }
                },
                { 
                    name: 'Montignano', lat: 43.666, lon: 13.284, type: 'circle', section: 'anemometri', 
                    displayValue: 'rain_intensity',
                    keys: {
                        intensity_hr: 'Montignano - Intensità Pioggia (mm/hr)',
                        total_day: 'Montignano - Pioggia Giornaliera (mm)',
                        wind: 'Montignano - Velocità Vento (km/h)',
                        gust: 'Montignano - Raffica Vento 10 min (km/h)',
                        source: 'weatherlink'
                    }
                },
                { 
                    name: 'Scapezzano', lat: 43.719, lon: 13.168, type: 'circle', section: 'anemometri', 
                    displayValue: 'rain_intensity',
                    keys: {
                        intensity_hr: 'Scapezzano - Intensità Pioggia (mm/hr)',
                        total_day: 'Scapezzano - Pioggia Giornaliera (mm)',
                        wind: 'Scapezzano - Velocità Vento (km/h)',
                        gust: 'Scapezzano - Raffica Vento 10 min (km/h)',
                        source: 'weatherlink'
                    }
                },
                { 
                    name: "Sant'Angelo", lat: 43.675, lon: 13.219, type: 'circle', section: 'anemometri', 
                    displayValue: 'rain_intensity',
                    keys: {
                        intensity_hr: "Sant'Angelo - Intensità Pioggia (mm/hr)",
                        total_day: "Sant'Angelo - Pioggia Giornaliera (mm)",
                        wind: "Sant'Angelo - Velocità Vento (km/h)",
                        gust: "Sant'Angelo - Raffica Vento 10 min (km/h)",
                        source: 'weatherlink'
                    }
                },
                { 
                    name: 'Serra dei Conti', lat: 43.54778, lon: 13.02806, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level',
                    keys: { level: 'Serra dei Conti - Livello Misa (mt)', source: 'region' } 
                },
                { 
                    name: 'Pianello di Ostra', lat: 43.62444, lon: 13.12694, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level',
                    keys: { level: 'Pianello di Ostra - Livello Misa (mt)', source: 'region' } 
                },
                { 
                    name: 'Nevola', lat: 43.63833, lon: 13.07667, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level',
                    keys: { level: 'Nevola - Livello Nevola (mt)', source: 'region' } 
                },
                { 
                    name: 'Ponte Garibaldi', lat: 43.71500, lon: 13.21361, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level',
                    keys: { level: 'Ponte Garibaldi - Livello Misa 2 (mt)', source: 'region' } 
                },
                { 
                    name: 'Passo Ripe', lat: 43.65139, lon: 13.10556, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level',
                    keys: { level: 'Passo Ripe - Livello Nevola (mt)', source: 'region' } 
                },
                { 
                    name: 'Foce Cesano', lat: 43.74, lon: 13.17083, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level',
                    keys: { level: 'Foce Cesano - Livello Cesano (mt)', source: 'region' } 
                },
                { 
                    name: 'Cesano', lat: 43.66472, lon: 13.01444, type: 'circle', section: 'idrometri', 
                    displayValue: 'hydro_level',
                    keys: { level: 'Cesano - Livello Cesano (mt)', source: 'region' } 
                },
                { 
                    name: 'Senigallia', lat: 43.70083, lon: 13.20556, type: 'circle', section: 'pluviometri', 
                    displayValue: 'rain_intensity',
                    keys: {
                        intensity_min: 'Senigallia - Intensita Pioggia (mm/min)',
                        total_day: 'Senigallia - Pioggia TOT Oggi (mm)',
                        source: 'region'
                    }
                }
            ];
        }

        // ==================== RADAR FUNCTIONS ====================
        const radarInstances = new Map(); // Per gestire più mappe (dashboard e mappa principale)

        async function fetchRadarData(mapInstance) {
            if (!radarInstances.has(mapInstance)) return;

            const radarState = radarInstances.get(mapInstance);

            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                if (!response.ok) throw new Error('Risposta API non valida');
                const data = await response.json();
                
                const now = data.generated;
                const oneHour = 3600;

                const pastFrames = (data.radar.past || []).filter(f => now - f.time <= oneHour);
                const nowcastFrames = (data.radar.nowcast || []).filter(f => f.time - now <= oneHour && f.time >= now);

                const allFrames = [...pastFrames, ...nowcastFrames].sort((a, b) => a.time - b.time);

                if (allFrames.length > 0) {
                    radarState.createRadarLayers(allFrames, now);
                    radarState.isLoaded = true;
                    
                    const timelineSlider = document.getElementById(`radar-timeline-slider-${radarState.prefix}`);
                    const playButton = document.getElementById(`radar-play-btn-${radarState.prefix}`);

                    if (timelineSlider) timelineSlider.max = allFrames.length - 1;
                    
                    // FIX: Calcolo migliorato dell'indice "Now"
                    let nowIndex = -1;
                    let minDiff = Infinity;
                    
                    // Trova il frame più vicino a "now"
                    allFrames.forEach((frame, index) => {
                        const diff = Math.abs(frame.time - now);
                        if (diff < minDiff) {
                            minDiff = diff;
                            nowIndex = index;
                        }
                    });
                    
                    // Se non trovato, usa il frame che separa passato e futuro
                    if (nowIndex === -1) {
                        const pastCount = pastFrames.length;
                        nowIndex = pastCount > 0 ? pastCount - 1 : 0;
                    }
                    
                    console.log(`🎯 Now index: ${nowIndex}/${allFrames.length - 1} (${Math.round(nowIndex/(allFrames.length-1)*100)}%)`);
                    
                    radarState.currentIndex = nowIndex;
                    radarState.frames = allFrames;
                    
                    if (playButton) playButton.classList.remove('leaflet-disabled');
                    if (timelineSlider) {
                        timelineSlider.classList.remove('leaflet-disabled');
                        timelineSlider.disabled = false;
                    }
                    
                    // Mostra il frame "Now"
                    radarState.showFrame(radarState.currentIndex);
                    
                    // ... resto del codice ...
                }
            } catch (error) {
                console.error("❌ Errore aggiornamento dati radar:", error);
                showToast('Errore aggiornamento radar', 'error');
            }
        }

        function setupRadarControls(mapInstance, prefix) {
            const radarState = {
                layers: [],
                frames: [],
                animationInterval: null,
                currentIndex: 0,
                isPlaying: false,
                isLoaded: false,
                generatedTime: 0,
                isRadarVisible: true,
                prefix: prefix, // Prefisso per ID univoci
                initialLoadComplete: false // Per gestire il toast
            };
            
            // Collega le funzioni di manipolazione al contesto di questa istanza
            radarState.createRadarLayers = createRadarLayers.bind(radarState, mapInstance);
            radarState.showFrame = showFrame.bind(radarState, mapInstance);
            radarState.playRadarAnimation = playRadarAnimation.bind(radarState);
            radarState.stopRadarAnimation = stopRadarAnimation.bind(radarState);
            radarState.updateSliderUI = updateSliderUI.bind(radarState);
            
            radarInstances.set(mapInstance, radarState);

            let playButton, timelineSlider, timeLabel, progressBar, futureBar, toggleButton;

            const RadarToggleControl = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-control-radar-toggle leaflet-bar');
                    toggleButton = L.DomUtil.create('a', 'active', container);
                    toggleButton.href = '#';
                    toggleButton.title = 'Mostra/Nascondi Radar';
                    toggleButton.innerHTML = `<i data-feather="layers" class="feather-icon"></i>`;
                    
                    L.DomEvent.on(toggleButton, 'click', L.DomEvent.stop).on(toggleButton, 'click', () => {
                        radarState.isRadarVisible = !radarState.isRadarVisible;
                        
                        if (radarState.isRadarVisible) {
                            L.DomUtil.addClass(toggleButton, 'active');
                            radarState.showFrame(radarState.currentIndex);
                        } else {
                            L.DomUtil.removeClass(toggleButton, 'active');
                            radarState.stopRadarAnimation();
                            radarState.layers.forEach(layer => {
                                if (mapInstance.hasLayer(layer)) {
                                    mapInstance.removeLayer(layer);
                                }
                            });
                        }
                    });
                    
                    setTimeout(() => feather.replace(), 0);
                    return container;
                }
            });

            const RadarControl = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-control-radar');
                    
                    container.innerHTML = `
                        <div class="radar-play-pause">
                            <button id="radar-play-btn-${prefix}" class="radar-play-button">▶</button>
                        </div>
                        <div class="radar-timeline-container">
                            <div id="radar-time-label-${prefix}" class="radar-time-label">--:--</div>
                            <div class="radar-slider-wrapper">
                                <div class="radar-slider-track"></div>
                                <div class="radar-slider-progress" id="radar-slider-progress-${prefix}"></div>
                                <div class="radar-slider-future" id="radar-slider-future-${prefix}"></div>
                                <input type="range" id="radar-timeline-slider-${prefix}" class="radar-timeline-slider" min="0" max="100" value="50" disabled>
                            </div>
                            <div class="radar-timeline-labels">
                                <span>1h ago</span>
                                <span>Now</span>
                                <span>Next 1h</span>
                            </div>
                        </div>
                    `;
                    
                    playButton = container.querySelector(`#radar-play-btn-${prefix}`);
                    timelineSlider = container.querySelector(`#radar-timeline-slider-${prefix}`);
                    timeLabel = container.querySelector(`#radar-time-label-${prefix}`);
                    progressBar = container.querySelector(`#radar-slider-progress-${prefix}`);
                    futureBar = container.querySelector(`#radar-slider-future-${prefix}`);

                    L.DomEvent.disableClickPropagation(container);
                    
                    playButton.addEventListener('click', () => {
                        if (radarState.isPlaying) {
                            radarState.stopRadarAnimation();
                        } else {
                            radarState.playRadarAnimation();
                        }
                    });

                    timelineSlider.addEventListener('input', (e) => {
                        radarState.stopRadarAnimation();
                        const newIndex = parseInt(e.target.value, 10);
                        radarState.showFrame(newIndex);
                    });


                    return container;
                }
            });
            
            mapInstance.addControl(new RadarControl({ position: 'bottomright' }));
            mapInstance.addControl(new RadarToggleControl({ position: 'topleft' }));
            
            function createRadarLayers(mapInstance, frames, generatedTime) {
                this.layers.forEach(layer => mapInstance.removeLayer(layer));
                this.layers = [];
                this.frames = frames;
                this.generatedTime = generatedTime;

                frames.forEach(frame => {
                    const layer = L.tileLayer(`https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`, {
                        tileSize: 256,
                        opacity: 0,
                        zIndex: 10
                    });
                    this.layers.push(layer);
                });
                
                // Enable slider
                const timelineSlider = document.getElementById(`radar-timeline-slider-${this.prefix}`);
                if(timelineSlider) timelineSlider.disabled = false;
            }
            
            function showFrame(mapInstance, index) {
                if (!this.layers[index] || !this.frames[index]) return;

                const previousLayer = this.layers[this.currentIndex];
                if (mapInstance.hasLayer(previousLayer)) {
                    mapInstance.removeLayer(previousLayer);
                }

                if (this.isRadarVisible) {
                    const currentLayer = this.layers[index];
                    currentLayer.addTo(mapInstance).setOpacity(0.8);
                }
                
                this.currentIndex = index;
                this.updateSliderUI(index);
            }

function updateSliderUI(index) {
    const timelineSlider = document.getElementById(`radar-timeline-slider-${this.prefix}`);
    const timeLabel = document.getElementById(`radar-time-label-${this.prefix}`);
    const progressBar = document.getElementById(`radar-slider-progress-${this.prefix}`);
    const futureBar = document.getElementById(`radar-slider-future-${this.prefix}`);

    if (!timelineSlider || !this.frames.length) return;
    
    const validIndex = Math.max(0, Math.min(index, this.frames.length - 1));
    
    // FIX: Forza l'aggiornamento del valore dello slider
    if (timelineSlider.value != validIndex) {
        timelineSlider.value = validIndex;
        // Trigger manuale dell'evento per browser che non aggiornano il thumb
        timelineSlider.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    const maxIndex = this.frames.length - 1;
    const percentage = maxIndex > 0 ? (validIndex / maxIndex) * 100 : 0;
    
    // Rimuovi le transizioni durante l'animazione per evitare lag
    const isAnimating = this.isPlaying;
    const transitionDuration = isAnimating ? '0s' : '0.2s';
    
    if(progressBar) {
        progressBar.style.transition = `width ${transitionDuration} linear`;
        progressBar.style.width = `${percentage}%`;
    }
    
    if(futureBar) {
        futureBar.style.transition = `width ${transitionDuration} linear`;
        futureBar.style.width = `${100 - percentage}%`;
    }
    
    if(timeLabel) {
        timeLabel.style.transition = `left ${transitionDuration} linear`;
        timeLabel.style.left = `${percentage}%`;
        
        const frame = this.frames[validIndex];
        if (frame) {
            const currentTime = new Date(frame.time * 1000);
            const hours = String(currentTime.getHours()).padStart(2, '0');
            const minutes = String(currentTime.getMinutes()).padStart(2, '0');
            timeLabel.textContent = `${hours}:${minutes}`;
        }
    }
}

            function playRadarAnimation() {
    if (this.isPlaying || !this.isLoaded) return;
    this.isPlaying = true;
    
    const playButton = document.getElementById(`radar-play-btn-${this.prefix}`);
    if (playButton) {
        playButton.textContent = '⏸';
        playButton.style.background = '#6785bf';
    }
    
    // FIX: Parti sempre dall'inizio quando premi play
    // Opzionale: commenta questa linea se vuoi continuare dalla posizione corrente
    // this.currentIndex = 0;
    
    let lastUpdate = Date.now();
    const frameDelay = 200; // ms
    
    const animate = () => {
        if (!this.isPlaying) return;
        
        const now = Date.now();
        if (now - lastUpdate >= frameDelay) {
            let nextIndex = this.currentIndex + 1;
            if (nextIndex >= this.frames.length) {
                nextIndex = 0; // Loop
            }
            
            // FIX: Assicura che showFrame aggiorni tutto
            this.showFrame(nextIndex);
            
            // FIX: Forza l'aggiornamento visuale dello slider
            const slider = document.getElementById(`radar-timeline-slider-${this.prefix}`);
            if (slider && slider.value != nextIndex) {
                slider.value = nextIndex;
            }
            
            lastUpdate = now;
        }
        this.animationInterval = requestAnimationFrame(animate);
    };
    
    this.animationInterval = requestAnimationFrame(animate);
}

            function stopRadarAnimation() {
    if (!this.isPlaying) return;
    
    // FIX: Annulla requestAnimationFrame invece di clearInterval
    if (this.animationInterval) {
        cancelAnimationFrame(this.animationInterval);
        this.animationInterval = null;
    }
    
    this.isPlaying = false;
    const playButton = document.getElementById(`radar-play-btn-${this.prefix}`);
    if (playButton) {
        playButton.textContent = '▶';
        playButton.style.background = '#2c2c2c';
    }
}
        }
        
        // ==================== RADAR LEGEND CONTROL ====================
        const RadarLegendControl = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-radar-legend');
                
                container.innerHTML = `
                    <div class="legend-title">Intensità Radar (mm/h)</div>
                    <div class="legend-gradient"></div>
                    <div class="legend-labels">
                        <span>0.1</span>
                        <span>0.5</span>
                        <span>1</span>
                        <span>5</span>
                        <span>10</span>
                        <span>>50</span>
                    </div>
                `;
                
                // Disabilita gli eventi della mappa sul controllo
                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.disableScrollPropagation(container);
                
                return container;
            }
        });

        // ==================== EXPORT FUNCTIONS ====================
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                showToast('Nessun dato da esportare', 'warning');
                return;
            }
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Dati esportati con successo', 'success');
        }

        function downloadChartImage(chartId, filename) {
            const canvas = document.getElementById(chartId);
            if (canvas) {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                showToast('Grafico scaricato', 'success');
            }
        }

        // ==================== NAVIGATION & INTERACTIONS ====================
        function initNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link, .page-section').forEach(el => el.classList.remove('active'));
                    
                    this.classList.add('active');
                    const targetSection = document.querySelector(this.getAttribute('href'));
                    if (targetSection) {
                        targetSection.classList.add('active');
                        
                        if (utils.isMobile()) {
                            closeMobileMenu();
                        }
                        
                        switch(targetSection.id) {
                            case 'overview': drawOverviewCharts(); break;
                            case 'mappa': if (!STATE.map) initMap(); else STATE.map.invalidateSize(); break;
                            case 'previsioni': if (!STATE.charts.forecast) fetchForecastData(); break;
                            case 'idrometri': if (!STATE.charts.hydroHistory) drawHydroHistoryChart(); break;
                            case 'pluviometri': if (!STATE.charts.rainHistory) drawRainHistoryChart(); break;
                            case 'anemometri': if (!STATE.charts.windHistory) drawWindHistoryChart(); break;
                            case 'analisi': updateStatisticsTables(); break;
                        }
                    }
                });
            });
        }

        function initQuickFilters() {
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.parentElement.querySelectorAll('.quick-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const hours = parseInt(this.dataset.hours);
                    const now = new Date();
                    const start = new Date(now.getTime() - hours * 3600000);
                    
                    const section = this.closest('.page-section');
                    const startInput = section.querySelector('input[type="datetime-local"][id^="start-time"]');
                    const endInput = section.querySelector('input[type="datetime-local"][id^="end-time"]');
                    
                    if (startInput && endInput) {
                        startInput.value = toISOLocal(start);
                        endInput.value = toISOLocal(now);
                    }

                    switch(section.id) {
                        case 'idrometri':
                            drawHydroHistoryChart(start, now);
                            break;
                        case 'pluviometri':
                            drawRainHistoryChart(start, now);
                            break;
                        case 'anemometri':
                            drawWindHistoryChart(start, now);
                            break;
                    }
                });
            });
        }
        
        // ==================== FULLSCREEN FUNCTIONS ====================
        function setupFullscreen(buttonId, chartContainerId) {
            const button = document.getElementById(buttonId);
            const container = document.getElementById(chartContainerId + "-container");
            
            if (!button || !container) return;
            
            button.addEventListener('click', function() {
                const isFullscreen = container.classList.contains('fullscreen');
                
                if (isFullscreen) {
                    exitFullscreen(container);
                } else {
                    enterFullscreen(container);
                }
            });
        }

        function enterFullscreen(container) {
            container.classList.add('fullscreen');
            
            const exitBtn = document.createElement('button');
            exitBtn.className = 'fullscreen-exit-btn';
            exitBtn.id = 'fullscreen-exit-btn';
            exitBtn.innerHTML = '&times;';
            exitBtn.title = 'Esci da Fullscreen';
            
            exitBtn.addEventListener('click', function() {
                exitFullscreen(container);
            });
            
            document.body.appendChild(exitBtn);
            
            const canvas = container.querySelector('canvas');
            if (canvas && canvas.chart) {
                canvas.chart.resize();
            }
        }

        function exitFullscreen(container) {
            container.classList.remove('fullscreen');
            
            const exitBtn = document.getElementById('fullscreen-exit-btn');
            if (exitBtn) {
                exitBtn.remove();
            }
            
            const canvas = container.querySelector('canvas');
            if (canvas && canvas.chart) {
                canvas.chart.resize();
            }
        }

        function initFullscreenButtons() {
            setupFullscreen('fullscreen-forecast', 'forecastChart');
            setupFullscreen('fullscreen-hydro', 'hydroHistoryChart');
            setupFullscreen('fullscreen-rain', 'rainHistoryChart');
            setupFullscreen('fullscreen-wind', 'windHistoryChart');
            setupFullscreen('fullscreen-forecast-bettolelle-3h', 'forecastChartBettolelle3h');
            setupFullscreen('fullscreen-forecast-ponte-garibaldi-6h', 'forecastChartPonteGaribaldi6h');
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const fullscreenContainer = document.querySelector('.chart-container.fullscreen');
                    if (fullscreenContainer) {
                        exitFullscreen(fullscreenContainer);
                    }
                }
            });
        }

        function openMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const menuToggle = document.getElementById('menu-toggle');

            sidebar.classList.remove('collapsed'); // Ensure collapsed is removed
            sidebar.classList.add('open');
            overlay?.classList.add('active');
            menuToggle.innerHTML = '✕';
            document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const menuToggle = document.getElementById('menu-toggle');

            sidebar.classList.remove('open');
            overlay?.classList.remove('active');
            menuToggle.innerHTML = '☰';
            document.body.style.overflow = '';

            // Force resize after transition
            setTimeout(handleResize, 300);
        }

        function initUIInteractions() {
            // Sidebar Toggle
            document.getElementById('menu-toggle').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const isMobile = utils.isMobile();

                if (isMobile) {
                    // Ensure overlay exists BEFORE toggling the menu
                    let overlay = document.querySelector('.sidebar-overlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.className = 'sidebar-overlay';
                        document.body.appendChild(overlay);
                        overlay.addEventListener('click', closeMobileMenu);
                    }

                    if (sidebar.classList.contains('open')) {
                        closeMobileMenu();
                    } else {
                        openMobileMenu();
                    }
                } else {
                    sidebar.classList.toggle('collapsed');
                    document.getElementById('main-content').classList.toggle('expanded');
                }
            });

            // Modals
            const setupModal = (btnId, modalId, closeBtnId) => {
                const modal = document.getElementById(modalId);
                document.getElementById(btnId).addEventListener('click', () => modal.classList.add('active'));
                document.getElementById(closeBtnId).addEventListener('click', () => modal.classList.remove('active'));
            };
            setupModal('export-btn', 'export-modal', 'close-export-modal');
            setupModal('settings-btn', 'settings-modal', 'close-settings-modal');

            // Refresh Button - VERSIONE AGGIORNATA
            document.getElementById('refresh-btn').addEventListener('click', async () => {
                console.log('🔄 Refresh manuale avviato dall\'utente');
                showLoading();
                
                try {
                    // Mostra toast informativo
                    showToast('Aggiornamento in corso...', 'info');
                    
                    // 1. Aggiorna dati real-time
                    await Promise.all([
                        updateAllLatestData(),
                        updateOfficialAlerts()
                    ]);
                    
                    // 2. Aggiorna previsioni
                    await Promise.all([
                        fetchForecastData(),
                        fetchForecastDataBettolelle3h(),
                        fetchForecastDataPonteGaribaldi6h()
                    ]);
                    
                    // 3. Aggiorna dati storici (NUOVO!)
                    await updateHistoricalData();
                    
                    // 4. Rigenera TUTTI i grafici (NUOVO!)
                    regenerateAllCharts();
                    
                    // 5. Aggiorna radar
                    const radarPromises = [];
                    if (STATE.map) radarPromises.push(fetchRadarData(STATE.map));
                    if (STATE.dashboardMap) radarPromises.push(fetchRadarData(STATE.dashboardMap));
                    if (radarPromises.length > 0) {
                        await Promise.all(radarPromises);
                    }
                    
                    showToast('✅ Aggiornamento completato con successo!', 'success');
                    console.log('✅ Refresh manuale completato');
                    
                } catch (error) {
                    console.error('❌ Errore durante il refresh manuale:', error);
                    showToast('❌ Errore durante l\'aggiornamento', 'error');
                } finally {
                    hideLoading();
                }
            });
            
            // Export actions
            document.getElementById('export-current-view').addEventListener('click', () => {
                const sectionId = document.querySelector('.page-section.active').id;
                let data = [], filename = 'export.csv';
                switch(sectionId) {
                    case 'idrometri': data = STATE.regionHistoryData; filename = 'idrometri.csv'; break;
                    case 'pluviometri': data = [...STATE.regionHistoryData, ...STATE.weatherlinkHistoryData]; filename = 'pluviometri.csv'; break;
                    case 'anemometri': data = STATE.weatherlinkHistoryData; filename = 'anemometri.csv'; break;
                    case 'previsioni': data = STATE.forecastData; filename = 'previsioni.csv'; break;
                }
                exportToCSV(data, filename);
                document.getElementById('export-modal').classList.remove('active');
            });

            // Forecast page buttons
            document.getElementById('toggle-instructions-btn').addEventListener('click', function() {
                const instructions = document.getElementById('instructions-container');
                const isVisible = instructions.classList.toggle('visible');
                const icon = this.querySelector('.feather-icon');
                this.childNodes[2].nodeValue = isVisible ? ' Nascondi Istruzioni' : ' Mostra Istruzioni';
                icon.setAttribute('data-feather', isVisible ? 'book' : 'book-open');
                feather.replace();
            });
            document.getElementById('resetZoomBtn').addEventListener('click', () => {
                if (STATE.charts.forecast) STATE.charts.forecast.resetZoom();
            });

            // Chart action buttons
            const chartActions = {
                'download-forecast-chart': () => downloadChartImage('forecastChart', 'previsioni.png'),
                'download-hydro-chart': () => downloadChartImage('hydroHistoryChart', 'idrometri.png'),
                'download-rain-chart': () => downloadChartImage('rainHistoryChart', 'pluviometri.png'),
                'download-wind-chart': () => downloadChartImage('windHistoryChart', 'anemometri.png'),
                'download-forecast-chart-bettolelle-3h': () => downloadChartImage('forecastChartBettolelle3h', 'previsioni_bettolelle_3h.png'),
                'download-forecast-chart-ponte-garibaldi-6h': () => downloadChartImage('forecastChartPonteGaribaldi6h', 'previsioni_ponte_garibaldi_6h.png'),
            };
            for (const [id, action] of Object.entries(chartActions)) {
                const btn = document.getElementById(id);
                if (btn) btn.addEventListener('click', action);
            }
        }

        // ==================== SETTINGS ====================
        function saveSettings() {
            const thresholdsToSave = {
                rainWarning: parseFloat(document.getElementById('threshold-rain-warning').value),
                rainCritical: parseFloat(document.getElementById('threshold-rain-critical').value),
                windWarning: parseFloat(document.getElementById('threshold-wind-warning').value),
                windCritical: parseFloat(document.getElementById('threshold-wind-critical').value)
            };

            const hydroThresholds = {};
            document.querySelectorAll('#hydro-thresholds-settings input[data-station]').forEach(input => {
                const station = input.dataset.station;
                const level = input.dataset.level;
                if (!hydroThresholds[station]) {
                    hydroThresholds[station] = { ...CONFIG.thresholds.hydroThresholds[station] };
                }
                hydroThresholds[station][level] = parseFloat(input.value);
            });

            const newConfig = {
                thresholds: { ...CONFIG.thresholds, ...thresholdsToSave, hydroThresholds },
                intervals: {
                    dataUpdate: parseInt(document.getElementById('update-interval-data').value) * 1000,
                    forecastUpdate: parseInt(document.getElementById('update-interval-forecast').value) * 1000
                },
                advanced: {
                    fetchTimeout: parseInt(document.getElementById('fetch-timeout').value) * 1000,
                    maxRetries: parseInt(document.getElementById('max-retries').value),
                    retryDelay: 2000,
                    preventOverlap: document.getElementById('prevent-overlap').checked
                }
            };
            
            CONFIG = { ...CONFIG, ...newConfig };
            
            localStorage.setItem('meteoConfig', JSON.stringify(newConfig));
            
            // Save theme settings
            const isDarkMode = document.getElementById('theme-toggle').checked;
            const primaryColor = document.getElementById('primary-color-picker').value;
            
            localStorage.setItem('theme', JSON.stringify({
                darkMode: isDarkMode,
                primaryColor: primaryColor
            }));
            
            applyTheme();
            
            document.getElementById('settings-modal').classList.remove('active');
            startAutoRefresh();
            showToast('✅ Impostazioni salvate e applicate!');
        }

        function applyTheme() {
            const savedTheme = JSON.parse(localStorage.getItem('theme'));
            
            if (savedTheme) {
                document.body.classList.toggle('light-mode', !savedTheme.darkMode);
                document.documentElement.style.setProperty('--primary-color', savedTheme.primaryColor);
                
                // Update controls
                document.getElementById('theme-toggle').checked = savedTheme.darkMode;
                document.getElementById('primary-color-picker').value = savedTheme.primaryColor;
            } else {
                // Default theme
                document.getElementById('theme-toggle').checked = true;
                document.getElementById('primary-color-picker').value = '#6785bf';
            }
        }

        function loadSettings() {
            const savedConfig = localStorage.getItem('meteoConfig');
            if (savedConfig) {
                const parsedConfig = JSON.parse(savedConfig);
                // Unisci le configurazioni salvate a quelle di default
                CONFIG.thresholds = { ...CONFIG.thresholds, ...parsedConfig.thresholds };
                CONFIG.intervals = { ...CONFIG.intervals, ...parsedConfig.intervals };
                CONFIG.advanced = { ...CONFIG.advanced, ...parsedConfig.advanced };
            }
            
            // Rimuovi le righe per le soglie idro, che non esistono più
            document.getElementById('threshold-rain-warning').value = CONFIG.thresholds.rainWarning;
            document.getElementById('threshold-rain-critical').value = CONFIG.thresholds.rainCritical;
            document.getElementById('threshold-wind-warning').value = CONFIG.thresholds.windWarning;
            document.getElementById('threshold-wind-critical').value = CONFIG.thresholds.windCritical;
            document.getElementById('update-interval-data').value = CONFIG.intervals.dataUpdate / 1000;
            document.getElementById('update-interval-forecast').value = CONFIG.intervals.forecastUpdate / 1000;

            const hydroContainer = document.getElementById('hydro-thresholds-settings');
            hydroContainer.innerHTML = '';
            for (const station in CONFIG.thresholds.hydroThresholds) {
                const thresholds = CONFIG.thresholds.hydroThresholds[station];
                const stationDiv = document.createElement('div');
                stationDiv.className = 'settings-item';
                stationDiv.innerHTML = `
                    <span>${station} (m):</span>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" data-station="${station}" data-level="warning" value="${thresholds.warning}" step="0.1" placeholder="Allerta">
                        <input type="number" data-station="${station}" data-level="critical" value="${thresholds.critical}" step="0.1" placeholder="Critica">
                    </div>
                `;
                hydroContainer.appendChild(stationDiv);
            }
            
            applyTheme();
        }

// ==================== INITIALIZATION ====================

/**
 * NUOVO: Gestisce richieste di dati oltre il limite caricato
 */
async function handleTimeFilterWithDataCheck(startDate, endDate, chartType) {
    const requestedStart = startDate ? new Date(startDate).getTime() : 0;
    
    // Se i dati richiesti sono più vecchi di quelli caricati, carica tutto
    if (STATE.isPartialDataLoad && requestedStart < STATE.oldestDataTimestamp) {
        showToast('⏳ Caricamento dati completi in corso...', 'info');
        
        try {
            await updateHistoricalData(365, true); // Carica tutto (max 1 anno)
            showToast('✅ Dati storici completi caricati!', 'success');
        } catch (error) {
            showToast('❌ Errore caricamento dati storici', 'error');
            return;
        }
    }
    
    // Ora disegna il grafico richiesto
    switch(chartType) {
        case 'hydro':
            drawHydroHistoryChart(startDate, endDate);
            break;
        case 'rain':
            drawRainHistoryChart(startDate, endDate);
            break;
        case 'wind':
            drawWindHistoryChart(startDate, endDate);
            break;
    }
}

        function initEventListeners() {
            document.getElementById('filter-hydro').addEventListener('click', () => {
                const start = document.getElementById('start-time-hydro').value;
                const end = document.getElementById('end-time-hydro').value;
                handleTimeFilterWithDataCheck(start, end, 'hydro');
            });

            document.getElementById('filter-rain').addEventListener('click', () => {
                const start = document.getElementById('start-time-rain').value;
                const end = document.getElementById('end-time-rain').value;
                handleTimeFilterWithDataCheck(start, end, 'rain');
            });

            document.getElementById('filter-wind').addEventListener('click', () => {
                const start = document.getElementById('start-time-wind').value;
                const end = document.getElementById('end-time-wind').value;
                handleTimeFilterWithDataCheck(start, end, 'wind');
            });
            
            document.getElementById('station-selection-wind').addEventListener('change', () => drawWindHistoryChart());
            document.querySelectorAll('#station-selection-rain input').forEach(el => {
                el.addEventListener('change', () => drawRainHistoryChart());
            });

            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            
            // Theme event listeners
            document.getElementById('theme-toggle').addEventListener('change', (e) => {
                document.body.classList.toggle('light-mode', !e.target.checked);
            });
            
            document.getElementById('primary-color-picker').addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--primary-color', e.target.value);
            });
        }

async function initDashboard() {
    showLoading();
    loadSettings();

    try {
        // NUOVO: Carica solo 7 giorni inizialmente (molto più veloce!)
        const dataLoadPromise = updateHistoricalData(7, false);
        
        // Carica previsioni e allerte in parallelo
        await Promise.all([
            dataLoadPromise,
            fetchForecastData(),
            fetchForecastDataBettolelle3h(),
            fetchForecastDataPonteGaribaldi6h(),
            updateOfficialAlerts()
        ]);

        // Aggiorna dati real-time
        await updateAllLatestData();

        // Setup grafici con dati disponibili
        document.querySelectorAll('.quick-filter-btn.active').forEach(btn => btn.click());
        
        drawOverviewCharts();
        
        // Mostra toast informativo
        showToast('✅ Dashboard caricata! (dati ultimi 7 giorni)', 'success');
        
        // OPZIONALE: Suggerisci caricamento dati completi in background
        if (navigator.connection && navigator.connection.effectiveType === '4g') {
            setTimeout(() => {
                showToast('💡 Vuoi caricare lo storico completo? Usa i filtri "7 giorni" o superiori', 'info');
            }, 3000);
        }
        
    } catch (error) {
        console.error("Errore durante l'inizializzazione:", error);
        showToast('❌ Errore caricamento iniziale', 'error');
    } finally {
        hideLoading();
    }
}
        
        // ==================== AUTO REFRESH ====================
        /** * Verifica lo stato di salute del sistema di aggiornamento */ 
        function checkUpdateHealth() { 
            const now = Date.now(); 
            const stats = STATE.updateStats; 
            // Se l'ultimo aggiornamento riuscito è troppo vecchio 
            if (stats.lastSuccess) { 
                const timeSinceSuccess = now - stats.lastSuccess.getTime(); 
                const maxAge = CONFIG.intervals.dataUpdate * 3; // 3 cicli 
                if (timeSinceSuccess > maxAge) { 
                    console.error('🚨 ATTENZIONE: Nessun aggiornamento riuscito da più di 3 cicli!'); 
                    // Prova a riavviare i cicli 
                    console.log('🔄 Riavvio forzato dei cicli di aggiornamento...'); 
                    startAutoRefresh(); 
                } 
            } 
            // Log statistiche 
            console.log('📊 Health Check:', { 
                ultimoSuccesso: stats.lastSuccess, 
                ultimoErrore: stats.lastError, 
                erroriConsecutivi: stats.consecutiveErrors, 
                datiInAggiornamento: STATE.isUpdating.data, 
                previsioniInAggiornamento: STATE.isUpdating.forecast }); 
        }

        async function runDataUpdateLoop() {
            if (CONFIG.advanced.preventOverlap && STATE.isUpdating.data) {
                console.warn('⚠️ Aggiornamento dati già in corso, salto questo ciclo');
                STATE.updateIntervals.data = setTimeout(runDataUpdateLoop, CONFIG.intervals.dataUpdate);
                return;
            }
            
            STATE.isUpdating.data = true;
            const startTime = Date.now();
            
            try {
                console.log('🔄 Inizio ciclo aggiornamento completo...');
                
                // FASE 1: Aggiorna dati real-time
                await Promise.all([
                    executeWithRetry(() => updateAllLatestData(), 'aggiornamento dati sensori'),
                    executeWithRetry(() => updateOfficialAlerts(), 'aggiornamento allerte ufficiali'),
                    executeWithRetry(() => {
                        const radarPromises = [];
                        if (STATE.map) radarPromises.push(fetchRadarData(STATE.map));
                        if (STATE.dashboardMap) radarPromises.push(fetchRadarData(STATE.dashboardMap));
                        return Promise.all(radarPromises);
                    }, 'aggiornamento dati radar')
                ]);
                
                // FASE 2: Aggiorna dati storici (NUOVO!)
                await updateHistoricalData();
                
                // FASE 3: Rigenera grafici attivi (NUOVO!)
                regenerateActiveCharts();
                
                const duration = Date.now() - startTime;
                console.log(`✅ Ciclo aggiornamento completo terminato in ${duration}ms`);
                
                STATE.updateStats.lastSuccess = new Date();
                updateLastUpdate();
                
            } catch (error) {
                console.error('❌ Errore nel ciclo di aggiornamento dati:', error);
                showUpdateError('dati');
            } finally {
                STATE.isUpdating.data = false;
                
                let nextInterval = CONFIG.intervals.dataUpdate;
                if (STATE.updateStats.consecutiveErrors >= 3) {
                    nextInterval = Math.min(nextInterval * 2, 600000);
                    console.warn(`⚠️ Troppi errori consecutivi, intervallo aumentato a ${nextInterval/1000}s`);
                }
                
                STATE.updateIntervals.data = setTimeout(runDataUpdateLoop, nextInterval);
            }
        }

        async function runForecastUpdateLoop() {
            if (CONFIG.advanced.preventOverlap && STATE.isUpdating.forecast) {
                console.warn('⚠️ Aggiornamento previsioni già in corso, salto questo ciclo');
                STATE.updateIntervals.forecast = setTimeout(runForecastUpdateLoop, CONFIG.intervals.forecastUpdate);
                return;
            }
            STATE.isUpdating.forecast = true;
            const startTime = Date.now();
            try {
                console.log('🔄 Inizio aggiornamento previsioni...');
                const results = await Promise.allSettled([
                    executeWithRetry(() => fetchForecastData(), 'previsioni base'),
                    executeWithRetry(() => fetchForecastDataBettolelle3h(), 'previsioni Bettolelle 3h'),
                    executeWithRetry(() => fetchForecastDataPonteGaribaldi6h(), 'previsioni Ponte Garibaldi 6h')
                ]);
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const failed = results.filter(r => r.status === 'rejected').length;
                const duration = Date.now() - startTime;
                console.log(`✅ Aggiornamento previsioni completato in ${duration}ms (${successful} OK, ${failed} errori)`);
                if (successful > 0) {
                    STATE.updateStats.lastSuccess = new Date();
                }
                if (successful === 0) {
                    throw new Error('Tutte le chiamate di previsione sono fallite');
                }
            } catch (error) {
                console.error('❌ Errore nel ciclo di aggiornamento previsioni:', error);
                showUpdateError('previsioni');
            } finally {
                STATE.isUpdating.forecast = false;
                let nextInterval = CONFIG.intervals.forecastUpdate;
                if (STATE.updateStats.consecutiveErrors >= 3) {
                    nextInterval = Math.min(nextInterval * 2, 600000);
                    console.warn(`⚠️ Troppi errori consecutivi, intervallo previsioni aumentato a ${nextInterval/1000}s`);
                }
                STATE.updateIntervals.forecast = setTimeout(runForecastUpdateLoop, nextInterval);
            }
        }

        function startAutoRefresh() {
            // Interrompe i cicli precedenti se esistono
            if (STATE.updateIntervals.data) clearTimeout(STATE.updateIntervals.data);
            if (STATE.updateIntervals.forecast) clearTimeout(STATE.updateIntervals.forecast);

            // Avvia i nuovi cicli di aggiornamento
            runDataUpdateLoop();
            runForecastUpdateLoop();
        }

        function handleResize() {
            // Ridimensiona tutti i grafici
            Object.values(STATE.charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
            
            // Ridimensiona la mappa
            if (STATE.map) {
                STATE.map.invalidateSize();
            }
            if (STATE.dashboardMap) {
                STATE.dashboardMap.invalidateSize();
            }
        }

        // Aggiungi listener debounced per resize
        const debouncedHandleResize = utils.debounce(handleResize, UI_CONSTANTS.DEBOUNCE_DELAY);
        window.addEventListener('resize', debouncedHandleResize);

        // Aggiungi listener per cambio orientamento
        window.addEventListener('orientationchange', () => {
            setTimeout(handleResize, 300);
        });

        // ==================== START APPLICATION ====================
        // La logica della dashboard deve essere dentro una funzione come questa
        async function initializeDashboard() {
            // Qui dentro va il codice di avvio della tua app
            console.log('Accesso autorizzato. Avvio dashboard...');

            console.log('🚀 Inizializzazione Dashboard Meteo Pro...');
            
            feather.replace();

            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        console.log('Permesso notifiche concesso');
                    }
                });
            }

            initNavigation();
            initQuickFilters();
            initUIInteractions();
            initFullscreenButtons();
            initEventListeners();
            initDashboardMap();
            await initDashboard();
            startAutoRefresh();
            
            initTouchGestures();
            
            // Lazy Loading per Grafici
            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };

            const sectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !entry.target.dataset.loaded) {
                        const sectionId = entry.target.id;
                        entry.target.dataset.loaded = 'true';
                        
                        switch(sectionId) {
                            case 'idrometri':
                                if (!STATE.charts.hydroHistory) drawHydroHistoryChart();
                                break;
                            case 'pluviometri':
                                if (!STATE.charts.rainHistory) drawRainHistoryChart();
                                break;
                            case 'anemometri':
                                if (!STATE.charts.windHistory) drawWindHistoryChart();
                                break;
                        }
                    }
                });
            }, observerOptions);

            // Osserva tutte le sezioni
            document.querySelectorAll('.page-section').forEach(section => {
                sectionObserver.observe(section);
            });

            // Esegui health check ogni 2 minuti 
            setInterval(checkUpdateHealth, 120000);
        }

        function initTouchGestures() {
            if (!utils.isMobile()) return;
            
            const sidebar = document.getElementById('sidebar');
            let touchStartX = 0;
            let touchEndX = 0;
            
            sidebar.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            sidebar.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
            
            function handleSwipe() {
                const swipeDistance = touchStartX - touchEndX;
                
                // Swipe left to close (almeno 50px)
                if (swipeDistance > 50) {
                    sidebar.classList.remove('open');
                    const overlay = document.querySelector('.sidebar-overlay');
                    if (overlay) overlay.classList.remove('active');
                }
            }
        }

        window.addEventListener('resize', () => {
            if (!utils.isMobile()) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));

        /** * Dashboard di debug per monitorare gli aggiornamenti * Chiamala dalla console: window.showUpdateDebug() */ 
        window.showUpdateDebug = function() { 
            console.group('🔍 Debug Sistema Aggiornamento'); 
            console.log('Configurazione:', CONFIG.intervals); 
            console.log('Configurazione Avanzata:', CONFIG.advanced); 
            console.log('Stato Aggiornamenti:', STATE.isUpdating); 
            console.log('Statistiche:', STATE.updateStats); 
            console.log('Intervalli Attivi:', { 
                data: STATE.updateIntervals.data ? 'Attivo' : 'Non attivo', 
                forecast: STATE.updateIntervals.forecast ? 'Attivo' : 'Non attivo' 
            }); 
            console.groupEnd(); 
            // Mostra anche visivamente 
            alert(` 📊 STATO SISTEMA AGGIORNAMENTO Ultimo successo: ${STATE.updateStats.lastSuccess || 'Mai'} Errori consecutivi: ${STATE.updateStats.consecutiveErrors} Dati in aggiornamento: ${STATE.isUpdating.data ? 'SÌ' : 'NO'} Previsioni in aggiornamento: ${STATE.isUpdating.forecast ? 'SÌ' : 'NO'} Intervallo dati: ${CONFIG.intervals.dataUpdate/1000}s Intervallo previsioni: ${CONFIG.intervals.forecastUpdate/1000}s `); 
        };

        /**
         * Funzione di debug per monitorare lo stato degli aggiornamenti
         * Usa nella console: window.debugChartUpdates()
         */
        window.debugChartUpdates = function() {
            console.group('📊 Debug Aggiornamenti Grafici');
            console.log('Ultimo aggiornamento dati storici:', STATE.lastHistoricalUpdate);
            console.log('Grafici necessitano aggiornamento:', STATE.needsChartUpdate);
            console.log('Record storici regionali:', STATE.regionHistoryData.length);
            console.log('Record storici weatherlink:', STATE.weatherlinkHistoryData.length);
            console.log('Grafici attivi:', {
                hydroHistory: !!STATE.charts.hydroHistory,
                rainHistory: !!STATE.charts.rainHistory,
                windHistory: !!STATE.charts.windHistory,
                overviewHydro: !!STATE.charts.overviewHydro,
                overviewRain: !!STATE.charts.overviewRain
            });
            console.groupEnd();
        };
    </script>
</div>
</body>
</html>
